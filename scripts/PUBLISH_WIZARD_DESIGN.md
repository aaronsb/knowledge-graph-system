# Publish Wizard Design

## Overview

Interactive release wizard for `./publish.sh wizard` that guides through the full release process.

## Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    PUBLISH WIZARD                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Load saved config (if exists)                           │
│     → Offer "Use previous settings? [Y/n]"                  │
│                                                             │
│  2. Version Selection                                       │
│     Current: 0.6.6                                          │
│     ────────────────────────                                │
│     1) patch → 0.6.7                                        │
│     2) minor → 0.7.0                                        │
│     3) major → 1.0.0                                        │
│     Choice [1]:                                             │
│                                                             │
│  3. Release Message                                         │
│     ────────────────────────                                │
│     1) Enter message inline                                 │
│     2) Load from file                                       │
│     3) Open $EDITOR                                         │
│                                                             │
│  4. Artifact Selection (toggles, saved to config)           │
│     ────────────────────────                                │
│     [x] Images (api, web, operator) → 0.6.7                 │
│         Architecture: [x] amd64  [x] arm64                  │
│     [ ] CLI (@aaronsb/kg-cli) → 0.6.6 (already published)   │
│     [ ] FUSE (kg-fuse) → 0.1.2 (already published)          │
│                                                             │
│  5. Summary & Confirm                                       │
│     ════════════════════════════════════════════            │
│     Version:   0.6.6 → 0.6.7 (patch)                        │
│     Message:   "Graph CRUD, Job Management..." (523 chars)  │
│     Artifacts:                                              │
│       • Images: api, web, operator (amd64 + arm64)          │
│     Actions:                                                │
│       1. Bump VERSION file                                  │
│       2. Sync script versions                               │
│       3. Commit and tag v0.6.7                              │
│       4. Push to origin                                     │
│       5. Build images (multi-arch)                          │
│       6. Push to GHCR                                       │
│     ════════════════════════════════════════════            │
│     Proceed? [Y/n]                                          │
│                                                             │
│  6. Execution (with in-flight auth checks)                  │
│     ────────────────────────                                │
│     ✓ VERSION bumped to 0.6.7                               │
│     ✓ Scripts synced                                        │
│     ✓ Committed: Release v0.6.7                             │
│     ✓ Tagged: v0.6.7                                        │
│     ✓ Pushed to origin/main                                 │
│     → Building api (amd64)...                               │
│     → Building api (arm64)...                               │
│     ── Auth check: GHCR ──                                  │
│     ✓ GHCR authenticated                                    │
│     → Pushing api...                                        │
│     ✓ Pushed ghcr.io/.../kg-api:0.6.7                       │
│     ...                                                     │
│                                                             │
│  7. Save config (offer if changed)                          │
│     Save these choices for next time? [Y/n]                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Saved Config

Location: `~/.config/knowledge-graph/publish.conf`

```bash
# Publish Wizard Configuration
# Generated by publish.sh 0.6.7

# Default selections
DEFAULT_BUMP_TYPE="patch"
PUBLISH_IMAGES=true
PUBLISH_CLI=false
PUBLISH_FUSE=false
MULTI_ARCH=true

# Message template (optional)
MESSAGE_TEMPLATE_FILE=""
```

## Script Structure (install.sh pattern)

```bash
#!/bin/bash
# ============================================================================
# publish.sh - Unified publishing and versioning tool
# ============================================================================
PUBLISH_VERSION="0.6.7"
# ============================================================================
#
# ARCHITECTURE OVERVIEW:
# ----------------------
#   1. CONFIGURATION    - All options as variables
#   2. UTILITIES        - Colors, logging, prompts
#   3. VERSION HELPERS  - Reading, bumping, updating versions
#   4. AUTH HELPERS     - GHCR, npm, PyPI authentication
#   5. BUILD HELPERS    - Docker, npm, PyPI builds
#   6. COMMANDS         - status, bump, release, images, cli, fuse, wizard
#   7. WIZARD           - Interactive flow
#   8. MAIN             - Argument parsing and dispatch
#
# ============================================================================

# ============================================================================
# SECTION 1: CONFIGURATION
# ============================================================================

# --- Defaults ---
DEFAULT_BUMP_TYPE="patch"
PUBLISH_IMAGES=true
PUBLISH_CLI=false
PUBLISH_FUSE=false
MULTI_ARCH=false

# --- Config File ---
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/knowledge-graph"
CONFIG_FILE="$CONFIG_DIR/publish.conf"

# --- Runtime State ---
VERSION=""
NEW_VERSION=""
DESCRIPTION=""
DRY_RUN=false
...
```

## In-Flight Auth Checks

After each build phase, before push:

```bash
verify_auth_before_push() {
    local target="$1"  # ghcr, npm, pypi

    case "$target" in
        ghcr)
            if ! check_ghcr_auth; then
                echo -e "${YELLOW}⚠ GHCR auth expired${NC}"
                echo "Please re-authenticate:"
                echo "  docker login ghcr.io"
                read -p "Press Enter when ready..." </dev/tty
                if ! check_ghcr_auth; then
                    echo -e "${RED}Still not authenticated. Aborting.${NC}"
                    return 1
                fi
            fi
            ;;
        npm)
            if ! check_npm_auth; then
                echo -e "${YELLOW}⚠ npm auth expired${NC}"
                echo "Please re-authenticate:"
                echo "  npm login"
                read -p "Press Enter when ready..." </dev/tty
                ...
            fi
            ;;
        ...
    esac
    echo -e "${GREEN}✓ $target authenticated${NC}"
}
```

## Prompt Helpers (from install.sh)

```bash
prompt_select()      # Select from numbered list
prompt_bool()        # Yes/no with default
prompt_value()       # Text input with default
prompt_toggle()      # NEW: Multi-select checkboxes
```

## Toggle UI

```bash
prompt_toggle() {
    # Multi-select with space to toggle, enter to confirm
    # Usage: prompt_toggle "Select artifacts" "Images|true" "CLI|false" "FUSE|false"

    # Display:
    #   Select artifacts (space to toggle, enter to confirm):
    #   > [x] Images
    #     [ ] CLI
    #     [ ] FUSE
}
```

## Error Handling

- Auth failures: Prompt to re-auth, retry
- Build failures: Show error, offer to retry or skip
- Push failures: Show error, offer to retry
- Network issues: Detect and suggest retry

## CLI Compatibility

Wizard is additive - all existing commands work:

```bash
./publish.sh status              # Still works
./publish.sh release patch -m x  # Still works
./publish.sh images              # Still works
./publish.sh wizard              # NEW: Interactive flow
```
