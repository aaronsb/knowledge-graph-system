# Knowledge Graph System - Claude Development Guide

## Project Overview

A multi-dimensional knowledge extraction system that transforms documents into interconnected concept graphs using Apache AGE (PostgreSQL graph extension).

**Fully Containerized** - no local Python installation required.

```
┌─────────────────────────────────────────────────────────────┐
│                     Docker Containers                       │
├─────────────────────────────────────────────────────────────┤
│  Documents → [API Container] → LLM Extraction → [Postgres]  │
│                      ↓                               ↓      │
│              [Garage S3 Storage]         [Apache AGE Graph] │
│                      ↓                               ↓      │
│               [Web Container] ← REST API ← [API Container]  │
│                                                             │
│  Configuration: [Operator Container] → [Postgres Config]    │
└─────────────────────────────────────────────────────────────┘
                            ↑
                   kg CLI (optional)
                   MCP Server (optional)
```

**Tech Stack:**
- Python 3.11+ FastAPI (REST API server)
- Apache AGE / PostgreSQL 16 (graph database, openCypher)
- TypeScript/Node.js (CLI + MCP)
- React/Next.js (web visualization)
- Garage (S3-compatible storage)
- Docker Compose (orchestration)

## Quick Start

```bash
# First-time setup (generates secrets, starts containers, prompts for config)
./operator.sh init

# Daily start
./operator.sh start

# Install kg CLI (optional but recommended)
cd cli && npm run build && ./install.sh

# Verify
kg health
```

## Contextual Documentation

This project uses **ways** for contextual guidance. When you work with specific areas, relevant documentation loads automatically:

| Area | Trigger | What You Get |
|------|---------|--------------|
| CLI/MCP | `kg `, `cli/src` | Source locations, build commands |
| Operator | `operator.sh`, docker | Container names, common commands |
| API | `api/api/`, routes | Structure, query safety patterns |
| Web | `web/src/`, Zustand | Store patterns, component structure |
| Schema | `schema/`, migrations | Migration patterns, Cypher notes |
| ADR | `ADR-\d` | Key ADRs, index location |

Ways are in `.claude/ways/kg/`.

## Key Concepts

### Concept Extraction Flow

1. Submit document → POST `/ingest`
2. Job created with cost estimate → Requires approval
3. Chunk into ~1000 word segments
4. Extract concepts via LLM (GPT-4/Claude)
5. Match against existing concepts (vector similarity)
6. Upsert to Apache AGE with relationships

### Graph Data Model

```cypher
(:Concept)-[:APPEARS_IN]->(:Source)
(:Concept)-[:EVIDENCED_BY]->(:Instance)
(:Instance)-[:FROM_SOURCE]->(:Source)
(:Concept)-[:IMPLIES|SUPPORTS|CONTRADICTS]->(:Concept)
```

### AI Providers

- **OpenAI** - GPT-4o, GPT-4o-mini
- **Anthropic** - Claude Sonnet 4, Claude 3.5 Sonnet
- **Ollama** - Local inference (Mistral, Llama, Qwen)

Configure via: `./operator.sh shell` then `configure.py ai-provider`

## Release Process

```bash
# 1. Update VERSION file
echo "0.5.0" > VERSION
git add VERSION && git commit -m "chore: bump version"
git push origin main

# 2. Merge to release branch (triggers build)
git checkout release && git merge main && git push
```

Images publish to `ghcr.io/aaronsb/knowledge-graph-system/kg-{api,web,operator}`.

## Security Notes

**Infrastructure Secrets (`.env`)** - Generated by `./operator.sh init`, never edit manually:
- `ENCRYPTION_KEY` - Fernet key for API key encryption
- `OAUTH_SIGNING_KEY` - JWT signing
- `POSTGRES_PASSWORD` - Database password
- `INTERNAL_KEY_SERVICE_SECRET` - Service auth token

**Application Config** - Stored encrypted in PostgreSQL:
- OpenAI/Anthropic API keys
- Admin passwords

## Resources

- Apache AGE: https://age.apache.org/
- openCypher: https://opencypher.org/
- FastAPI: https://fastapi.tiangolo.com/
- MCP Protocol: https://spec.modelcontextprotocol.io/
- ADR Index: `docs/architecture/ARCHITECTURE_DECISIONS.md`
