name: Lint

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  query-safety:
    name: Query Safety Linter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run query safety linter
        run: |
          python3 scripts/development/diagnostics/lint_queries.py src/api || true

      - name: Report baseline technical debt
        run: |
          echo "ℹ️  Query safety baseline: 3 known unsafe queries"
          echo "   - database.py:195 (health check)"
          echo "   - restore_worker.py:230-233 (restore operations)"
          echo "   These will be fixed in Phase 2 (Critical Path Migration)"
          echo "   See: docs/architecture/QUERY_SAFETY_BASELINE.md"

  python-syntax:
    name: Python Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          python3 -m py_compile $(find src/api scripts -name "*.py")

  # TODO: Add full test infrastructure in future
  # pytest-unit:
  #   name: Unit Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #     - Requires: PostgreSQL + Apache AGE
  #     - Requires: Test database setup/teardown
  #     - Requires: Mock fixtures
  #   Deferred until test infrastructure is set up

  typescript-build:
    name: TypeScript Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: client

      - name: Build TypeScript client
        run: npm run build
        working-directory: client

      - name: Check for build artifacts
        run: |
          if [ ! -f "client/dist/index.js" ]; then
            echo "❌ Build failed - client/dist/index.js not found"
            exit 1
          fi
          echo "✅ TypeScript client built successfully"
