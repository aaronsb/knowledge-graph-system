# Knowledge Graph Operator

The operator is the **configuration plane** for the Knowledge Graph System. It provides platform lifecycle management from the host and detailed configuration from within the operator container.

## Quick Start

```bash
# First-time setup (generates secrets, detects GPU, starts everything)
./operator.sh init

# Daily operations
./operator.sh start              # Start platform
./operator.sh stop               # Stop platform
./operator.sh status             # Check status
./operator.sh shell              # Enter configuration shell
```

## Directory Structure

```
operator/
├── lib/                    # Shell scripts for lifecycle management
│   ├── common.sh           # Shared functions (run_compose, load_config)
│   ├── guided-init.sh      # First-time setup wizard
│   ├── start-infra.sh      # Start postgres, garage, operator
│   ├── start-app.sh        # Start api, web
│   ├── stop.sh             # Stop containers
│   ├── teardown.sh         # Remove containers/volumes
│   └── operator-help.sh    # In-shell help system
├── database/               # Database operations
│   ├── migrate-db.sh       # Apply schema migrations
│   ├── backup-database.sh  # Create database backup
│   └── restore-database.sh # Restore from backup
├── admin/                  # Administration scripts
│   ├── manage_api_keys.py  # API key management
│   └── calculate_concept_grounding.py
├── configure.py            # Main configuration CLI
├── Dockerfile              # Operator container image
└── README.md               # This file
```

## Two-Layer Architecture

### Layer 1: Host (operator.sh)

Run on your host machine for **lifecycle management**:

```bash
./operator.sh init               # Guided first-time setup
./operator.sh start              # Start platform (uses saved config)
./operator.sh stop               # Stop all containers
./operator.sh stop --keep-infra  # Stop app only, keep database
./operator.sh restart <service>  # Restart specific service
./operator.sh rebuild <service>  # Rebuild and restart (api, web, operator)
./operator.sh status             # Show config and container status
./operator.sh config --dev true  # Update configuration
./operator.sh logs [service]     # Tail logs
./operator.sh shell              # Enter operator container
./operator.sh teardown           # Remove containers
./operator.sh help [topic]       # Show help (lifecycle, services, config)
```

### Layer 2: Operator Shell (inside container)

Enter with `./operator.sh shell` for **platform configuration**:

```bash
# Quick commands (aliases)
status                   # View platform configuration
pg                       # Connect to database (credentials auto-loaded)
configure                # Run configure.py

# Configuration commands
configure.py admin                           # Create/update admin user
configure.py ai-provider openai --model gpt-4o  # Set extraction provider
configure.py embedding                       # List embedding profiles
configure.py embedding 2                     # Activate profile ID 2
configure.py api-key openai                  # Store API key (encrypted)
configure.py status                          # Show all configuration

# Help system
operator-help                    # Overview
operator-help admin              # Admin user management
operator-help embedding          # Embedding configuration
operator-help extraction         # AI extraction provider
operator-help api-keys           # API key management
operator-help diagnostics        # Diagnostic tools
operator-help database           # Database operations
operator-help all                # Show everything
```

## Configuration Files

| File | Purpose | Location |
|------|---------|----------|
| `.env` | Infrastructure secrets (generated by init) | Project root |
| `.operator.conf` | Platform settings (dev mode, GPU mode) | Project root |
| Database | Application config (providers, API keys) | PostgreSQL |

## Typical Workflows

### First-Time Setup

```bash
./operator.sh init
# Guided wizard:
# 1. Generates .env with secrets
# 2. Detects GPU (nvidia/mac/cpu)
# 3. Asks for dev mode preference
# 4. Starts all containers
# 5. Prompts for admin password
# 6. Prompts for AI provider API keys
```

### Daily Development

```bash
./operator.sh start              # Start with saved config
# ... work ...
./operator.sh stop               # End of day
```

### Change AI Provider

```bash
./operator.sh shell
configure.py ai-provider anthropic --model claude-sonnet-4-20250514
configure.py api-key anthropic
exit
./operator.sh restart api
```

### Database Operations

```bash
./operator.sh shell
pg                               # Connect to database
pg -c "SELECT count(*) FROM ..."  # Run query
/workspace/operator/database/backup-database.sh
exit
```

### Complete Reset

```bash
./operator.sh teardown --full    # Remove everything
./operator.sh init               # Start fresh
```

## Security Model

**Two tiers of secrets:**

1. **Infrastructure secrets** (`.env` file):
   - `ENCRYPTION_KEY` - Master key for encrypting application secrets
   - `POSTGRES_PASSWORD` - Database password
   - `OAUTH_SIGNING_KEY` - JWT signing key
   - `GARAGE_RPC_SECRET` - Object storage cluster secret
   - Generated once, loaded into containers via docker-compose

2. **Application secrets** (encrypted in PostgreSQL):
   - OpenAI/Anthropic API keys
   - Stored via `configure.py api-key`
   - Encrypted using `ENCRYPTION_KEY`

The operator container has access to both tiers - it's the trusted configuration plane.

## Diagnostic Tools

Available inside operator shell (`./operator.sh shell`):

```bash
# Database
/workspace/scripts/development/diagnostics/monitor-db.sh
/workspace/scripts/development/diagnostics/list-tables.sh
/workspace/scripts/development/diagnostics/explain-query.sh

# Garage S3 storage
/workspace/scripts/development/diagnostics/garage-status.sh
/workspace/scripts/development/diagnostics/garage-keys.sh
/workspace/scripts/development/diagnostics/garage-list-images.sh

# Code quality
python /workspace/scripts/development/diagnostics/lint_queries.py
```

## Extending the Operator

### Adding New Configuration Commands

Edit `operator/configure.py`:
1. Add handler method to `OperatorConfig` class
2. Add argparse subparser in `main()`
3. Update `operator-help.sh` with documentation

### Adding New Lifecycle Commands

Edit `operator.sh`:
1. Add `cmd_<name>()` function
2. Add case in main dispatch
3. Update `show_help_*` functions

---

**Last Updated:** 2025-12-12
