
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Multi-dimensional knowledge extraction system using Apache AGE">
      
      
        <meta name="author" content="Knowledge Graph System Contributors">
      
      
      
        <link rel="prev" href="../ADR-049-rate-limiting-and-concurrency/">
      
      
        <link rel="next" href="../ADR-051-API-CHANGES/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>ADR-050: Scheduled Jobs System - Knowledge Graph System</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adr-050-scheduled-jobs-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Knowledge Graph System" class="md-header__button md-logo" aria-label="Knowledge Graph System" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Knowledge Graph System
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ADR-050: Scheduled Jobs System
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/aaronsb/knowledge-graph-system" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    aaronsb/knowledge-graph-system
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Knowledge Graph System" class="md-nav__button md-logo" aria-label="Knowledge Graph System" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Knowledge Graph System
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aaronsb/knowledge-graph-system" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    aaronsb/knowledge-graph-system
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation Index
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/COLD-START/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5-Minute Cold Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/DEPLOYMENT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/VOCABULARY_CATEGORIES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vocabulary Categories
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System Manual
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/00-introduction/01-WHAT_AND_WHY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is the Knowledge Graph System?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/01-getting-started/01-QUICKSTART/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/01-getting-started/02-CLI_USAGE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg CLI Usage Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/01-getting-started/03-INGESTION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Ingestion Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/01-AI_PROVIDERS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Provider Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/02-EXTRACTION_CONFIGURATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Extraction Configuration Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/03-EMBEDDING_CONFIGURATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Embedding Configuration Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/04-SWITCHING_EXTRACTION_PROVIDERS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Switching Extraction Providers - Quick Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/05-LOCAL_INFERENCE_IMPLEMENTATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Local LLM Inference Implementation Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/06-EXTRACTION_QUALITY_COMPARISON/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Extraction Quality Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Integration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Integration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/03-integration/01-MCP_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP Server Setup Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/03-integration/02-VOCABULARY_CONSOLIDATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Edge Vocabulary Consolidation Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Security & Access
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Security & Access
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/01-AUTHENTICATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/02-RBAC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RBAC Operations Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/03-SECURITY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/04-PASSWORD_RECOVERY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Password Recovery and Account Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Maintenance
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            Maintenance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/05-maintenance/01-BACKUP_RESTORE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backup and Restore Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/05-maintenance/02-DATABASE_MIGRATIONS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Migrations Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/01-SCHEMA_REFERENCE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PostgreSQL Schema Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/02-USE_CASES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Use Cases: Practical Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/03-EXAMPLES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples: Real Queries, Real Results
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/04-github_project_history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Project History Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/05-CONCEPTS_AND_TERMINOLOGY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concepts and Terminology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/06-CONCEPT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concept: Why Knowledge Graphs, Not Just RAG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/07-ENRICHMENT_JOURNEY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Enrichment Journey: From Empty Graph to Multi-Perspective Understanding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/08-DISTRIBUTED_SHARDING_RESEARCH/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Graph Database Sharding: Research and Architectural Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/09-CYPHER_PATTERNS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Cypher Query Patterns for Apache AGE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/10-OPENCYPHER_QUERIES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    openCypher Query Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/11-LLM_EDGE_DISCOVERY_FLOW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Edge Discovery Flow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tool Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tool Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool &amp; API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CLI Commands
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            CLI Commands
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Command Reference (Auto-Generated)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    commands
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            commands
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/admin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg admin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/ingest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg ingest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/ontology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg ontology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/vocabulary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg vocabulary
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
        
          
          <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    media
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_3">
            <span class="md-nav__icon md-icon"></span>
            media
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/media/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Media Assets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    MCP Tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            MCP Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP Server Tool Reference (Auto-Generated)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_2" >
        
          
          <label class="md-nav__link" for="__nav_4_3_2" id="__nav_4_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    media
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_2">
            <span class="md-nav__icon md-icon"></span>
            media
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/media/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Media Assets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3_3" id="__nav_4_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_3">
            <span class="md-nav__icon md-icon"></span>
            tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/approve_job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    approve_job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/cancel_job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cancel_job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/delete_ontology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    delete_ontology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/find_connection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    find_connection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/find_connection_by_search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    find_connection_by_search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/find_related_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    find_related_concepts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_api_health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_api_health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_concept_details/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_concept_details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_database_health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_database_health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_database_info/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_database_info
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_database_stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_database_stats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_job_status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_job_status
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_ontology_files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_ontology_files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_ontology_info/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_ontology_info
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_system_status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_system_status
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/ingest_text/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ingest_text
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/list_jobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    list_jobs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/list_ontologies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    list_ontologies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/search_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    search_concepts
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    REST API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            REST API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    REST API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-001-multi-tier-agent-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-001: Multi-Tier Agent Access Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-002-node-fitness-scoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-002: Node Fitness Scoring System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-003-semantic-tool-hints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-003: Semantic Tool Hint Networks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-004-pure-graph-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-004: Pure Graph Design (Library Metaphor)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-005-source-text-tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-005: Source Text Tracking and Retrieval
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-006-staging-migration-workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-006: Staging and Migration Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-011-cli-admin-separation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-011: CLI and Admin Tooling Separation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-012-api-server-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-012: API Server Architecture for Scalable Neo4j Access
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-013-unified-typescript-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-013: Unified TypeScript Client (CLI + MCP Server)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-014-job-approval-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-014: Job Approval Workflow with Pre-Ingestion Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-015-backup-restore-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-015: Backup/Restore Streaming Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-016-apache-age-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-016: Apache AGE Migration (Neo4j Replacement)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-017-sensitive-auth-verification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Decision Record: Client-Initiated Token Revocation for Elevated Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-018-server-sent-events-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-018: Server-Sent Events for Real-Time Progress Streaming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-019-type-based-table-formatting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-019: Type-Based Table Formatting System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-020-admin-module-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-020: Admin Module Architecture Pattern
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-021-live-man-switch-ai-safety/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-021: Live Man Switch - AI Safety for Critical Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-022-semantic-relationship-taxonomy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-022: Semantically Sparse 30-Type Relationship Taxonomy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-023-markdown-structured-content-preprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-023: Markdown Structured Content Preprocessing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-024-multi-schema-postgresql-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-024: Multi-Schema PostgreSQL Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-025-dynamic-relationship-vocabulary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-025: Dynamic Relationship Vocabulary Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-026-autonomous-vocabulary-curation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-026: Autonomous Vocabulary Curation and Ontology Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-027-user-management-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-027: User Management API with Lightweight JWT Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-028-dynamic-rbac-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-028: Dynamic Role-Based Access Control (RBAC) System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-029-cli-theory-of-operation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-029: CLI Theory of Operation - Hybrid Unix/Domain-Specific Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-030-concept-deduplication-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-030: Concept Deduplication Quality Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-031-encrypted-api-key-storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-031: Encrypted API Key Storage with Container Secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-032-IMPLEMENTATION-NOTES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-032 Implementation Quick Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-032-automatic-edge-vocabulary-expansion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-032: Automatic Edge Vocabulary Expansion with Intelligent Pruning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-033-multimodal-ingestion-configurable-prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-033: Multimodal Image Ingestion with Configurable Prompt System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-034-graph-visualization-query-workbench/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-034: Graph Visualization &amp; Interactive Query Explorers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-035-explorer-methods-uses-capabilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-035: Explorer Methods, Uses, and Capabilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-036-universal-visual-query-builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-036: Universal Visual Query Builder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-037-human-guided-graph-editing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-037: Human-Guided Graph Editing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-038-official-project-apparel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-038: Official Project Apparel Design Specifications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-039-local-embedding-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-039: Local Embedding Service with Hybrid Client/Server Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-040-database-schema-migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-040: Database Schema Migration Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-041-ai-extraction-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-041: AI Extraction Provider Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-042-local-extraction-inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-042: Local LLM Inference for Concept Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-043-single-node-resource-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-043: Single-Node Resource Management for Local Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-044-probabilistic-truth-convergence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-044: Probabilistic Truth Convergence Through Contradiction Resolution
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-045-046-MIGRATION-PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migration Plan: ADR-045/046 Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-045-unified-embedding-generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-045: Unified Embedding Generation System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-046-grounding-aware-vocabulary-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-046: Grounding-Aware Vocabulary Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-047-probabilistic-vocabulary-categorization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-047: Probabilistic Vocabulary Categorization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-048-vocabulary-metadata-as-graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-048: Vocabulary Metadata as First-Class Graph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-049-llm-determined-relationship-direction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-049: LLM-Determined Relationship Direction Semantics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-049-rate-limiting-and-concurrency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-049: Rate Limiting and Per-Provider Concurrency Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    ADR-050: Scheduled Jobs System
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    ADR-050: Scheduled Jobs System
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Decision">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taxonomy-tasks-jobs-and-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Taxonomy: Tasks, Jobs, and Workers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Taxonomy: Tasks, Jobs, and Workers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-types-scheduled" class="md-nav__link">
    <span class="md-ellipsis">
      Task Types (Scheduled)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#job-types-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Job Types (Workers)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interface-contract" class="md-nav__link">
    <span class="md-ellipsis">
      Interface Contract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generic-launcher-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Generic Launcher Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schedule-types-polling-vs-direct-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Schedule Types: Polling vs Direct Execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-clarification-code-vs-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Clarification: Code vs Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#management-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Management APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Management APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-adminscheduled-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      GET /admin/scheduled-jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-adminscheduled-jobsname" class="md-nav__link">
    <span class="md-ellipsis">
      GET /admin/scheduled-jobs/{name}
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-adminscheduled-jobsnameenable" class="md-nav__link">
    <span class="md-ellipsis">
      POST /admin/scheduled-jobs/{name}/enable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-adminscheduled-jobsnamedisable" class="md-nav__link">
    <span class="md-ellipsis">
      POST /admin/scheduled-jobs/{name}/disable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-adminscheduled-jobsnametrigger" class="md-nav__link">
    <span class="md-ellipsis">
      POST /admin/scheduled-jobs/{name}/trigger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch-adminscheduled-jobsname" class="md-nav__link">
    <span class="md-ellipsis">
      PATCH /admin/scheduled-jobs/{name}
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-adminscheduled-jobsnamehistory" class="md-nav__link">
    <span class="md-ellipsis">
      GET /admin/scheduled-jobs/{name}/history
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-commands" class="md-nav__link">
    <span class="md-ellipsis">
      CLI Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#job-ownership-and-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      Job Ownership and Permissions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Job Ownership and Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-enhancement" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Enhancement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permission-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Permission Rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-taxonomy-restructure" class="md-nav__link">
    <span class="md-ellipsis">
      CLI Taxonomy Restructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-permission-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      API Permission Enforcement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduled-job-creation-system-ownership" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduled Job Creation (System Ownership)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    <span class="md-ellipsis">
      Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-schedule-configuration-table" class="md-nav__link">
    <span class="md-ellipsis">
      1. Schedule Configuration Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-simple-scheduler-loop" class="md-nav__link">
    <span class="md-ellipsis">
      2. Simple Scheduler Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-job-launcher-base-class" class="md-nav__link">
    <span class="md-ellipsis">
      3. Job Launcher Base Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-example-launchers" class="md-nav__link">
    <span class="md-ellipsis">
      4. Example Launchers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-fastapi-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. FastAPI Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Deployment Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-worker-safety-critical" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Worker Safety (Critical)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinguishing-skip-from-failure-critical" class="md-nav__link">
    <span class="md-ellipsis">
      Distinguishing Skip from Failure (Critical)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring Requirements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consequences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#positive" class="md-nav__link">
    <span class="md-ellipsis">
      Positive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative" class="md-nav__link">
    <span class="md-ellipsis">
      Negative
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alternatives Considered">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-a-apscheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Option A: APScheduler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-b-system-cron" class="md-nav__link">
    <span class="md-ellipsis">
      Option B: System Cron
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-foundation-week-1" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Foundation (Week 1)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-first-launcher-week-2" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: First Launcher (Week 2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-second-launcher-week-3" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Second Launcher (Week 3)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-monitoring-api-week-4" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Monitoring &amp; API (Week 4)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-worker-testing-critical" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Worker Testing (Critical)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Future Enhancements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-2-advanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Advanced Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-distributed-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Distributed Execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-machine-learning" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Machine Learning
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-051-API-CHANGES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-051: API Changes for Graph-Based Document Deduplication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-051-graph-document-deduplication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-051: Graph-Based Provenance Tracking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-052-vocabulary-expansion-consolidation-cycle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-052: Vocabulary Expansion-Consolidation Cycle (The "Dreaming" Pattern)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-053-eager-vocabulary-categorization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-053: Eager Vocabulary Categorization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE_DECISIONS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Decision Records (ADRs)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE_OVERVIEW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CLI_AUTHENTICATION_ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Authentication Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CODE-CHANGES-ANALYSIS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Changes Analysis: ADR-045/046 Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DATA_CONTRACT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Contract Pattern: Schema Governance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FUZZY_MATCHING_ANALYSIS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fuzzy Matching Analysis for 30-Type Relationship Taxonomy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PHASE_3_3_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-048 Phase 3.3 Implementation Plan
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PHASE_3_IMPLEMENTATION_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phase 3 Implementation Plan: Vocabulary as Graph Nodes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../QUERY_SAFETY_BASELINE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Query Safety Baseline - Technical Debt
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../RECURSIVE_UPSERT_ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System - Recursive Upsert Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visualization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/AUTO-DOCUMENTATION-STRATEGY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auto-Documentation Strategy for CLI Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/DEV_JOURNAL_chunked_ingestion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development Journal: Chunked Ingestion System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/LEARNED_KNOWLEDGE_MCP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learned Knowledge Synthesis - MCP Enhancement Plan
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/pattern-repetition-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Repetition in Growth Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/relationship-semantics-comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Relationship Semantics: How Others Do It vs. Our Proposal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vocabulary-direction-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vocabulary Direction Semantics Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/INTEGRATION_TEST_NOTES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integration Test Notes - Working Commands &amp; Observations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/INTEGRATION_TEST_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System - Integration Test Plan
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/SCHEMA_MIGRATION_TEST_REPORT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PostgreSQL Schema Migration - Functional Test Report
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/TEST_COVERAGE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Test Coverage Areas
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Decision">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taxonomy-tasks-jobs-and-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Taxonomy: Tasks, Jobs, and Workers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Taxonomy: Tasks, Jobs, and Workers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-types-scheduled" class="md-nav__link">
    <span class="md-ellipsis">
      Task Types (Scheduled)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#job-types-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Job Types (Workers)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interface-contract" class="md-nav__link">
    <span class="md-ellipsis">
      Interface Contract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generic-launcher-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Generic Launcher Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schedule-types-polling-vs-direct-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Schedule Types: Polling vs Direct Execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-clarification-code-vs-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Clarification: Code vs Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#management-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Management APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Management APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-adminscheduled-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      GET /admin/scheduled-jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-adminscheduled-jobsname" class="md-nav__link">
    <span class="md-ellipsis">
      GET /admin/scheduled-jobs/{name}
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-adminscheduled-jobsnameenable" class="md-nav__link">
    <span class="md-ellipsis">
      POST /admin/scheduled-jobs/{name}/enable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-adminscheduled-jobsnamedisable" class="md-nav__link">
    <span class="md-ellipsis">
      POST /admin/scheduled-jobs/{name}/disable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-adminscheduled-jobsnametrigger" class="md-nav__link">
    <span class="md-ellipsis">
      POST /admin/scheduled-jobs/{name}/trigger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch-adminscheduled-jobsname" class="md-nav__link">
    <span class="md-ellipsis">
      PATCH /admin/scheduled-jobs/{name}
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-adminscheduled-jobsnamehistory" class="md-nav__link">
    <span class="md-ellipsis">
      GET /admin/scheduled-jobs/{name}/history
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-commands" class="md-nav__link">
    <span class="md-ellipsis">
      CLI Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#job-ownership-and-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      Job Ownership and Permissions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Job Ownership and Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-enhancement" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Enhancement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permission-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Permission Rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli-taxonomy-restructure" class="md-nav__link">
    <span class="md-ellipsis">
      CLI Taxonomy Restructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-permission-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      API Permission Enforcement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduled-job-creation-system-ownership" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduled Job Creation (System Ownership)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    <span class="md-ellipsis">
      Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-schedule-configuration-table" class="md-nav__link">
    <span class="md-ellipsis">
      1. Schedule Configuration Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-simple-scheduler-loop" class="md-nav__link">
    <span class="md-ellipsis">
      2. Simple Scheduler Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-job-launcher-base-class" class="md-nav__link">
    <span class="md-ellipsis">
      3. Job Launcher Base Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-example-launchers" class="md-nav__link">
    <span class="md-ellipsis">
      4. Example Launchers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-fastapi-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. FastAPI Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Deployment Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-worker-safety-critical" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Worker Safety (Critical)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinguishing-skip-from-failure-critical" class="md-nav__link">
    <span class="md-ellipsis">
      Distinguishing Skip from Failure (Critical)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring Requirements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consequences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#positive" class="md-nav__link">
    <span class="md-ellipsis">
      Positive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative" class="md-nav__link">
    <span class="md-ellipsis">
      Negative
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alternatives Considered">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-a-apscheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Option A: APScheduler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-b-system-cron" class="md-nav__link">
    <span class="md-ellipsis">
      Option B: System Cron
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-foundation-week-1" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Foundation (Week 1)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-first-launcher-week-2" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: First Launcher (Week 2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-second-launcher-week-3" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Second Launcher (Week 3)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-monitoring-api-week-4" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Monitoring &amp; API (Week 4)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-worker-testing-critical" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Worker Testing (Critical)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Future Enhancements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-2-advanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Advanced Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-distributed-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Distributed Execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-machine-learning" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Machine Learning
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="adr-050-scheduled-jobs-system">ADR-050: Scheduled Jobs System</h1>
<p><strong>Status:</strong> Proposed
<strong>Date:</strong> 2025-10-28
<strong>Deciders:</strong> Development Team
<strong>Related:</strong> ADR-012 (API Server Architecture), ADR-014 (Job Approval Workflow), ADR-049 (Rate Limiting)</p>
<h2 id="context">Context</h2>
<p>The system needs automated maintenance tasks that run on schedules:</p>
<p><strong>Immediate Needs:</strong>
1. <strong>Category Refresh</strong>: Automatically re-integrate LLM-generated vocabulary categories that haven't been merged
2. <strong>Vocabulary Consolidation</strong>: Auto-consolidate vocabulary based on hysteresis curves to maintain optimal spread</p>
<p><strong>Current System:</strong></p>
<p>We have a proven, battle-tested job queue system (<code>job_queue.py</code>) that handles:
- ✅ Job submission via <code>enqueue(job_type, job_data)</code>
- ✅ Worker registry and execution
- ✅ Progress tracking for SSE streaming
- ✅ Checkpoint/resume from failure
- ✅ Serial/parallel execution modes
- ✅ Approval workflow (ADR-014)
- ✅ Content deduplication
- ✅ Works reliably in production</p>
<p><strong>What's Missing:</strong></p>
<p>Just one thing: <strong>timing</strong> (when to trigger jobs automatically).</p>
<p>Currently, all jobs are triggered manually via:
- CLI: <code>kg ingest file ...</code>, <code>kg vocab consolidate ...</code>
- API: <code>POST /ingest</code>, <code>POST /admin/...</code></p>
<p><strong>Problem Statement:</strong></p>
<p>We need scheduled execution of jobs, but:
- ❌ Don't want external dependencies (APScheduler, Celery, Redis)
- ❌ Don't want to replace working infrastructure
- ❌ Don't want complex migration paths
- ✅ Want to extend what we have consistently</p>
<h2 id="decision">Decision</h2>
<p><strong>Add a simple scheduling layer on top of the existing job queue.</strong></p>
<p>No external dependencies. No major refactoring. Just extend our system.</p>
<h3 id="architecture">Architecture</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>│                     FastAPI Application                      │
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>├─────────────────────────────────────────────────────────────┤
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│                                                               │
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│  ┌────────────────────────────────────────────────────────┐ │
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>│  │          Scheduler (NEW - Simple Background Task)       │ │
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│  ├────────────────────────────────────────────────────────┤ │
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>│  │  Config: kg_api.scheduled_jobs (cron schedules)        │ │
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│  │  Loop: asyncio.create_task() checks every 60s          │ │
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>│  │  Logic: If schedule fires → call launcher              │ │
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>│  └────────────────────────────────────────────────────────┘ │
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>│                          │                                    │
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>│                          ↓ (schedule fires)                   │
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>│  ┌────────────────────────────────────────────────────────┐ │
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>│  │              Job Launchers (NEW)                        │ │
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>│  ├────────────────────────────────────────────────────────┤ │
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>│  │  • CategoryRefreshLauncher                             │ │
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>│  │  • VocabConsolidationLauncher                          │ │
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>│  │                                                          │ │
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>│  │  Each launcher:                                         │ │
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>│  │    1. check_conditions() → bool                        │ │
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>│  │    2. prepare_job_data() → dict                        │ │
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>│  │    3. queue.enqueue(job_type, job_data) → job_id       │ │
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>│  └────────────────────────────────────────────────────────┘ │
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>│                          │                                    │
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>│                          ↓ (enqueues)                         │
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>│  ┌────────────────────────────────────────────────────────┐ │
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>│  │         Existing Job Queue (UNCHANGED)                  │ │
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>│  ├────────────────────────────────────────────────────────┤ │
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>│  │  • PostgreSQLJobQueue (proven, works)                  │ │
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>│  │  • Worker registry                                      │ │
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>│  │  • Progress tracking (SSE)                             │ │
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>│  │  • Approval workflow (ADR-014)                         │ │
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>│  │  • Checkpoint/resume                                    │ │
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>│  │  • Serial/parallel execution                           │ │
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>│  └────────────────────────────────────────────────────────┘ │
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>│                          │                                    │
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>│                          ↓                                    │
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>│  ┌────────────────────────────────────────────────────────┐ │
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>│  │         Worker Functions (UNCHANGED)                    │ │
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>│  ├────────────────────────────────────────────────────────┤ │
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>│  │  • run_ingestion_worker(job_data, job_id, queue)       │ │
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>│  │  • run_restore_worker(job_data, job_id, queue)         │ │
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>│  │  • run_vocab_refresh_worker(job_data, job_id, queue)   │ │
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>│  │  • run_vocab_consolidate_worker(job_data, job_id, ...)│ │
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>│  └────────────────────────────────────────────────────────┘ │
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>│                                                               │
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>└─────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>Key Points:</strong>
- ✅ <strong>Minimal additions</strong>: Scheduler loop + launchers
- ✅ <strong>Zero changes</strong>: Existing job queue, workers, approval workflow
- ✅ <strong>No dependencies</strong>: Pure Python, asyncio background task
- ✅ <strong>Consistent</strong>: Scheduled jobs use same queue as manual jobs</p>
<h3 id="taxonomy-tasks-jobs-and-workers">Taxonomy: Tasks, Jobs, and Workers</h3>
<p><strong>Clear separation of concerns with consistent interfaces:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Trigger Type          → Launcher/Caller       → Job Queue        → Worker Function
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>─────────────────────────────────────────────────────────────────────────────────
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>SCHEDULED TASK        → Launcher checks       → enqueue()        → run_worker()
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>(time-based)            conditions, prepares     manages           does actual
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>                        job_data                 execution         work
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>ON-DEMAND JOB         → API endpoint          → enqueue()        → run_worker()
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>(user-triggered)        prepares job_data       manages           (same worker!)
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>                                                execution
</code></pre></div>
<h4 id="task-types-scheduled">Task Types (Scheduled)</h4>
<table>
<thead>
<tr>
<th>Task Name</th>
<th>Schedule</th>
<th>Launcher</th>
<th>Worker</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>category_refresh</code></td>
<td>Every 6 hours</td>
<td><code>CategoryRefreshLauncher</code></td>
<td><code>vocab_refresh_worker</code></td>
<td>Re-integrate llm_generated vocabulary categories</td>
</tr>
<tr>
<td><code>vocab_consolidation</code></td>
<td>Every 12 hours</td>
<td><code>VocabConsolidationLauncher</code></td>
<td><code>vocab_consolidate_worker</code></td>
<td>Auto-consolidate vocabulary based on hysteresis</td>
</tr>
</tbody>
</table>
<p><strong>Key Point:</strong> Scheduled tasks = timing + condition check → enqueue job</p>
<h4 id="job-types-workers">Job Types (Workers)</h4>
<table>
<thead>
<tr>
<th>Job Type</th>
<th>Worker Function</th>
<th>Trigger Sources</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ingestion</code></td>
<td><code>run_ingestion_worker</code></td>
<td>CLI (<code>kg ingest</code>), API (<code>POST /ingest</code>)</td>
<td>Extract concepts from documents</td>
</tr>
<tr>
<td><code>restore</code></td>
<td><code>run_restore_worker</code></td>
<td>CLI, API</td>
<td>Restore ontology from backup</td>
</tr>
<tr>
<td><code>backup</code></td>
<td><code>run_backup_worker</code></td>
<td>CLI, API</td>
<td>Backup ontology to file</td>
</tr>
<tr>
<td><code>vocab_refresh</code></td>
<td><code>run_vocab_refresh_worker</code></td>
<td>Scheduled (<code>category_refresh</code>), Manual</td>
<td>Refresh vocabulary categories</td>
</tr>
<tr>
<td><code>vocab_consolidate</code></td>
<td><code>run_vocab_consolidate_worker</code></td>
<td>Scheduled (<code>vocab_consolidation</code>), Manual (<code>kg vocab consolidate --auto</code>)</td>
<td>Consolidate vocabulary types</td>
</tr>
</tbody>
</table>
<p><strong>Key Point:</strong> Workers don't care how they were triggered. They just receive <code>job_data</code> and do work.</p>
<h4 id="interface-contract">Interface Contract</h4>
<p><strong>All workers follow the same signature:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_worker</span><span class="p">(</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="n">job_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">job_queue</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="sd">    Worker function signature (consistent for all job types).</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="sd">        job_data: Job-specific parameters</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="sd">            - Prepared by launcher (scheduled)</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="sd">            - Or by API endpoint (on-demand)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="sd">        job_id: Unique job identifier</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="sd">            - For progress tracking via job_queue.update_job()</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="sd">        job_queue: Queue reference</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="sd">            - For progress updates during execution</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="sd">    Returns:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="sd">        Result dict (success) or raises exception (failure)</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></p>
<p><strong>Example Flow (Scheduled Task):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>1. Scheduler: &quot;category_refresh schedule is due&quot;
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>2. Scheduler: Creates CategoryRefreshLauncher(queue)
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>3. Launcher: check_conditions() → True (found llm_generated categories)
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>4. Launcher: prepare_job_data() → {&quot;operation&quot;: &quot;refresh_categories&quot;, ...}
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>5. Launcher: queue.enqueue(&quot;vocab_refresh&quot;, job_data) → job_id
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>6. Queue: Finds run_vocab_refresh_worker in worker_registry
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>7. Queue: Executes worker(job_data, job_id, queue)
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>8. Worker: Does actual refresh work, updates progress via queue
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>9. Worker: Returns result dict or raises exception
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>10. Queue: Updates job status to &quot;completed&quot; or &quot;failed&quot;
</code></pre></div></p>
<p><strong>Example Flow (On-Demand Job):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>1. User: kg ingest file doc.txt
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>2. CLI: Calls POST /ingest with file data
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>3. API: Prepares job_data = {&quot;content&quot;: ..., &quot;ontology&quot;: ...}
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>4. API: queue.enqueue(&quot;ingestion&quot;, job_data) → job_id
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>5. Queue: Finds run_ingestion_worker in worker_registry
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>6. Queue: Executes worker(job_data, job_id, queue)
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>7. Worker: Does actual ingestion, updates progress via queue
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>8. Worker: Returns result dict or raises exception
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>9. Queue: Updates job status to &quot;completed&quot; or &quot;failed&quot;
</code></pre></div></p>
<p><strong>Key Insight:</strong> Same queue, same workers, different trigger source. Workers are blissfully unaware.</p>
<h4 id="generic-launcher-pattern">Generic Launcher Pattern</h4>
<p><strong>You can schedule ANY worker with a launcher:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">GenericJobLauncher</span><span class="p">(</span><span class="n">JobLauncher</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="sd">    Generic launcher that can invoke any worker in the system.</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="sd">    Configure via database:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">    - job_type: Which worker to call</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="sd">    - job_data_template: What parameters to pass</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="sd">    - condition_check: Optional SQL query or Python callable</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_queue</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">job_data_template</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;job_data_template&#39;</span><span class="p">]</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">condition_sql</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;condition_sql&#39;</span><span class="p">)</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_sql</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Always run if no condition</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="c1"># Execute condition SQL</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_sql</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_job_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_data_template</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_job_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span>
</code></pre></div>
<p><strong>Example: Schedule ANY job without writing custom launcher code:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">-- Schedule a backup every day at 2am</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">scheduled_jobs</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">launcher_class</span><span class="p">,</span><span class="w"> </span><span class="n">schedule_cron</span><span class="p">,</span><span class="w"> </span><span class="n">enabled</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="s1">&#39;daily_backup&#39;</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="s1">&#39;GenericJobLauncher&#39;</span><span class="p">,</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="s1">&#39;0 2 * * *&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 2am daily</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="k">TRUE</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="p">);</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="c1">-- Store launcher config separately</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">launcher_config</span><span class="w"> </span><span class="p">(</span><span class="n">schedule_name</span><span class="p">,</span><span class="w"> </span><span class="n">job_type</span><span class="p">,</span><span class="w"> </span><span class="n">job_data_template</span><span class="p">)</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="s1">&#39;daily_backup&#39;</span><span class="p">,</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="s1">&#39;backup&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- calls run_backup_worker</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="s1">&#39;{&quot;ontology&quot;: &quot;Production&quot;, &quot;backup_type&quot;: &quot;full&quot;}&#39;</span><span class="p">::</span><span class="n">jsonb</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="p">);</span>
</code></pre></div>
<p><strong>This means:</strong>
- ✅ New scheduled tasks don't require new launcher classes
- ✅ Can schedule any worker (ingestion, restore, backup, vocab, etc.)
- ✅ Configuration-driven (database), not code-driven
- ✅ Custom launchers only needed for complex condition logic</p>
<h4 id="schedule-types-polling-vs-direct-execution">Schedule Types: Polling vs Direct Execution</h4>
<p><strong>Two distinct patterns:</strong></p>
<p><strong>Pattern A: Direct Execution (Simple)</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Schedule: &quot;Run backup at 2am daily&quot;
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Condition: None (always run)
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>Behavior: Every trigger → enqueue job
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>Example:
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>  trigger (2am) → launcher.check_conditions() → True → enqueue job
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>  trigger (2am) → launcher.check_conditions() → True → enqueue job
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>  trigger (2am) → launcher.check_conditions() → True → enqueue job
</code></pre></div></p>
<p><strong>Pattern B: Polling with Rare Condition (Smart)</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Schedule: &quot;Check every 30 minutes&quot;
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Condition: &quot;Are there llm_generated categories?&quot;
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Behavior: Trigger often, job rarely
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>Example:
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>  trigger (00:00) → check_conditions() → False → skip (no job)
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>  trigger (00:30) → check_conditions() → False → skip (no job)
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>  trigger (01:00) → check_conditions() → False → skip (no job)
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>  ... 100 more times ...
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>  trigger (50:30) → check_conditions() → True → enqueue job! ✅
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>  trigger (51:00) → check_conditions() → False → skip (job completed, nothing to do)
</code></pre></div></p>
<p><strong>Real-World Example: Category Refresh</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Schedule: Every 6 hours (4 times per day)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># Reality: Might only find work once every 2-3 days</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CategoryRefreshLauncher</span><span class="p">(</span><span class="n">JobLauncher</span><span class="p">):</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="c1"># This might return False 20+ times before finding work</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="n">categories</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_vocabulary_categories</span><span class="p">()</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;llm_generated&#39;</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relationship_types&#39;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>                   <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Logs show the pattern:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>2025-10-28 00:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>2025-10-28 06:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>2025-10-28 12:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>2025-10-28 18:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>2025-10-29 00:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>2025-10-29 06:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>2025-10-29 12:00 ✓   CategoryRefreshLauncher: Found category &#39;Temporal&#39; with llm_generated
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>2025-10-29 12:00 ✅  CategoryRefreshLauncher: Enqueued job job_abc123
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>2025-10-29 18:00 ⏭️  CategoryRefreshLauncher: Conditions not met, skipping (job handled it)
</code></pre></div></p>
<p><strong>Configuration Examples:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">-- Pattern A: Always run (backup every night)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">scheduled_jobs</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">launcher_class</span><span class="p">,</span><span class="w"> </span><span class="n">schedule_cron</span><span class="p">)</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="s1">&#39;nightly_backup&#39;</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="s1">&#39;GenericJobLauncher&#39;</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="s1">&#39;0 2 * * *&#39;</span><span class="w">  </span><span class="c1">-- 2am daily, no condition, always runs</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="p">);</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1">-- Pattern B: Poll frequently, run rarely (vocab maintenance)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">scheduled_jobs</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">launcher_class</span><span class="p">,</span><span class="w"> </span><span class="n">schedule_cron</span><span class="p">)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="s1">&#39;vocab_cleanup&#39;</span><span class="p">,</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="s1">&#39;VocabCleanupLauncher&#39;</span><span class="p">,</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="s1">&#39;*/30 * * * *&#39;</span><span class="w">  </span><span class="c1">-- Every 30 minutes, but only runs if cleanup needed</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="p">);</span>
</code></pre></div>
<p><strong>Why This Pattern?</strong></p>
<p><strong>Benefits:</strong>
- ✅ Responsive: Don't wait 6 hours when condition becomes true
- ✅ Self-healing: If job fails, next check might succeed
- ✅ Adaptive: Condition logic can be complex (hysteresis, thresholds)
- ✅ Efficient: Condition check is cheap (SQL query), job is expensive (LLM calls)</p>
<p><strong>Cost:</strong>
- ❌ Frequent condition checks (but cheap: ~1ms SQL query)
- ❌ Many "skip" log entries (but informative for monitoring)</p>
<p><strong>Design Principle:</strong></p>
<blockquote>
<p>"Check often (cheap), work rarely (expensive)"</p>
</blockquote>
<p><strong>Schedule as Rate Limit, Not Exact Timing:</strong></p>
<p>The schedule interval is really a <strong>minimum spacing</strong> / <strong>cooldown period</strong>, not a precise execution time:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>Schedule: &quot;*/30 * * * *&quot; (every 30 minutes)
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>Translation: &quot;This worker is resource-intensive. Don&#39;t run it more often than
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>             every 30 minutes. When it does run, it probably won&#39;t need to
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>             run again for a long time.&quot;
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>Reality:
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>  - Launcher fires every 30 minutes (cheap condition check)
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>  - Worker runs once every few days (expensive work, when needed)
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>  - Schedule prevents over-execution, condition prevents under-utilization
</code></pre></div>
<p><strong>We don't have to guess WHEN to run it:</strong>
- ❌ Bad: "Should we run vocab consolidation at 2am? 3am? Tuesday?"
- ✅ Good: "Check every 30 minutes if consolidation is needed, but never run more often than that"</p>
<p><strong>The job regulates itself:</strong>
- Launcher checks: "Is there work?" (1ms SQL query)
- If yes: Enqueue expensive job
- If no: Skip, check again in 30 minutes
- Once job completes: Condition likely False for hours/days
- Self-regulating: No need to predict or tune exact timing</p>
<p><strong>Example: Vocabulary Consolidation</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>Schedule: Every 30 minutes
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>Condition: inactive_types &gt; 20% of active_types
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>Behavior:
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  - Checks 48 times per day (cheap)
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>  - Runs ~once per week when threshold exceeded (expensive)
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>  - After running, threshold not exceeded for days
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>  - Perfect: Protected from over-execution, responsive to actual need
</code></pre></div></p>
<p>This is why launchers exist - they're the intelligent filter between schedule timing and actual job execution.</p>
<h3 id="architecture-clarification-code-vs-configuration">Architecture Clarification: Code vs Configuration</h3>
<p><strong>What's in PostgreSQL (Configuration):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>kg_api.scheduled_jobs:
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  - Schedule definitions (cron, enabled, retries)
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>  - Execution history (last_run, last_success, last_failure)
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>  - Status tracking (retry_count, next_run)
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>kg_api.jobs:
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>  - Job execution results (existing table, unchanged)
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>  - Progress tracking for SSE streaming
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>  - Deduplication via content_hash
</code></pre></div></p>
<p><strong>What's in Python Code (Logic):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>Launchers (src/api/launchers/):
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>  - Condition checking logic
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>  - Job data preparation
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>  - NOT API endpoints (internal only)
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>  - Called by scheduler loop
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>Example:
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>  category_refresh.py         ← Custom condition logic (code)
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>  vocab_consolidation.py      ← Hysteresis logic (code)
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>  generic_launcher.py         ← Simple pass-through (code)
</code></pre></div></p>
<p><strong>Key Point:</strong>
- ✅ <strong>Configuration lives in PostgreSQL</strong> (schedules, timing, history)
- ✅ <strong>Launchers are Python classes</strong> (condition logic requires code)
- ❌ <strong>NOT a universal job authoring system</strong> (too complex, not needed)</p>
<p><strong>Adding a New Scheduled Task:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># 1. Write launcher class (if custom logic needed)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c1"># src/api/launchers/my_task.py</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyTaskLauncher</span><span class="p">(</span><span class="n">JobLauncher</span><span class="p">):</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>        <span class="c1"># Your condition logic here</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>        <span class="k">return</span> <span class="n">some_check</span><span class="p">()</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_job_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;my_task&quot;</span><span class="p">}</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_job_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>        <span class="k">return</span> <span class="s2">&quot;my_worker&quot;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="c1"># 2. Register launcher in main.py</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="n">launcher_registry</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="s1">&#39;MyTaskLauncher&#39;</span><span class="p">:</span> <span class="n">MyTaskLauncher</span><span class="p">,</span>  <span class="c1"># Add this line</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>    <span class="o">...</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="p">}</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="c1"># 3. Configure schedule in PostgreSQL (via API or SQL)</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">kg_api</span><span class="o">.</span><span class="n">scheduled_jobs</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">launcher_class</span><span class="p">,</span> <span class="n">schedule_cron</span><span class="p">)</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;my_task&#39;</span><span class="p">,</span> <span class="s1">&#39;MyTaskLauncher&#39;</span><span class="p">,</span> <span class="s1">&#39;0 */2 * * *&#39;</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>For simple tasks (no condition logic), use GenericJobLauncher:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">-- No code required! Just configure in database</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">scheduled_jobs</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">launcher_class</span><span class="p">,</span><span class="w"> </span><span class="n">schedule_cron</span><span class="p">)</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;nightly_backup&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;GenericJobLauncher&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0 2 * * *&#39;</span><span class="p">);</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">launcher_config</span><span class="w"> </span><span class="p">(</span><span class="n">schedule_name</span><span class="p">,</span><span class="w"> </span><span class="n">job_type</span><span class="p">,</span><span class="w"> </span><span class="n">job_data_template</span><span class="p">)</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;nightly_backup&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;backup&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{&quot;ontology&quot;: &quot;Production&quot;}&#39;</span><span class="p">::</span><span class="n">jsonb</span><span class="p">);</span>
</code></pre></div></p>
<h3 id="management-apis">Management APIs</h3>
<p><strong>Endpoint Separation: Jobs vs Schedules</strong></p>
<p>The system has two distinct endpoint namespaces:</p>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>Purpose</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/jobs</code></td>
<td><strong>Job execution instances</strong></td>
<td>List running jobs, get job status, delete job records</td>
</tr>
<tr>
<td><code>/admin/scheduled-jobs</code></td>
<td><strong>Schedule configuration</strong></td>
<td>List schedules, enable/disable, update cron expressions</td>
</tr>
</tbody>
</table>
<p><strong>Why separate?</strong>
- A <strong>job</strong> is an execution instance (specific ingestion run with progress, results)
- A <strong>scheduled job</strong> is a configuration (the schedule definition that creates jobs)
- One schedule creates many job instances over time
- Example: <code>category_refresh</code> schedule (1 config) → 100+ job executions over weeks</p>
<p><strong>Concrete Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Schedule: &quot;category_refresh&quot; (cron: &quot;0 */6 * * *&quot;)
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>  ├─ Job execution 1: job_abc123 (2025-10-28 06:00, completed)
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>  ├─ Job execution 2: job_abc456 (2025-10-28 12:00, completed)
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>  ├─ Job execution 3: job_abc789 (2025-10-28 18:00, running)
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>  └─ Job execution 4: job_abcXYZ (2025-10-29 00:00, pending)
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>GET /admin/scheduled-jobs/category_refresh  → Schedule config
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>GET /jobs/job_abc123                        → Specific execution
</code></pre></div></p>
<p><strong>All scheduled job management via REST API:</strong></p>
<h4 id="get-adminscheduled-jobs">GET /admin/scheduled-jobs</h4>
<p>List all scheduled jobs with status.</p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="nt">&quot;schedules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;category_refresh&quot;</span><span class="p">,</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">      </span><span class="nt">&quot;launcher_class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CategoryRefreshLauncher&quot;</span><span class="p">,</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">      </span><span class="nt">&quot;schedule_cron&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0 */6 * * *&quot;</span><span class="p">,</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">      </span><span class="nt">&quot;max_retries&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">      </span><span class="nt">&quot;retry_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">      </span><span class="nt">&quot;last_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">      </span><span class="nt">&quot;last_success&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">      </span><span class="nt">&quot;last_failure&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">      </span><span class="nt">&quot;next_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T18:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">      </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-27T00:00:00Z&quot;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="get-adminscheduled-jobsname">GET /admin/scheduled-jobs/{name}</h4>
<p>Get details for a specific scheduled job.</p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;category_refresh&quot;</span><span class="p">,</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="nt">&quot;launcher_class&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CategoryRefreshLauncher&quot;</span><span class="p">,</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">  </span><span class="nt">&quot;schedule_cron&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0 */6 * * *&quot;</span><span class="p">,</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">  </span><span class="nt">&quot;max_retries&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">  </span><span class="nt">&quot;retry_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="nt">&quot;last_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">  </span><span class="nt">&quot;last_success&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">  </span><span class="nt">&quot;last_failure&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">  </span><span class="nt">&quot;next_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T18:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">  </span><span class="nt">&quot;recent_jobs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">      </span><span class="nt">&quot;job_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;job_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">      </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">      </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">      </span><span class="nt">&quot;completed_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:05:23Z&quot;</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="post-adminscheduled-jobsnameenable">POST /admin/scheduled-jobs/{name}/enable</h4>
<p>Enable a disabled schedule.</p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Schedule &#39;category_refresh&#39; enabled&quot;</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="nt">&quot;next_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T18:00:00Z&quot;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="post-adminscheduled-jobsnamedisable">POST /admin/scheduled-jobs/{name}/disable</h4>
<p>Disable a schedule.</p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Schedule &#39;category_refresh&#39; disabled&quot;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="post-adminscheduled-jobsnametrigger">POST /admin/scheduled-jobs/{name}/trigger</h4>
<p>Manually trigger a schedule now (bypasses timing, still checks conditions).</p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="p">{</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">  </span><span class="nt">&quot;job_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;job_xyz789&quot;</span><span class="p">,</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Schedule &#39;category_refresh&#39; triggered manually&quot;</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="patch-adminscheduled-jobsname">PATCH /admin/scheduled-jobs/{name}</h4>
<p>Update schedule configuration.</p>
<p><strong>Request:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="nt">&quot;schedule_cron&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0 */2 * * *&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Optional: Update cron expression</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span><span class="nt">&quot;max_retries&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">                </span><span class="c1">// Optional: Update retry limit</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">                   </span><span class="c1">// Optional: Enable/disable</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="p">{</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Schedule &#39;category_refresh&#39; updated&quot;</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="nt">&quot;next_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T14:00:00Z&quot;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="get-adminscheduled-jobsnamehistory">GET /admin/scheduled-jobs/{name}/history</h4>
<p>Get execution history for a schedule.</p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">  </span><span class="nt">&quot;schedule_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;category_refresh&quot;</span><span class="p">,</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="nt">&quot;history&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">      </span><span class="nt">&quot;run_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T12:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">      </span><span class="nt">&quot;outcome&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">      </span><span class="nt">&quot;job_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;job_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">      </span><span class="nt">&quot;conditions_met&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">      </span><span class="nt">&quot;run_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-28T06:00:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">      </span><span class="nt">&quot;outcome&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">      </span><span class="nt">&quot;job_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">      </span><span class="nt">&quot;conditions_met&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">  </span><span class="nt">&quot;stats&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="nt">&quot;total_runs&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">    </span><span class="nt">&quot;successful_runs&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">    </span><span class="nt">&quot;skipped_runs&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">    </span><span class="nt">&quot;failed_runs&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">    </span><span class="nt">&quot;success_rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;75%&quot;</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="cli-commands">CLI Commands</h3>
<p><strong>Corresponding CLI commands for user-friendly management:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># List all schedules</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span>list
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># Show schedule details</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span>status<span class="w"> </span>category_refresh
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="c1"># Enable/disable</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>category_refresh
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span>disable<span class="w"> </span>category_refresh
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c1"># Manually trigger</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span>trigger<span class="w"> </span>category_refresh
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="c1"># Update schedule</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span>update<span class="w"> </span>category_refresh<span class="w"> </span>--cron<span class="w"> </span><span class="s2">&quot;0 */2 * * *&quot;</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="c1"># View history</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>kg<span class="w"> </span>admin<span class="w"> </span>scheduled<span class="w"> </span><span class="nb">history</span><span class="w"> </span>category_refresh<span class="w"> </span>--limit<span class="w"> </span><span class="m">20</span>
</code></pre></div>
<h2 id="job-ownership-and-permissions">Job Ownership and Permissions</h2>
<p><strong>Problem:</strong> Users shouldn't be able to delete system-scheduled jobs, but we need convenient access to manage their own jobs.</p>
<h3 id="schema-enhancement">Schema Enhancement</h3>
<p><strong>Add ownership tracking to <code>kg_api.jobs</code>:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">-- Migration 019: Add job ownership and source tracking</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">jobs</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">job_source</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;user_cli&#39;</span><span class="p">,</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">created_by</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">is_system_job</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="c1">-- Create index for permission checks</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">idx_jobs_ownership</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="k">ON</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">jobs</span><span class="p">(</span><span class="n">created_by</span><span class="p">,</span><span class="w"> </span><span class="n">is_system_job</span><span class="p">);</span>
</code></pre></div>
<p><strong>Job Source Types:</strong>
- <code>user_cli</code> - User invoked via CLI (<code>kg ingest file ...</code>)
- <code>user_api</code> - User invoked via API (<code>POST /ingest</code>)
- <code>scheduled_task</code> - System-scheduled task (category_refresh, vocab_consolidation)
- <code>system</code> - System internal job (backup, restore, maintenance)</p>
<h3 id="permission-rules">Permission Rules</h3>
<p><strong>User Permissions:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>✅ CAN:
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>  - List their own jobs (WHERE created_by = user)
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>  - Delete their own jobs (WHERE created_by = user AND is_system_job = FALSE)
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>  - Cancel their own running jobs
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>  - View status of their own jobs
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>❌ CANNOT:
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>  - Delete system jobs (WHERE is_system_job = TRUE)
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>  - Delete other users&#39; jobs
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>  - Modify scheduled tasks
</code></pre></div></p>
<p><strong>Admin Permissions:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>✅ CAN:
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>  - List ALL jobs (no filter)
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>  - Delete ANY job (including system jobs)
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>  - Cancel ANY running job
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>  - Modify scheduled tasks
</code></pre></div></p>
<h3 id="cli-taxonomy-restructure">CLI Taxonomy Restructure</h3>
<p><strong>Current (Flat - No Permissions):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w">             </span><span class="c1"># Lists ALL jobs (unsafe)</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>delete<span class="w"> </span>ID<span class="w">        </span><span class="c1"># Deletes ANY job (unsafe!)</span>
</code></pre></div></p>
<p><strong>Proposed (Hierarchical - Permission-Aware):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1"># User commands (scoped to user&#39;s jobs)</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>kg<span class="w"> </span>ingest<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w">                    </span><span class="c1"># List MY ingestion jobs</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>kg<span class="w"> </span>ingest<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>delete<span class="w"> </span>JOB_ID<span class="w">           </span><span class="c1"># Delete MY ingestion job</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>kg<span class="w"> </span>ingest<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>cancel<span class="w"> </span>JOB_ID<span class="w">           </span><span class="c1"># Cancel MY running job</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>kg<span class="w"> </span>vocab<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w">                     </span><span class="c1"># List MY vocab jobs</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>kg<span class="w"> </span>vocab<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>delete<span class="w"> </span>JOB_ID<span class="w">            </span><span class="c1"># Delete MY vocab job</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w">                           </span><span class="c1"># List ALL my jobs (all types)</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>delete<span class="w"> </span>JOB_ID<span class="w">                  </span><span class="c1"># Delete my job (permission check)</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="c1"># Admin commands (global scope)</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>kg<span class="w"> </span>admin<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w">                     </span><span class="c1"># List ALL jobs (all users)</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>kg<span class="w"> </span>admin<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w"> </span>--system<span class="w">            </span><span class="c1"># List system/scheduled jobs only</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>kg<span class="w"> </span>admin<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>delete<span class="w"> </span>JOB_ID<span class="w">            </span><span class="c1"># Delete ANY job (with confirmation)</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>kg<span class="w"> </span>admin<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>stats<span class="w">                    </span><span class="c1"># Job statistics</span>
</code></pre></div>
<p><strong>Example: User tries to delete system job (blocked):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>$<span class="w"> </span>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>delete<span class="w"> </span>job_sys456
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>❌<span class="w"> </span>Error:<span class="w"> </span>Cannot<span class="w"> </span>delete<span class="w"> </span>system<span class="w"> </span>job<span class="w"> </span>job_sys456<span class="w"> </span><span class="o">(</span>scheduled<span class="w"> </span>task<span class="o">)</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">   </span>Use<span class="w"> </span><span class="s1">&#39;kg admin jobs delete&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>have<span class="w"> </span>admin<span class="w"> </span>privileges
</code></pre></div></p>
<h3 id="api-permission-enforcement">API Permission Enforcement</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/jobs/</span><span class="si">{job_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cli_user&quot;</span><span class="p">):</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a job (user can only delete their own non-system jobs).&quot;&quot;&quot;</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>    <span class="n">job</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="p">:</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Job not found&quot;</span><span class="p">)</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>    <span class="c1"># Permission check: System jobs protected</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_system_job&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>            <span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cannot delete system job. Use admin API if authorized.&quot;</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>        <span class="p">)</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>    <span class="c1"># Permission check: Own jobs only</span>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created_by&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">current_user</span><span class="p">:</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>            <span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cannot delete job created by another user&quot;</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>        <span class="p">)</span>
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>    <span class="n">success</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> deleted&quot;</span><span class="p">}</span>
</code></pre></div>
<h3 id="scheduled-job-creation-system-ownership">Scheduled Job Creation (System Ownership)</h3>
<p><strong>Mark scheduler-created jobs as system:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">JobLauncher</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>        <span class="c1"># Enqueue job</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>            <span class="n">job_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_job_type</span><span class="p">(),</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>            <span class="n">job_data</span><span class="o">=</span><span class="n">job_data</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>        <span class="p">)</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>        <span class="c1"># Mark as system job</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">update_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>                <span class="s2">&quot;is_system_job&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>                <span class="s2">&quot;job_source&quot;</span><span class="p">:</span> <span class="s2">&quot;scheduled_task&quot;</span><span class="p">,</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>                <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;system:scheduler:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>            <span class="p">})</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>        <span class="k">return</span> <span class="n">job_id</span>
</code></pre></div>
<h3 id="components">Components</h3>
<h4 id="1-schedule-configuration-table">1. Schedule Configuration Table</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1">-- Migration 019: Add scheduled jobs configuration</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">scheduled_jobs</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="n">launcher_class</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">    </span><span class="n">schedule_cron</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span><span class="c1">-- Cron expression: &quot;0 */6 * * *&quot;</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">    </span><span class="n">enabled</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">    </span><span class="n">max_retries</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">    </span><span class="n">retry_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="w">    </span><span class="n">last_run</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="w">    </span><span class="n">last_success</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="w">    </span><span class="n">last_failure</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="w">    </span><span class="n">next_run</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w">  </span><span class="c1">-- Calculated from cron</span>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="p">);</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="c1">-- Insert default scheduled jobs</span>
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">kg_api</span><span class="p">.</span><span class="n">scheduled_jobs</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">launcher_class</span><span class="p">,</span><span class="w"> </span><span class="n">schedule_cron</span><span class="p">,</span><span class="w"> </span><span class="n">enabled</span><span class="p">)</span>
<a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a><span class="k">VALUES</span>
<a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="w">    </span><span class="p">(</span><span class="s1">&#39;category_refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CategoryRefreshLauncher&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0 */6 * * *&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">TRUE</span><span class="p">),</span>
<a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a><span class="w">    </span><span class="p">(</span><span class="s1">&#39;vocab_consolidation&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;VocabConsolidationLauncher&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0 */12 * * *&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">TRUE</span><span class="p">)</span>
<a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a><span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">NOTHING</span><span class="p">;</span>
</code></pre></div>
<h4 id="2-simple-scheduler-loop">2. Simple Scheduler Loop</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># src/api/services/scheduler.py</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">croniter</span><span class="w"> </span><span class="kn">import</span> <span class="n">croniter</span>  <span class="c1"># Simple cron parser library</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Type</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">JobScheduler</span><span class="p">:</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="sd">    Simple scheduler that triggers launchers based on cron schedules.</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="sd">    No fancy features. Just checks schedules every 60 seconds and</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="sd">    fires launchers when schedules match.</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_queue</span><span class="p">,</span> <span class="n">launcher_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">]):</span>
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="n">job_queue</span>
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">launcher_registry</span> <span class="o">=</span> <span class="n">launcher_registry</span>
<a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a>
<a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the scheduler loop&quot;&quot;&quot;</span>
<a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schedule_loop</span><span class="p">())</span>
<a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ Job scheduler started&quot;</span><span class="p">)</span>
<a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a>
<a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the scheduler loop&quot;&quot;&quot;</span>
<a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">:</span>
<a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
<a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a>                <span class="k">pass</span>
<a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;🛑 Job scheduler stopped&quot;</span><span class="p">)</span>
<a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a>
<a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_schedule_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-44" name="__codelineno-37-44" href="#__codelineno-37-44"></a><span class="sd">        Main scheduler loop.</span>
<a id="__codelineno-37-45" name="__codelineno-37-45" href="#__codelineno-37-45"></a>
<a id="__codelineno-37-46" name="__codelineno-37-46" href="#__codelineno-37-46"></a><span class="sd">        Checks schedules every 60 seconds, triggers launchers when due.</span>
<a id="__codelineno-37-47" name="__codelineno-37-47" href="#__codelineno-37-47"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-37-48" name="__codelineno-37-48" href="#__codelineno-37-48"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
<a id="__codelineno-37-49" name="__codelineno-37-49" href="#__codelineno-37-49"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-37-50" name="__codelineno-37-50" href="#__codelineno-37-50"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_schedules</span><span class="p">()</span>
<a id="__codelineno-37-51" name="__codelineno-37-51" href="#__codelineno-37-51"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-37-52" name="__codelineno-37-52" href="#__codelineno-37-52"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Scheduler error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-37-53" name="__codelineno-37-53" href="#__codelineno-37-53"></a>
<a id="__codelineno-37-54" name="__codelineno-37-54" href="#__codelineno-37-54"></a>            <span class="c1"># Sleep 60 seconds before next check</span>
<a id="__codelineno-37-55" name="__codelineno-37-55" href="#__codelineno-37-55"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-37-56" name="__codelineno-37-56" href="#__codelineno-37-56"></a>
<a id="__codelineno-37-57" name="__codelineno-37-57" href="#__codelineno-37-57"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_schedules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-37-58" name="__codelineno-37-58" href="#__codelineno-37-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-59" name="__codelineno-37-59" href="#__codelineno-37-59"></a><span class="sd">        Check all enabled schedules and trigger if due.</span>
<a id="__codelineno-37-60" name="__codelineno-37-60" href="#__codelineno-37-60"></a>
<a id="__codelineno-37-61" name="__codelineno-37-61" href="#__codelineno-37-61"></a><span class="sd">        Uses PostgreSQL advisory lock to ensure only one worker checks</span>
<a id="__codelineno-37-62" name="__codelineno-37-62" href="#__codelineno-37-62"></a><span class="sd">        schedules in multi-worker deployments (e.g., Gunicorn -w 4).</span>
<a id="__codelineno-37-63" name="__codelineno-37-63" href="#__codelineno-37-63"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-37-64" name="__codelineno-37-64" href="#__codelineno-37-64"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">src.api.lib.age_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">AGEClient</span>
<a id="__codelineno-37-65" name="__codelineno-37-65" href="#__codelineno-37-65"></a>
<a id="__codelineno-37-66" name="__codelineno-37-66" href="#__codelineno-37-66"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">AGEClient</span><span class="p">()</span>
<a id="__codelineno-37-67" name="__codelineno-37-67" href="#__codelineno-37-67"></a>        <span class="n">conn</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">getconn</span><span class="p">()</span>
<a id="__codelineno-37-68" name="__codelineno-37-68" href="#__codelineno-37-68"></a>
<a id="__codelineno-37-69" name="__codelineno-37-69" href="#__codelineno-37-69"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-37-70" name="__codelineno-37-70" href="#__codelineno-37-70"></a>            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
<a id="__codelineno-37-71" name="__codelineno-37-71" href="#__codelineno-37-71"></a>                <span class="c1"># --- MULTI-WORKER SAFETY ---</span>
<a id="__codelineno-37-72" name="__codelineno-37-72" href="#__codelineno-37-72"></a>                <span class="c1"># Try to acquire a unique, non-blocking advisory lock.</span>
<a id="__codelineno-37-73" name="__codelineno-37-73" href="#__codelineno-37-73"></a>                <span class="c1"># Only one worker across all processes can hold this lock.</span>
<a id="__codelineno-37-74" name="__codelineno-37-74" href="#__codelineno-37-74"></a>                <span class="c1"># Key: 1050 (arbitrary unique integer for this system)</span>
<a id="__codelineno-37-75" name="__codelineno-37-75" href="#__codelineno-37-75"></a>                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT pg_try_advisory_lock(1050)&quot;</span><span class="p">)</span>
<a id="__codelineno-37-76" name="__codelineno-37-76" href="#__codelineno-37-76"></a>                <span class="n">got_lock</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-37-77" name="__codelineno-37-77" href="#__codelineno-37-77"></a>
<a id="__codelineno-37-78" name="__codelineno-37-78" href="#__codelineno-37-78"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">got_lock</span><span class="p">:</span>
<a id="__codelineno-37-79" name="__codelineno-37-79" href="#__codelineno-37-79"></a>                    <span class="c1"># Another worker has the lock and is checking schedules.</span>
<a id="__codelineno-37-80" name="__codelineno-37-80" href="#__codelineno-37-80"></a>                    <span class="c1"># This worker should do nothing to avoid duplicate job creation.</span>
<a id="__codelineno-37-81" name="__codelineno-37-81" href="#__codelineno-37-81"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-37-82" name="__codelineno-37-82" href="#__codelineno-37-82"></a>                        <span class="s2">&quot;Scheduler lock held by another worker, skipping check cycle&quot;</span>
<a id="__codelineno-37-83" name="__codelineno-37-83" href="#__codelineno-37-83"></a>                    <span class="p">)</span>
<a id="__codelineno-37-84" name="__codelineno-37-84" href="#__codelineno-37-84"></a>                    <span class="k">return</span>
<a id="__codelineno-37-85" name="__codelineno-37-85" href="#__codelineno-37-85"></a>
<a id="__codelineno-37-86" name="__codelineno-37-86" href="#__codelineno-37-86"></a>                <span class="c1"># If we&#39;re here, we are the ONLY worker running schedule checks</span>
<a id="__codelineno-37-87" name="__codelineno-37-87" href="#__codelineno-37-87"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Acquired scheduler lock, proceeding with schedule check&quot;</span><span class="p">)</span>
<a id="__codelineno-37-88" name="__codelineno-37-88" href="#__codelineno-37-88"></a>                <span class="c1"># --- END MULTI-WORKER SAFETY ---</span>
<a id="__codelineno-37-89" name="__codelineno-37-89" href="#__codelineno-37-89"></a>                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-37-90" name="__codelineno-37-90" href="#__codelineno-37-90"></a><span class="s2">                    SELECT id, name, launcher_class, schedule_cron,</span>
<a id="__codelineno-37-91" name="__codelineno-37-91" href="#__codelineno-37-91"></a><span class="s2">                           retry_count, max_retries, last_run, next_run</span>
<a id="__codelineno-37-92" name="__codelineno-37-92" href="#__codelineno-37-92"></a><span class="s2">                    FROM kg_api.scheduled_jobs</span>
<a id="__codelineno-37-93" name="__codelineno-37-93" href="#__codelineno-37-93"></a><span class="s2">                    WHERE enabled = TRUE</span>
<a id="__codelineno-37-94" name="__codelineno-37-94" href="#__codelineno-37-94"></a><span class="s2">                    ORDER BY next_run ASC NULLS FIRST</span>
<a id="__codelineno-37-95" name="__codelineno-37-95" href="#__codelineno-37-95"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-37-96" name="__codelineno-37-96" href="#__codelineno-37-96"></a>
<a id="__codelineno-37-97" name="__codelineno-37-97" href="#__codelineno-37-97"></a>                <span class="n">schedules</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-37-98" name="__codelineno-37-98" href="#__codelineno-37-98"></a>                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-37-99" name="__codelineno-37-99" href="#__codelineno-37-99"></a>
<a id="__codelineno-37-100" name="__codelineno-37-100" href="#__codelineno-37-100"></a>                <span class="k">for</span> <span class="n">schedule</span> <span class="ow">in</span> <span class="n">schedules</span><span class="p">:</span>
<a id="__codelineno-37-101" name="__codelineno-37-101" href="#__codelineno-37-101"></a>                    <span class="n">schedule_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">launcher_class</span><span class="p">,</span> <span class="n">cron_expr</span><span class="p">,</span> \
<a id="__codelineno-37-102" name="__codelineno-37-102" href="#__codelineno-37-102"></a>                    <span class="n">retry_count</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">,</span> <span class="n">last_run</span><span class="p">,</span> <span class="n">next_run</span> <span class="o">=</span> <span class="n">schedule</span>
<a id="__codelineno-37-103" name="__codelineno-37-103" href="#__codelineno-37-103"></a>
<a id="__codelineno-37-104" name="__codelineno-37-104" href="#__codelineno-37-104"></a>                    <span class="c1"># Calculate next run if not set</span>
<a id="__codelineno-37-105" name="__codelineno-37-105" href="#__codelineno-37-105"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">next_run</span><span class="p">:</span>
<a id="__codelineno-37-106" name="__codelineno-37-106" href="#__codelineno-37-106"></a>                        <span class="n">cron</span> <span class="o">=</span> <span class="n">croniter</span><span class="p">(</span><span class="n">cron_expr</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
<a id="__codelineno-37-107" name="__codelineno-37-107" href="#__codelineno-37-107"></a>                        <span class="n">next_run</span> <span class="o">=</span> <span class="n">cron</span><span class="o">.</span><span class="n">get_next</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<a id="__codelineno-37-108" name="__codelineno-37-108" href="#__codelineno-37-108"></a>
<a id="__codelineno-37-109" name="__codelineno-37-109" href="#__codelineno-37-109"></a>                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-37-110" name="__codelineno-37-110" href="#__codelineno-37-110"></a><span class="s2">                            UPDATE kg_api.scheduled_jobs</span>
<a id="__codelineno-37-111" name="__codelineno-37-111" href="#__codelineno-37-111"></a><span class="s2">                            SET next_run = </span><span class="si">%s</span>
<a id="__codelineno-37-112" name="__codelineno-37-112" href="#__codelineno-37-112"></a><span class="s2">                            WHERE id = </span><span class="si">%s</span>
<a id="__codelineno-37-113" name="__codelineno-37-113" href="#__codelineno-37-113"></a><span class="s2">                        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">next_run</span><span class="p">,</span> <span class="n">schedule_id</span><span class="p">))</span>
<a id="__codelineno-37-114" name="__codelineno-37-114" href="#__codelineno-37-114"></a>                        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-37-115" name="__codelineno-37-115" href="#__codelineno-37-115"></a>                        <span class="k">continue</span>
<a id="__codelineno-37-116" name="__codelineno-37-116" href="#__codelineno-37-116"></a>
<a id="__codelineno-37-117" name="__codelineno-37-117" href="#__codelineno-37-117"></a>                    <span class="c1"># Check if due</span>
<a id="__codelineno-37-118" name="__codelineno-37-118" href="#__codelineno-37-118"></a>                    <span class="k">if</span> <span class="n">next_run</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">:</span>
<a id="__codelineno-37-119" name="__codelineno-37-119" href="#__codelineno-37-119"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏰ Schedule &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is due, triggering launcher&quot;</span><span class="p">)</span>
<a id="__codelineno-37-120" name="__codelineno-37-120" href="#__codelineno-37-120"></a>
<a id="__codelineno-37-121" name="__codelineno-37-121" href="#__codelineno-37-121"></a>                        <span class="c1"># Get launcher class</span>
<a id="__codelineno-37-122" name="__codelineno-37-122" href="#__codelineno-37-122"></a>                        <span class="n">launcher_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launcher_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">launcher_class</span><span class="p">)</span>
<a id="__codelineno-37-123" name="__codelineno-37-123" href="#__codelineno-37-123"></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">launcher_cls</span><span class="p">:</span>
<a id="__codelineno-37-124" name="__codelineno-37-124" href="#__codelineno-37-124"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Unknown launcher: </span><span class="si">{</span><span class="n">launcher_class</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-37-125" name="__codelineno-37-125" href="#__codelineno-37-125"></a>                            <span class="k">continue</span>
<a id="__codelineno-37-126" name="__codelineno-37-126" href="#__codelineno-37-126"></a>
<a id="__codelineno-37-127" name="__codelineno-37-127" href="#__codelineno-37-127"></a>                        <span class="c1"># Create launcher instance</span>
<a id="__codelineno-37-128" name="__codelineno-37-128" href="#__codelineno-37-128"></a>                        <span class="n">launcher</span> <span class="o">=</span> <span class="n">launcher_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">)</span>
<a id="__codelineno-37-129" name="__codelineno-37-129" href="#__codelineno-37-129"></a>
<a id="__codelineno-37-130" name="__codelineno-37-130" href="#__codelineno-37-130"></a>                        <span class="c1"># Trigger launcher (three possible outcomes)</span>
<a id="__codelineno-37-131" name="__codelineno-37-131" href="#__codelineno-37-131"></a>                        <span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-37-132" name="__codelineno-37-132" href="#__codelineno-37-132"></a>                        <span class="n">launch_failed</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-37-133" name="__codelineno-37-133" href="#__codelineno-37-133"></a>
<a id="__codelineno-37-134" name="__codelineno-37-134" href="#__codelineno-37-134"></a>                        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-37-135" name="__codelineno-37-135" href="#__codelineno-37-135"></a>                            <span class="c1"># launch() returns job_id, None (for skip),</span>
<a id="__codelineno-37-136" name="__codelineno-37-136" href="#__codelineno-37-136"></a>                            <span class="c1"># or raises Exception (for failure)</span>
<a id="__codelineno-37-137" name="__codelineno-37-137" href="#__codelineno-37-137"></a>                            <span class="n">job_id</span> <span class="o">=</span> <span class="n">launcher</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
<a id="__codelineno-37-138" name="__codelineno-37-138" href="#__codelineno-37-138"></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-37-139" name="__codelineno-37-139" href="#__codelineno-37-139"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-37-140" name="__codelineno-37-140" href="#__codelineno-37-140"></a>                                <span class="sa">f</span><span class="s2">&quot;❌ Schedule &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; launcher failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-37-141" name="__codelineno-37-141" href="#__codelineno-37-141"></a>                                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-37-142" name="__codelineno-37-142" href="#__codelineno-37-142"></a>                            <span class="p">)</span>
<a id="__codelineno-37-143" name="__codelineno-37-143" href="#__codelineno-37-143"></a>                            <span class="n">launch_failed</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-37-144" name="__codelineno-37-144" href="#__codelineno-37-144"></a>
<a id="__codelineno-37-145" name="__codelineno-37-145" href="#__codelineno-37-145"></a>                        <span class="c1"># Calculate next run time for schedule advancement</span>
<a id="__codelineno-37-146" name="__codelineno-37-146" href="#__codelineno-37-146"></a>                        <span class="n">cron</span> <span class="o">=</span> <span class="n">croniter</span><span class="p">(</span><span class="n">cron_expr</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
<a id="__codelineno-37-147" name="__codelineno-37-147" href="#__codelineno-37-147"></a>                        <span class="n">next_next_run</span> <span class="o">=</span> <span class="n">cron</span><span class="o">.</span><span class="n">get_next</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<a id="__codelineno-37-148" name="__codelineno-37-148" href="#__codelineno-37-148"></a>
<a id="__codelineno-37-149" name="__codelineno-37-149" href="#__codelineno-37-149"></a>                        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
<a id="__codelineno-37-150" name="__codelineno-37-150" href="#__codelineno-37-150"></a>                            <span class="c1"># Outcome 1: Success - Job enqueued</span>
<a id="__codelineno-37-151" name="__codelineno-37-151" href="#__codelineno-37-151"></a>                            <span class="c1"># Reset retry_count, update last_success</span>
<a id="__codelineno-37-152" name="__codelineno-37-152" href="#__codelineno-37-152"></a>                            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-37-153" name="__codelineno-37-153" href="#__codelineno-37-153"></a><span class="s2">                                UPDATE kg_api.scheduled_jobs</span>
<a id="__codelineno-37-154" name="__codelineno-37-154" href="#__codelineno-37-154"></a><span class="s2">                                SET last_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-155" name="__codelineno-37-155" href="#__codelineno-37-155"></a><span class="s2">                                    last_success = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-156" name="__codelineno-37-156" href="#__codelineno-37-156"></a><span class="s2">                                    next_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-157" name="__codelineno-37-157" href="#__codelineno-37-157"></a><span class="s2">                                    retry_count = 0</span>
<a id="__codelineno-37-158" name="__codelineno-37-158" href="#__codelineno-37-158"></a><span class="s2">                                WHERE id = </span><span class="si">%s</span>
<a id="__codelineno-37-159" name="__codelineno-37-159" href="#__codelineno-37-159"></a><span class="s2">                            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">next_next_run</span><span class="p">,</span> <span class="n">schedule_id</span><span class="p">))</span>
<a id="__codelineno-37-160" name="__codelineno-37-160" href="#__codelineno-37-160"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Schedule &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; triggered job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-37-161" name="__codelineno-37-161" href="#__codelineno-37-161"></a>
<a id="__codelineno-37-162" name="__codelineno-37-162" href="#__codelineno-37-162"></a>                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">launch_failed</span><span class="p">:</span>
<a id="__codelineno-37-163" name="__codelineno-37-163" href="#__codelineno-37-163"></a>                            <span class="c1"># Outcome 2: Normal skip - Conditions not met</span>
<a id="__codelineno-37-164" name="__codelineno-37-164" href="#__codelineno-37-164"></a>                            <span class="c1"># This is healthy, reset retry_count, advance schedule</span>
<a id="__codelineno-37-165" name="__codelineno-37-165" href="#__codelineno-37-165"></a>                            <span class="c1"># Don&#39;t update last_success (no job ran)</span>
<a id="__codelineno-37-166" name="__codelineno-37-166" href="#__codelineno-37-166"></a>                            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-37-167" name="__codelineno-37-167" href="#__codelineno-37-167"></a><span class="s2">                                UPDATE kg_api.scheduled_jobs</span>
<a id="__codelineno-37-168" name="__codelineno-37-168" href="#__codelineno-37-168"></a><span class="s2">                                SET last_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-169" name="__codelineno-37-169" href="#__codelineno-37-169"></a><span class="s2">                                    next_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-170" name="__codelineno-37-170" href="#__codelineno-37-170"></a><span class="s2">                                    retry_count = 0</span>
<a id="__codelineno-37-171" name="__codelineno-37-171" href="#__codelineno-37-171"></a><span class="s2">                                WHERE id = </span><span class="si">%s</span>
<a id="__codelineno-37-172" name="__codelineno-37-172" href="#__codelineno-37-172"></a><span class="s2">                            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">next_next_run</span><span class="p">,</span> <span class="n">schedule_id</span><span class="p">))</span>
<a id="__codelineno-37-173" name="__codelineno-37-173" href="#__codelineno-37-173"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏭️  Schedule &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; skipped (conditions not met)&quot;</span><span class="p">)</span>
<a id="__codelineno-37-174" name="__codelineno-37-174" href="#__codelineno-37-174"></a>
<a id="__codelineno-37-175" name="__codelineno-37-175" href="#__codelineno-37-175"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-37-176" name="__codelineno-37-176" href="#__codelineno-37-176"></a>                            <span class="c1"># Outcome 3: Launcher failure - Exception raised</span>
<a id="__codelineno-37-177" name="__codelineno-37-177" href="#__codelineno-37-177"></a>                            <span class="c1"># Increment retry_count, apply exponential backoff</span>
<a id="__codelineno-37-178" name="__codelineno-37-178" href="#__codelineno-37-178"></a>                            <span class="n">new_retry_count</span> <span class="o">=</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-37-179" name="__codelineno-37-179" href="#__codelineno-37-179"></a>
<a id="__codelineno-37-180" name="__codelineno-37-180" href="#__codelineno-37-180"></a>                            <span class="k">if</span> <span class="n">new_retry_count</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
<a id="__codelineno-37-181" name="__codelineno-37-181" href="#__codelineno-37-181"></a>                                <span class="c1"># Max retries exceeded, disable schedule</span>
<a id="__codelineno-37-182" name="__codelineno-37-182" href="#__codelineno-37-182"></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-37-183" name="__codelineno-37-183" href="#__codelineno-37-183"></a>                                    <span class="sa">f</span><span class="s2">&quot;❌ Schedule &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; max retries exceeded, disabling&quot;</span>
<a id="__codelineno-37-184" name="__codelineno-37-184" href="#__codelineno-37-184"></a>                                <span class="p">)</span>
<a id="__codelineno-37-185" name="__codelineno-37-185" href="#__codelineno-37-185"></a>                                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-37-186" name="__codelineno-37-186" href="#__codelineno-37-186"></a><span class="s2">                                    UPDATE kg_api.scheduled_jobs</span>
<a id="__codelineno-37-187" name="__codelineno-37-187" href="#__codelineno-37-187"></a><span class="s2">                                    SET last_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-188" name="__codelineno-37-188" href="#__codelineno-37-188"></a><span class="s2">                                        last_failure = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-189" name="__codelineno-37-189" href="#__codelineno-37-189"></a><span class="s2">                                        retry_count = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-190" name="__codelineno-37-190" href="#__codelineno-37-190"></a><span class="s2">                                        enabled = FALSE</span>
<a id="__codelineno-37-191" name="__codelineno-37-191" href="#__codelineno-37-191"></a><span class="s2">                                    WHERE id = </span><span class="si">%s</span>
<a id="__codelineno-37-192" name="__codelineno-37-192" href="#__codelineno-37-192"></a><span class="s2">                                &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">new_retry_count</span><span class="p">,</span> <span class="n">schedule_id</span><span class="p">))</span>
<a id="__codelineno-37-193" name="__codelineno-37-193" href="#__codelineno-37-193"></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-37-194" name="__codelineno-37-194" href="#__codelineno-37-194"></a>                                <span class="c1"># Exponential backoff: retry sooner</span>
<a id="__codelineno-37-195" name="__codelineno-37-195" href="#__codelineno-37-195"></a>                                <span class="n">backoff_minutes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">new_retry_count</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-37-196" name="__codelineno-37-196" href="#__codelineno-37-196"></a>                                <span class="n">retry_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">backoff_minutes</span><span class="p">)</span>
<a id="__codelineno-37-197" name="__codelineno-37-197" href="#__codelineno-37-197"></a>
<a id="__codelineno-37-198" name="__codelineno-37-198" href="#__codelineno-37-198"></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-37-199" name="__codelineno-37-199" href="#__codelineno-37-199"></a>                                    <span class="sa">f</span><span class="s2">&quot;⚠️  Schedule &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; failed (retry </span><span class="si">{</span><span class="n">new_retry_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">), &quot;</span>
<a id="__codelineno-37-200" name="__codelineno-37-200" href="#__codelineno-37-200"></a>                                    <span class="sa">f</span><span class="s2">&quot;retrying in </span><span class="si">{</span><span class="n">backoff_minutes</span><span class="si">}</span><span class="s2">min&quot;</span>
<a id="__codelineno-37-201" name="__codelineno-37-201" href="#__codelineno-37-201"></a>                                <span class="p">)</span>
<a id="__codelineno-37-202" name="__codelineno-37-202" href="#__codelineno-37-202"></a>                                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-37-203" name="__codelineno-37-203" href="#__codelineno-37-203"></a><span class="s2">                                    UPDATE kg_api.scheduled_jobs</span>
<a id="__codelineno-37-204" name="__codelineno-37-204" href="#__codelineno-37-204"></a><span class="s2">                                    SET last_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-205" name="__codelineno-37-205" href="#__codelineno-37-205"></a><span class="s2">                                        last_failure = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-206" name="__codelineno-37-206" href="#__codelineno-37-206"></a><span class="s2">                                        next_run = </span><span class="si">%s</span><span class="s2">,</span>
<a id="__codelineno-37-207" name="__codelineno-37-207" href="#__codelineno-37-207"></a><span class="s2">                                        retry_count = </span><span class="si">%s</span>
<a id="__codelineno-37-208" name="__codelineno-37-208" href="#__codelineno-37-208"></a><span class="s2">                                    WHERE id = </span><span class="si">%s</span>
<a id="__codelineno-37-209" name="__codelineno-37-209" href="#__codelineno-37-209"></a><span class="s2">                                &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">retry_time</span><span class="p">,</span> <span class="n">new_retry_count</span><span class="p">,</span> <span class="n">schedule_id</span><span class="p">))</span>
<a id="__codelineno-37-210" name="__codelineno-37-210" href="#__codelineno-37-210"></a>
<a id="__codelineno-37-211" name="__codelineno-37-211" href="#__codelineno-37-211"></a>                        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-37-212" name="__codelineno-37-212" href="#__codelineno-37-212"></a>
<a id="__codelineno-37-213" name="__codelineno-37-213" href="#__codelineno-37-213"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-37-214" name="__codelineno-37-214" href="#__codelineno-37-214"></a>            <span class="c1"># --- MULTI-WORKER SAFETY ---</span>
<a id="__codelineno-37-215" name="__codelineno-37-215" href="#__codelineno-37-215"></a>            <span class="c1"># Always release the advisory lock, even if we failed.</span>
<a id="__codelineno-37-216" name="__codelineno-37-216" href="#__codelineno-37-216"></a>            <span class="c1"># This allows another worker to take over on the next 60s poll.</span>
<a id="__codelineno-37-217" name="__codelineno-37-217" href="#__codelineno-37-217"></a>            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
<a id="__codelineno-37-218" name="__codelineno-37-218" href="#__codelineno-37-218"></a>                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT pg_advisory_unlock(1050)&quot;</span><span class="p">)</span>
<a id="__codelineno-37-219" name="__codelineno-37-219" href="#__codelineno-37-219"></a>            <span class="c1"># --- END MULTI-WORKER SAFETY ---</span>
<a id="__codelineno-37-220" name="__codelineno-37-220" href="#__codelineno-37-220"></a>            <span class="n">client</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">putconn</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</code></pre></div>
<h4 id="3-job-launcher-base-class">3. Job Launcher Base Class</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># src/api/launchers/base.py</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">JobLauncher</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="sd">    Base class for scheduled job launchers.</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="sd">    Launchers are lightweight &quot;sequencers&quot; that:</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="sd">    1. Check if conditions are met to run a job</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="sd">    2. Prepare job_data for the worker</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="sd">    3. Enqueue job to existing job queue</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="sd">    The existing job queue handles execution, progress, approval, etc.</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_queue</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="n">job_queue</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
<a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a>
<a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a><span class="sd">        Check if conditions are met to run this job.</span>
<a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a>
<a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a><span class="sd">        Returns:</span>
<a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a><span class="sd">            True if job should run, False to skip</span>
<a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a>
<a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a><span class="sd">        Example:</span>
<a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a><span class="sd">            - Check if there are llm_generated categories</span>
<a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a><span class="sd">            - Check if vocabulary spread exceeds threshold</span>
<a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a>        <span class="k">pass</span>
<a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a>
<a id="__codelineno-38-39" name="__codelineno-38-39" href="#__codelineno-38-39"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-38-40" name="__codelineno-38-40" href="#__codelineno-38-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_job_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-38-41" name="__codelineno-38-41" href="#__codelineno-38-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-38-42" name="__codelineno-38-42" href="#__codelineno-38-42"></a><span class="sd">        Prepare job_data dict for the worker function.</span>
<a id="__codelineno-38-43" name="__codelineno-38-43" href="#__codelineno-38-43"></a>
<a id="__codelineno-38-44" name="__codelineno-38-44" href="#__codelineno-38-44"></a><span class="sd">        Returns:</span>
<a id="__codelineno-38-45" name="__codelineno-38-45" href="#__codelineno-38-45"></a><span class="sd">            Dict with parameters for the worker</span>
<a id="__codelineno-38-46" name="__codelineno-38-46" href="#__codelineno-38-46"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-38-47" name="__codelineno-38-47" href="#__codelineno-38-47"></a>        <span class="k">pass</span>
<a id="__codelineno-38-48" name="__codelineno-38-48" href="#__codelineno-38-48"></a>
<a id="__codelineno-38-49" name="__codelineno-38-49" href="#__codelineno-38-49"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-38-50" name="__codelineno-38-50" href="#__codelineno-38-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_job_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-38-51" name="__codelineno-38-51" href="#__codelineno-38-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-38-52" name="__codelineno-38-52" href="#__codelineno-38-52"></a><span class="sd">        Return the job type for worker registry lookup.</span>
<a id="__codelineno-38-53" name="__codelineno-38-53" href="#__codelineno-38-53"></a>
<a id="__codelineno-38-54" name="__codelineno-38-54" href="#__codelineno-38-54"></a><span class="sd">        Returns:</span>
<a id="__codelineno-38-55" name="__codelineno-38-55" href="#__codelineno-38-55"></a><span class="sd">            Job type string (e.g., &quot;vocab_refresh&quot;, &quot;vocab_consolidate&quot;)</span>
<a id="__codelineno-38-56" name="__codelineno-38-56" href="#__codelineno-38-56"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-38-57" name="__codelineno-38-57" href="#__codelineno-38-57"></a>        <span class="k">pass</span>
<a id="__codelineno-38-58" name="__codelineno-38-58" href="#__codelineno-38-58"></a>
<a id="__codelineno-38-59" name="__codelineno-38-59" href="#__codelineno-38-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-38-60" name="__codelineno-38-60" href="#__codelineno-38-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-38-61" name="__codelineno-38-61" href="#__codelineno-38-61"></a><span class="sd">        Execute the launcher: check conditions, prepare data, enqueue job.</span>
<a id="__codelineno-38-62" name="__codelineno-38-62" href="#__codelineno-38-62"></a>
<a id="__codelineno-38-63" name="__codelineno-38-63" href="#__codelineno-38-63"></a><span class="sd">        Returns:</span>
<a id="__codelineno-38-64" name="__codelineno-38-64" href="#__codelineno-38-64"></a><span class="sd">            job_id if enqueued, None if conditions not met (normal skip).</span>
<a id="__codelineno-38-65" name="__codelineno-38-65" href="#__codelineno-38-65"></a>
<a id="__codelineno-38-66" name="__codelineno-38-66" href="#__codelineno-38-66"></a><span class="sd">        Raises:</span>
<a id="__codelineno-38-67" name="__codelineno-38-67" href="#__codelineno-38-67"></a><span class="sd">            Exception: If condition check, data prep, or enqueueing fails.</span>
<a id="__codelineno-38-68" name="__codelineno-38-68" href="#__codelineno-38-68"></a>
<a id="__codelineno-38-69" name="__codelineno-38-69" href="#__codelineno-38-69"></a><span class="sd">        Important: A return value of None means &quot;conditions not met, this is</span>
<a id="__codelineno-38-70" name="__codelineno-38-70" href="#__codelineno-38-70"></a><span class="sd">        normal, don&#39;t treat as failure.&quot; Any actual failure should raise an</span>
<a id="__codelineno-38-71" name="__codelineno-38-71" href="#__codelineno-38-71"></a><span class="sd">        exception so the scheduler can distinguish:</span>
<a id="__codelineno-38-72" name="__codelineno-38-72" href="#__codelineno-38-72"></a><span class="sd">            - Success (job_id returned) → Reset retry_count</span>
<a id="__codelineno-38-73" name="__codelineno-38-73" href="#__codelineno-38-73"></a><span class="sd">            - Skip (None returned) → Reset retry_count, advance schedule</span>
<a id="__codelineno-38-74" name="__codelineno-38-74" href="#__codelineno-38-74"></a><span class="sd">            - Failure (exception raised) → Increment retry_count, backoff</span>
<a id="__codelineno-38-75" name="__codelineno-38-75" href="#__codelineno-38-75"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-38-76" name="__codelineno-38-76" href="#__codelineno-38-76"></a>        <span class="c1"># Let exceptions bubble up - scheduler handles them</span>
<a id="__codelineno-38-77" name="__codelineno-38-77" href="#__codelineno-38-77"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_conditions</span><span class="p">():</span>
<a id="__codelineno-38-78" name="__codelineno-38-78" href="#__codelineno-38-78"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏭️  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Conditions not met, skipping&quot;</span><span class="p">)</span>
<a id="__codelineno-38-79" name="__codelineno-38-79" href="#__codelineno-38-79"></a>            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Normal skip, not a failure</span>
<a id="__codelineno-38-80" name="__codelineno-38-80" href="#__codelineno-38-80"></a>
<a id="__codelineno-38-81" name="__codelineno-38-81" href="#__codelineno-38-81"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Conditions met, preparing job&quot;</span><span class="p">)</span>
<a id="__codelineno-38-82" name="__codelineno-38-82" href="#__codelineno-38-82"></a>
<a id="__codelineno-38-83" name="__codelineno-38-83" href="#__codelineno-38-83"></a>        <span class="c1"># Let exceptions bubble up</span>
<a id="__codelineno-38-84" name="__codelineno-38-84" href="#__codelineno-38-84"></a>        <span class="n">job_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_job_data</span><span class="p">()</span>
<a id="__codelineno-38-85" name="__codelineno-38-85" href="#__codelineno-38-85"></a>
<a id="__codelineno-38-86" name="__codelineno-38-86" href="#__codelineno-38-86"></a>        <span class="c1"># Let exceptions bubble up</span>
<a id="__codelineno-38-87" name="__codelineno-38-87" href="#__codelineno-38-87"></a>        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
<a id="__codelineno-38-88" name="__codelineno-38-88" href="#__codelineno-38-88"></a>            <span class="n">job_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_job_type</span><span class="p">(),</span>
<a id="__codelineno-38-89" name="__codelineno-38-89" href="#__codelineno-38-89"></a>            <span class="n">job_data</span><span class="o">=</span><span class="n">job_data</span>
<a id="__codelineno-38-90" name="__codelineno-38-90" href="#__codelineno-38-90"></a>        <span class="p">)</span>
<a id="__codelineno-38-91" name="__codelineno-38-91" href="#__codelineno-38-91"></a>
<a id="__codelineno-38-92" name="__codelineno-38-92" href="#__codelineno-38-92"></a>        <span class="c1"># Mark as system job</span>
<a id="__codelineno-38-93" name="__codelineno-38-93" href="#__codelineno-38-93"></a>        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
<a id="__codelineno-38-94" name="__codelineno-38-94" href="#__codelineno-38-94"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">update_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-38-95" name="__codelineno-38-95" href="#__codelineno-38-95"></a>                <span class="s2">&quot;is_system_job&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-38-96" name="__codelineno-38-96" href="#__codelineno-38-96"></a>                <span class="s2">&quot;job_source&quot;</span><span class="p">:</span> <span class="s2">&quot;scheduled_task&quot;</span><span class="p">,</span>
<a id="__codelineno-38-97" name="__codelineno-38-97" href="#__codelineno-38-97"></a>                <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;system:scheduler:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-38-98" name="__codelineno-38-98" href="#__codelineno-38-98"></a>            <span class="p">})</span>
<a id="__codelineno-38-99" name="__codelineno-38-99" href="#__codelineno-38-99"></a>
<a id="__codelineno-38-100" name="__codelineno-38-100" href="#__codelineno-38-100"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Enqueued job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-38-101" name="__codelineno-38-101" href="#__codelineno-38-101"></a>        <span class="k">return</span> <span class="n">job_id</span>
</code></pre></div>
<h4 id="4-example-launchers">4. Example Launchers</h4>
<p><strong>Category Refresh Launcher:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># src/api/launchers/category_refresh.py</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">JobLauncher</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.api.lib.age_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">AGEClient</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CategoryRefreshLauncher</span><span class="p">(</span><span class="n">JobLauncher</span><span class="p">):</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="sd">    Automatically refresh vocabulary categories with llm_generated entries.</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="sd">    Checks: Are there categories with &quot;llm_generated&quot; that need re-integration?</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="sd">    Worker: vocab_refresh_worker</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="sd">    Schedule: Every 6 hours</span>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if any categories have llm_generated entries&quot;&quot;&quot;</span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">AGEClient</span><span class="p">()</span>
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a>        <span class="n">categories</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_vocabulary_categories</span><span class="p">()</span>
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a>
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a>            <span class="k">if</span> <span class="s1">&#39;llm_generated&#39;</span> <span class="ow">in</span> <span class="n">category</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relationship_types&#39;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a>
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_job_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare data for vocab refresh worker&quot;&quot;&quot;</span>
<a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a>            <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh_categories&quot;</span><span class="p">,</span>
<a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a>            <span class="s2">&quot;auto_mode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a>            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="s2">&quot;llm_generated&quot;</span>
<a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a>        <span class="p">}</span>
<a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a>
<a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_job_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a>        <span class="k">return</span> <span class="s2">&quot;vocab_refresh&quot;</span>
</code></pre></div></p>
<p><strong>Vocabulary Consolidation Launcher:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1"># src/api/launchers/vocab_consolidation.py</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">JobLauncher</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.api.lib.age_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">AGEClient</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">VocabConsolidationLauncher</span><span class="p">(</span><span class="n">JobLauncher</span><span class="p">):</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="sd">    Automatically consolidate vocabulary based on hysteresis curve.</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="sd">    Checks: Does vocab spread exceed consolidation threshold?</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="sd">    Worker: vocab_consolidate_worker</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="sd">    Schedule: Every 12 hours</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if vocabulary spread exceeds consolidation threshold&quot;&quot;&quot;</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">AGEClient</span><span class="p">()</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_vocabulary_stats</span><span class="p">()</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>        <span class="n">total_types</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_types&#39;</span><span class="p">]</span>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a>        <span class="n">active_types</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;active_types&#39;</span><span class="p">]</span>
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a>        <span class="n">inactive_types</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inactive_types&#39;</span><span class="p">]</span>
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a>
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a>        <span class="c1"># Hysteresis thresholds:</span>
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a>        <span class="c1"># - Consolidate when active &gt; 50 and inactive &gt; 20% of active</span>
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a>        <span class="c1"># - Don&#39;t consolidate if inactive &lt; 10% of active (avoid thrashing)</span>
<a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a>
<a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a>        <span class="k">if</span> <span class="n">active_types</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
<a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a>            <span class="n">inactive_ratio</span> <span class="o">=</span> <span class="n">inactive_types</span> <span class="o">/</span> <span class="n">active_types</span>
<a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a>
<a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a>            <span class="c1"># Upper threshold: consolidate</span>
<a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a>            <span class="k">if</span> <span class="n">inactive_ratio</span> <span class="o">&gt;</span> <span class="mf">0.20</span><span class="p">:</span>
<a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a>                    <span class="sa">f</span><span class="s2">&quot;✓ Consolidation threshold exceeded: &quot;</span>
<a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inactive_types</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">active_types</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">inactive_ratio</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> &gt; 20%&quot;</span>
<a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a>                <span class="p">)</span>
<a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a>
<a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a>            <span class="c1"># Lower threshold: prevent thrashing</span>
<a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a>            <span class="k">if</span> <span class="n">inactive_ratio</span> <span class="o">&lt;</span> <span class="mf">0.10</span><span class="p">:</span>
<a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a>                    <span class="sa">f</span><span class="s2">&quot;⏭️  Consolidation threshold not reached: &quot;</span>
<a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inactive_types</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">active_types</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">inactive_ratio</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> &lt; 10% (hysteresis)&quot;</span>
<a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a>                <span class="p">)</span>
<a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a>
<a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-40-52" name="__codelineno-40-52" href="#__codelineno-40-52"></a>
<a id="__codelineno-40-53" name="__codelineno-40-53" href="#__codelineno-40-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_job_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-40-54" name="__codelineno-40-54" href="#__codelineno-40-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare data for vocab consolidation worker&quot;&quot;&quot;</span>
<a id="__codelineno-40-55" name="__codelineno-40-55" href="#__codelineno-40-55"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-40-56" name="__codelineno-40-56" href="#__codelineno-40-56"></a>            <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;consolidate&quot;</span><span class="p">,</span>
<a id="__codelineno-40-57" name="__codelineno-40-57" href="#__codelineno-40-57"></a>            <span class="s2">&quot;auto_mode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-40-58" name="__codelineno-40-58" href="#__codelineno-40-58"></a>            <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;hysteresis&quot;</span>
<a id="__codelineno-40-59" name="__codelineno-40-59" href="#__codelineno-40-59"></a>        <span class="p">}</span>
<a id="__codelineno-40-60" name="__codelineno-40-60" href="#__codelineno-40-60"></a>
<a id="__codelineno-40-61" name="__codelineno-40-61" href="#__codelineno-40-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_job_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-40-62" name="__codelineno-40-62" href="#__codelineno-40-62"></a>        <span class="k">return</span> <span class="s2">&quot;vocab_consolidate&quot;</span>
</code></pre></div></p>
<h4 id="5-fastapi-integration">5. FastAPI Integration</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1"># In src/api/main.py</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.api.services.scheduler</span><span class="w"> </span><span class="kn">import</span> <span class="n">JobScheduler</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.api.launchers.category_refresh</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoryRefreshLauncher</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.api.launchers.vocab_consolidation</span><span class="w"> </span><span class="kn">import</span> <span class="n">VocabConsolidationLauncher</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="c1"># At startup</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup_event</span><span class="p">():</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>    <span class="c1"># Initialize existing job queue (unchanged)</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>    <span class="k">global</span> <span class="n">queue</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>    <span class="n">queue</span> <span class="o">=</span> <span class="n">init_job_queue</span><span class="p">()</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>    <span class="c1"># Register existing workers (unchanged)</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a>    <span class="n">queue</span><span class="o">.</span><span class="n">register_worker</span><span class="p">(</span><span class="s2">&quot;ingestion&quot;</span><span class="p">,</span> <span class="n">run_ingestion_worker</span><span class="p">)</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>    <span class="n">queue</span><span class="o">.</span><span class="n">register_worker</span><span class="p">(</span><span class="s2">&quot;restore&quot;</span><span class="p">,</span> <span class="n">run_restore_worker</span><span class="p">)</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>    <span class="c1"># Register NEW vocab workers</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>    <span class="n">queue</span><span class="o">.</span><span class="n">register_worker</span><span class="p">(</span><span class="s2">&quot;vocab_refresh&quot;</span><span class="p">,</span> <span class="n">run_vocab_refresh_worker</span><span class="p">)</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>    <span class="n">queue</span><span class="o">.</span><span class="n">register_worker</span><span class="p">(</span><span class="s2">&quot;vocab_consolidate&quot;</span><span class="p">,</span> <span class="n">run_vocab_consolidate_worker</span><span class="p">)</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>    <span class="c1"># Create launcher registry</span>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a>    <span class="n">launcher_registry</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a>        <span class="s1">&#39;CategoryRefreshLauncher&#39;</span><span class="p">:</span> <span class="n">CategoryRefreshLauncher</span><span class="p">,</span>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a>        <span class="s1">&#39;VocabConsolidationLauncher&#39;</span><span class="p">:</span> <span class="n">VocabConsolidationLauncher</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a>    <span class="p">}</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>    <span class="c1"># Start scheduler</span>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a>    <span class="k">global</span> <span class="n">scheduler</span>
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a>    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">JobScheduler</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">launcher_registry</span><span class="p">)</span>
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a>    <span class="k">await</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ Scheduled jobs initialized&quot;</span><span class="p">)</span>
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a>
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a><span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;shutdown&quot;</span><span class="p">)</span>
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown_event</span><span class="p">():</span>
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a>    <span class="c1"># Stop scheduler</span>
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a>    <span class="k">await</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>
<h2 id="production-deployment-considerations">Production Deployment Considerations</h2>
<h3 id="multi-worker-safety-critical">Multi-Worker Safety (Critical)</h3>
<p><strong>Problem:</strong> In production, FastAPI runs with multiple Gunicorn workers:
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>gunicorn<span class="w"> </span>-w<span class="w"> </span><span class="m">4</span><span class="w"> </span>-k<span class="w"> </span>uvicorn.workers.UvicornWorker<span class="w"> </span>src.api.main:app
</code></pre></div></p>
<p>Each worker process runs the <code>startup_event</code>, creating <strong>N separate scheduler loops</strong>. Without coordination, all N schedulers will check schedules simultaneously, causing <strong>duplicate job creation</strong>.</p>
<p><strong>Example (without advisory lock):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>2025-10-29 00:00:00 - Worker 1: Schedule &#39;category_refresh&#39; due → Enqueue job_abc123
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>2025-10-29 00:00:00 - Worker 2: Schedule &#39;category_refresh&#39; due → Enqueue job_abc456
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>2025-10-29 00:00:00 - Worker 3: Schedule &#39;category_refresh&#39; due → Enqueue job_abc789
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>2025-10-29 00:00:00 - Worker 4: Schedule &#39;category_refresh&#39; due → Enqueue job_abcXYZ
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>Result: 4 identical jobs instead of 1 ❌
</code></pre></div></p>
<p><strong>Solution: PostgreSQL Advisory Locks</strong></p>
<p>Advisory locks are lightweight, session-level locks that coordinate across processes:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1"># In _check_schedules():</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT pg_try_advisory_lock(1050)&quot;</span><span class="p">)</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="n">got_lock</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">got_lock</span><span class="p">:</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    <span class="c1"># Another worker is handling schedules, skip</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    <span class="k">return</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="c1"># Only one worker reaches here</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="c1"># ... trigger launchers ...</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="c1"># Always release lock in finally block</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT pg_advisory_unlock(1050)&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>How it works:</strong>
- Lock key <code>1050</code> is unique to the scheduler (arbitrary integer)
- <code>pg_try_advisory_lock()</code> is <strong>non-blocking</strong> - returns immediately
- Only one process across all workers can hold the lock
- Other workers see <code>got_lock=False</code> and skip the check cycle
- Lock auto-releases on connection close (failsafe)</p>
<p><strong>Benefits:</strong>
- ✅ No external coordination service (Redis, ZooKeeper)
- ✅ No database table contention
- ✅ Automatic failover (if lock holder crashes, next worker takes over)
- ✅ Zero configuration required</p>
<p><strong>Testing multi-worker safety:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># Start with 4 workers</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>gunicorn<span class="w"> </span>-w<span class="w"> </span><span class="m">4</span><span class="w"> </span>-k<span class="w"> </span>uvicorn.workers.UvicornWorker<span class="w"> </span>src.api.main:app
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="c1"># Watch logs - you should see only ONE worker per minute logging:</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="c1"># &quot;Acquired scheduler lock, proceeding with schedule check&quot;</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="c1"># Other 3 workers: &quot;Scheduler lock held by another worker, skipping check cycle&quot;</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="c1"># Verify only ONE job created per schedule trigger</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w"> </span>--limit<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>category_refresh
</code></pre></div></p>
<h3 id="distinguishing-skip-from-failure-critical">Distinguishing Skip from Failure (Critical)</h3>
<p><strong>Problem:</strong> The launcher returns <code>None</code> in two very different scenarios:
1. <strong>Normal skip</strong>: Conditions not met (healthy, expected)
2. <strong>Actual failure</strong>: Exception during condition check or enqueueing (needs retry)</p>
<p>Treating both as "failure" causes schedules to get disabled after 5 normal skips.</p>
<p><strong>Solution: Three-Outcome Pattern</strong></p>
<p>Launcher returns three possible outcomes:
- <code>job_id</code> → Success (job enqueued)
- <code>None</code> → Skip (conditions not met, normal)
- <code>Exception</code> → Failure (needs retry/backoff)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># Launcher.launch() - Let exceptions bubble up</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_conditions</span><span class="p">():</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Normal skip, not a failure</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>    <span class="n">job_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_job_data</span><span class="p">()</span>  <span class="c1"># Raises on failure</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>    <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># Raises on failure</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="k">return</span> <span class="n">job_id</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="c1"># Scheduler._check_schedules() - Handle three outcomes</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>    <span class="n">job_id</span> <span class="o">=</span> <span class="n">launcher</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>    <span class="n">launch_failed</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>    <span class="c1"># Success: reset retry_count, update last_success</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="k">elif</span> <span class="ow">not</span> <span class="n">launch_failed</span><span class="p">:</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>    <span class="c1"># Skip: reset retry_count, advance schedule (DON&#39;T increment retries!)</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>    <span class="c1"># Failure: increment retry_count, exponential backoff</span>
</code></pre></div>
<p><strong>Why this matters:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>Without fix:
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>  00:00 ⏭️  Skip (conditions not met) → retry_count = 1
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>  06:00 ⏭️  Skip (conditions not met) → retry_count = 2
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>  12:00 ⏭️  Skip (conditions not met) → retry_count = 3
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>  18:00 ⏭️  Skip (conditions not met) → retry_count = 4
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>  24:00 ⏭️  Skip (conditions not met) → retry_count = 5
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>  30:00 ❌  Schedule disabled (max retries) - WRONG!
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>With fix:
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>  00:00 ⏭️  Skip (conditions not met) → retry_count = 0 ✅
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>  06:00 ⏭️  Skip (conditions not met) → retry_count = 0 ✅
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>  48:00 ✅  Success (conditions met) → retry_count = 0 ✅
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>  Schedule stays healthy ✅
</code></pre></div></p>
<h3 id="monitoring-requirements">Monitoring Requirements</h3>
<p><strong>Key metrics to track:</strong>
- Scheduler lock acquisition rate (should be ~60 locks/hour = 1 per minute)
- Schedule success rate (last_success vs last_failure)
- Skip vs failure ratio (high skip rate is normal for polling pattern)
- Job queue depth (scheduled jobs vs manual jobs)</p>
<p><strong>Log patterns to watch:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>✅ Good: Multiple workers, one active scheduler
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>Worker 1: &quot;Acquired scheduler lock, proceeding...&quot;
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>Worker 2: &quot;Scheduler lock held by another worker, skipping&quot;
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>Worker 3: &quot;Scheduler lock held by another worker, skipping&quot;
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>Worker 4: &quot;Scheduler lock held by another worker, skipping&quot;
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>❌ Bad: All workers acquiring lock (advisory lock not working)
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>Worker 1: &quot;Acquired scheduler lock...&quot;
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>Worker 2: &quot;Acquired scheduler lock...&quot;  ← PROBLEM!
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>Worker 3: &quot;Acquired scheduler lock...&quot;  ← PROBLEM!
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>Worker 4: &quot;Acquired scheduler lock...&quot;  ← PROBLEM!
</code></pre></div></p>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<p><strong>Minimal Changes:</strong>
- ✅ Zero changes to existing job queue
- ✅ Zero changes to existing workers
- ✅ Zero changes to approval workflow
- ✅ Just add: scheduler loop + launchers</p>
<p><strong>No External Dependencies:</strong>
- ✅ No APScheduler, Celery, Redis, RabbitMQ
- ✅ Just Python stdlib (asyncio) + croniter (cron parsing)
- ✅ One new table: <code>kg_api.scheduled_jobs</code></p>
<p><strong>Consistency:</strong>
- ✅ Scheduled jobs use same queue as manual jobs
- ✅ Same workers, same progress tracking, same SSE streaming
- ✅ Same approval workflow (if needed)</p>
<p><strong>Simple to Understand:</strong>
- ✅ Clear separation: Scheduler (timing) → Launcher (conditions) → Queue (execution)
- ✅ Easy to add new scheduled jobs (create launcher, add to registry)
- ✅ Easy to debug (check schedule table, launcher logs)</p>
<h3 id="negative">Negative</h3>
<p><strong>Custom Code:</strong>
- ❌ We maintain the scheduler loop (but it's simple)
- ❌ Not battle-tested like APScheduler (but we control it)</p>
<p><strong>Cron Parsing:</strong>
- ❌ Need croniter library for cron expressions
- ❌ Could use simple intervals instead (every 6 hours = <code>schedule_interval_seconds</code>)</p>
<p><strong>Monitoring:</strong>
- ❌ Need to monitor scheduler health (is the loop running?)
- ❌ Need to track schedule failures (last_success, last_failure)</p>
<p><strong>Multi-Worker Coordination:</strong>
- ❌ Requires advisory locks in multi-worker deployments (but simple to implement)
- ❌ Single point of failure in scheduler loop (but auto-recovers via lock failover)</p>
<h2 id="alternatives-considered">Alternatives Considered</h2>
<h3 id="option-a-apscheduler">Option A: APScheduler</h3>
<p><strong>Pros:</strong>
- Battle-tested, mature
- Many features (persistent, distributed, etc.)</p>
<p><strong>Cons:</strong>
- External dependency
- Would still need launcher abstraction
- More complex than needed</p>
<p><strong>Decision:</strong> Rejected - Unnecessary dependency</p>
<h3 id="option-b-system-cron">Option B: System Cron</h3>
<p><strong>Pros:</strong>
- Dead simple
- OS-level</p>
<p><strong>Cons:</strong>
- No integration with job queue
- No condition checks
- No exponential backoff
- Must configure on every server</p>
<p><strong>Decision:</strong> Rejected - Not integrated with our system</p>
<h2 id="implementation-plan">Implementation Plan</h2>
<h3 id="phase-1-foundation-week-1">Phase 1: Foundation (Week 1)</h3>
<ul>
<li>[ ] Add croniter dependency</li>
<li>[ ] Create migration 019 (scheduled_jobs table)</li>
<li>[ ] Implement JobScheduler class</li>
<li>[ ] Implement JobLauncher base class</li>
<li>[ ] Integrate with FastAPI lifecycle</li>
</ul>
<h3 id="phase-2-first-launcher-week-2">Phase 2: First Launcher (Week 2)</h3>
<ul>
<li>[ ] Implement CategoryRefreshLauncher</li>
<li>[ ] Implement vocab_refresh_worker</li>
<li>[ ] Register worker in main.py</li>
<li>[ ] Test with manual schedule trigger</li>
<li>[ ] Monitor logs for condition checks</li>
</ul>
<h3 id="phase-3-second-launcher-week-3">Phase 3: Second Launcher (Week 3)</h3>
<ul>
<li>[ ] Implement VocabConsolidationLauncher</li>
<li>[ ] Implement vocab_consolidate_worker</li>
<li>[ ] Register worker in main.py</li>
<li>[ ] Tune hysteresis thresholds</li>
<li>[ ] Test with production data</li>
</ul>
<h3 id="phase-4-monitoring-api-week-4">Phase 4: Monitoring &amp; API (Week 4)</h3>
<ul>
<li>[ ] Add scheduled job endpoints (list, enable, disable, trigger)</li>
<li>[ ] Add CLI commands (<code>kg admin scheduled list</code>, <code>kg admin scheduled trigger</code>)</li>
<li>[ ] Add logging and metrics</li>
<li>[ ] Document in user guide</li>
</ul>
<h2 id="testing-strategy">Testing Strategy</h2>
<h3 id="unit-tests">Unit Tests</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_category_refresh_launcher_conditions</span><span class="p">():</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test condition checking logic&quot;&quot;&quot;</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">launcher</span> <span class="o">=</span> <span class="n">CategoryRefreshLauncher</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="c1"># Mock AGE client to return categories with llm_generated</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="k">assert</span> <span class="n">launcher</span><span class="o">.</span><span class="n">check_conditions</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_scheduler_loop_fires_launcher</span><span class="p">():</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test scheduler triggers launcher at scheduled time&quot;&quot;&quot;</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>    <span class="c1"># Mock schedule that&#39;s due now</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>    <span class="c1"># Verify launcher.launch() called</span>
</code></pre></div>
<h3 id="integration-tests">Integration Tests</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_scheduled_job_end_to_end</span><span class="p">():</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test full scheduled job flow&quot;&quot;&quot;</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>    <span class="c1"># 1. Insert schedule with past next_run</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>    <span class="c1"># 2. Run scheduler._check_schedules()</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>    <span class="c1"># 3. Verify job enqueued</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="c1"># 4. Verify schedule updated</span>
</code></pre></div>
<h3 id="manual-testing">Manual Testing</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># 1. Start API (single worker for initial testing)</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>./scripts/start-api.sh<span class="w"> </span>-y
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="c1"># 2. Check scheduled jobs</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>psql<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT * FROM kg_api.scheduled_jobs&quot;</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="c1"># 3. Manually trigger</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>psql<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;UPDATE kg_api.scheduled_jobs SET next_run = NOW() WHERE name = &#39;category_refresh&#39;&quot;</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="c1"># 4. Watch logs</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>tail<span class="w"> </span>-f<span class="w"> </span>logs/api_*.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;launcher\|schedule&quot;</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="c1"># 5. Verify job created</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w"> </span>--limit<span class="w"> </span><span class="m">5</span>
</code></pre></div>
<h3 id="multi-worker-testing-critical">Multi-Worker Testing (Critical)</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1"># 1. Start API with 4 workers</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>gunicorn<span class="w"> </span>-w<span class="w"> </span><span class="m">4</span><span class="w"> </span>-k<span class="w"> </span>uvicorn.workers.UvicornWorker<span class="w"> </span>src.api.main:app
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="c1"># 2. Watch logs for lock acquisition pattern (should see only ONE worker per minute)</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>tail<span class="w"> </span>-f<span class="w"> </span>logs/api_*.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;scheduler lock&quot;</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="c1"># Expected pattern (repeated every 60 seconds):</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="c1"># Worker 1: &quot;Acquired scheduler lock, proceeding with schedule check&quot;</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="c1"># Worker 2: &quot;Scheduler lock held by another worker, skipping check cycle&quot;</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="c1"># Worker 3: &quot;Scheduler lock held by another worker, skipping check cycle&quot;</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="c1"># Worker 4: &quot;Scheduler lock held by another worker, skipping check cycle&quot;</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="c1"># 3. Trigger a schedule manually</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>psql<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;UPDATE kg_api.scheduled_jobs SET next_run = NOW() WHERE name = &#39;category_refresh&#39;&quot;</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="c1"># 4. Verify only ONE job created (not 4!)</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>kg<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>list<span class="w"> </span>--limit<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>category_refresh
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="c1"># Should show exactly 1 job, not 4</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="c1"># 5. Check advisory lock status in PostgreSQL</span>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>psql<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT * FROM pg_locks WHERE locktype = &#39;advisory&#39;&quot;</span>
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="c1"># Should show lock key 1050 held by one backend process</span>
</code></pre></div>
<h2 id="monitoring">Monitoring</h2>
<p><strong>Key Metrics:</strong>
- Scheduler loop health (last check time)
- Schedule success rate (last_success vs last_failure)
- Launcher condition check frequency (true / false ratio)
- Job queue depth (scheduled jobs vs manual jobs)</p>
<p><strong>Log Examples:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>INFO: ✅ Job scheduler started
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>INFO: ⏰ Schedule &#39;category_refresh&#39; is due, triggering launcher
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>INFO: ✓ CategoryRefreshLauncher: Found category &#39;Temporal Expressions&#39; with llm_generated entries
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>INFO: ✅ CategoryRefreshLauncher: Enqueued job job_abc123
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>INFO: ⏭️  VocabConsolidationLauncher: Conditions not met, skipping (inactive ratio 8% &lt; 10%)
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>WARNING: ⚠️  Schedule &#39;vocab_consolidation&#39; failed (retry 2/5), retrying in 4min
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>ERROR: ❌ Schedule &#39;category_refresh&#39; max retries exceeded, disabling
</code></pre></div></p>
<h2 id="future-enhancements">Future Enhancements</h2>
<h3 id="phase-2-advanced-features">Phase 2: Advanced Features</h3>
<ul>
<li>[ ] Calendar-aware scheduling (skip weekends, holidays)</li>
<li>[ ] Dependency chains (job B after job A completes)</li>
<li>[ ] Dynamic schedule adjustment based on metrics</li>
</ul>
<h3 id="phase-3-distributed-execution">Phase 3: Distributed Execution</h3>
<ul>
<li>[ ] Multi-node scheduler coordination (leader election)</li>
<li>[ ] Distributed schedule locks (prevent duplicate execution)</li>
</ul>
<h3 id="phase-4-machine-learning">Phase 4: Machine Learning</h3>
<ul>
<li>[ ] Predict optimal consolidation timing</li>
<li>[ ] Auto-tune hysteresis thresholds</li>
<li>[ ] Anomaly detection for schedule failures</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><strong>croniter:</strong> https://pypi.org/project/croniter/</li>
<li><strong>ADR-012:</strong> API Server Architecture</li>
<li><strong>ADR-014:</strong> Job Approval Workflow</li>
<li><strong>ADR-049:</strong> Rate Limiting and Per-Provider Concurrency</li>
</ul>
<hr />
<p><strong>Last Updated:</strong> 2025-10-28</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>