
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Multi-dimensional knowledge extraction system using Apache AGE">
      
      
        <meta name="author" content="Knowledge Graph System Contributors">
      
      
      
        <link rel="prev" href="../QUERY_SAFETY_BASELINE/">
      
      
        <link rel="next" href="../visualization/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Knowledge Graph System - Recursive Upsert Architecture - Knowledge Graph System</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#knowledge-graph-system-recursive-upsert-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Knowledge Graph System" class="md-header__button md-logo" aria-label="Knowledge Graph System" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Knowledge Graph System
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Knowledge Graph System - Recursive Upsert Architecture
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/aaronsb/knowledge-graph-system" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    aaronsb/knowledge-graph-system
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Knowledge Graph System" class="md-nav__button md-logo" aria-label="Knowledge Graph System" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Knowledge Graph System
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aaronsb/knowledge-graph-system" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    aaronsb/knowledge-graph-system
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation Index
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/COLD-START/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5-Minute Cold Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/DEPLOYMENT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/VOCABULARY_CATEGORIES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vocabulary Categories
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System Manual
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/00-introduction/01-WHAT_AND_WHY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is the Knowledge Graph System?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/01-getting-started/01-QUICKSTART/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/01-getting-started/02-CLI_USAGE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg CLI Usage Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/01-getting-started/03-INGESTION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Ingestion Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/01-AI_PROVIDERS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Provider Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/02-EXTRACTION_CONFIGURATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Extraction Configuration Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/03-EMBEDDING_CONFIGURATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Embedding Configuration Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/04-SWITCHING_EXTRACTION_PROVIDERS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Switching Extraction Providers - Quick Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/05-LOCAL_INFERENCE_IMPLEMENTATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Local LLM Inference Implementation Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/02-configuration/06-EXTRACTION_QUALITY_COMPARISON/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Extraction Quality Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Integration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Integration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/03-integration/01-MCP_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP Server Setup Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/03-integration/02-VOCABULARY_CONSOLIDATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Edge Vocabulary Consolidation Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Security & Access
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Security & Access
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/01-AUTHENTICATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/02-RBAC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RBAC Operations Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/03-SECURITY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/04-security-and-access/04-PASSWORD_RECOVERY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Password Recovery and Account Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Maintenance
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            Maintenance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/05-maintenance/01-BACKUP_RESTORE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backup and Restore Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/05-maintenance/02-DATABASE_MIGRATIONS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Migrations Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/01-SCHEMA_REFERENCE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PostgreSQL Schema Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/02-USE_CASES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Use Cases: Practical Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/03-EXAMPLES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples: Real Queries, Real Results
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/04-github_project_history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Project History Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/05-CONCEPTS_AND_TERMINOLOGY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concepts and Terminology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/06-CONCEPT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concept: Why Knowledge Graphs, Not Just RAG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/07-ENRICHMENT_JOURNEY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Enrichment Journey: From Empty Graph to Multi-Perspective Understanding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/08-DISTRIBUTED_SHARDING_RESEARCH/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Graph Database Sharding: Research and Architectural Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/09-CYPHER_PATTERNS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Cypher Query Patterns for Apache AGE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/10-OPENCYPHER_QUERIES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    openCypher Query Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/06-reference/11-LLM_EDGE_DISCOVERY_FLOW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Edge Discovery Flow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tool Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tool Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool &amp; API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CLI Commands
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            CLI Commands
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Command Reference (Auto-Generated)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    commands
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            commands
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/admin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg admin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/ingest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg ingest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/ontology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg ontology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/commands/vocabulary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    kg vocabulary
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
        
          
          <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    media
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_3">
            <span class="md-nav__icon md-icon"></span>
            media
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/media/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Media Assets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    MCP Tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            MCP Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP Server Tool Reference (Auto-Generated)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_2" >
        
          
          <label class="md-nav__link" for="__nav_4_3_2" id="__nav_4_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    media
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_2">
            <span class="md-nav__icon md-icon"></span>
            media
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/media/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Media Assets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3_3" id="__nav_4_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_3">
            <span class="md-nav__icon md-icon"></span>
            tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/approve_job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    approve_job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/cancel_job/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cancel_job
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/delete_ontology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    delete_ontology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/find_connection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    find_connection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/find_connection_by_search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    find_connection_by_search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/find_related_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    find_related_concepts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_api_health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_api_health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_concept_details/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_concept_details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_database_health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_database_health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_database_info/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_database_info
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_database_stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_database_stats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_job_status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_job_status
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_ontology_files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_ontology_files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_ontology_info/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_ontology_info
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/get_system_status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_system_status
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/ingest_text/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ingest_text
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/list_jobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    list_jobs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/list_ontologies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    list_ontologies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/mcp/tools/search_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    search_concepts
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    REST API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            REST API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    REST API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-001-multi-tier-agent-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-001: Multi-Tier Agent Access Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-002-node-fitness-scoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-002: Node Fitness Scoring System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-003-semantic-tool-hints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-003: Semantic Tool Hint Networks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-004-pure-graph-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-004: Pure Graph Design (Library Metaphor)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-005-source-text-tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-005: Source Text Tracking and Retrieval
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-006-staging-migration-workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-006: Staging and Migration Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-011-cli-admin-separation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-011: CLI and Admin Tooling Separation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-012-api-server-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-012: API Server Architecture for Scalable Neo4j Access
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-013-unified-typescript-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-013: Unified TypeScript Client (CLI + MCP Server)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-014-job-approval-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-014: Job Approval Workflow with Pre-Ingestion Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-015-backup-restore-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-015: Backup/Restore Streaming Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-016-apache-age-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-016: Apache AGE Migration (Neo4j Replacement)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-017-sensitive-auth-verification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Decision Record: Client-Initiated Token Revocation for Elevated Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-018-server-sent-events-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-018: Server-Sent Events for Real-Time Progress Streaming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-019-type-based-table-formatting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-019: Type-Based Table Formatting System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-020-admin-module-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-020: Admin Module Architecture Pattern
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-021-live-man-switch-ai-safety/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-021: Live Man Switch - AI Safety for Critical Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-022-semantic-relationship-taxonomy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-022: Semantically Sparse 30-Type Relationship Taxonomy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-023-markdown-structured-content-preprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-023: Markdown Structured Content Preprocessing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-024-multi-schema-postgresql-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-024: Multi-Schema PostgreSQL Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-025-dynamic-relationship-vocabulary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-025: Dynamic Relationship Vocabulary Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-026-autonomous-vocabulary-curation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-026: Autonomous Vocabulary Curation and Ontology Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-027-user-management-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-027: User Management API with Lightweight JWT Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-028-dynamic-rbac-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-028: Dynamic Role-Based Access Control (RBAC) System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-029-cli-theory-of-operation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-029: CLI Theory of Operation - Hybrid Unix/Domain-Specific Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-030-concept-deduplication-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-030: Concept Deduplication Quality Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-031-encrypted-api-key-storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-031: Encrypted API Key Storage with Container Secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-032-IMPLEMENTATION-NOTES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-032 Implementation Quick Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-032-automatic-edge-vocabulary-expansion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-032: Automatic Edge Vocabulary Expansion with Intelligent Pruning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-033-multimodal-ingestion-configurable-prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-033: Multimodal Image Ingestion with Configurable Prompt System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-034-graph-visualization-query-workbench/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-034: Graph Visualization &amp; Interactive Query Explorers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-035-explorer-methods-uses-capabilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-035: Explorer Methods, Uses, and Capabilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-036-universal-visual-query-builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-036: Universal Visual Query Builder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-037-human-guided-graph-editing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-037: Human-Guided Graph Editing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-038-official-project-apparel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-038: Official Project Apparel Design Specifications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-039-local-embedding-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-039: Local Embedding Service with Hybrid Client/Server Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-040-database-schema-migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-040: Database Schema Migration Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-041-ai-extraction-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-041: AI Extraction Provider Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-042-local-extraction-inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-042: Local LLM Inference for Concept Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-043-single-node-resource-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-043: Single-Node Resource Management for Local Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-044-probabilistic-truth-convergence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-044: Probabilistic Truth Convergence Through Contradiction Resolution
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-045-046-MIGRATION-PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migration Plan: ADR-045/046 Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-045-unified-embedding-generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-045: Unified Embedding Generation System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-046-grounding-aware-vocabulary-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-046: Grounding-Aware Vocabulary Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-047-probabilistic-vocabulary-categorization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-047: Probabilistic Vocabulary Categorization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-048-vocabulary-metadata-as-graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-048: Vocabulary Metadata as First-Class Graph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-049-llm-determined-relationship-direction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-049: LLM-Determined Relationship Direction Semantics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-049-rate-limiting-and-concurrency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-049: Rate Limiting and Per-Provider Concurrency Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-050-scheduled-jobs-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-050: Scheduled Jobs System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-051-API-CHANGES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-051: API Changes for Graph-Based Document Deduplication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-051-graph-document-deduplication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-051: Graph-Based Provenance Tracking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-052-ENHANCEMENT-grounding-aware-reclassification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-052 Enhancement: Grounding-Aware Vocabulary Reclassification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADR-052-vocabulary-expansion-consolidation-cycle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-052: Vocabulary Expansion-Consolidation Cycle (The "Dreaming" Pattern)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE_DECISIONS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Decision Records (ADRs)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE_OVERVIEW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CLI_AUTHENTICATION_ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Authentication Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CODE-CHANGES-ANALYSIS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Changes Analysis: ADR-045/046 Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DATA_CONTRACT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Contract Pattern: Schema Governance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FUZZY_MATCHING_ANALYSIS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fuzzy Matching Analysis for 30-Type Relationship Taxonomy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PHASE_3_3_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-048 Phase 3.3 Implementation Plan
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PHASE_3_IMPLEMENTATION_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phase 3 Implementation Plan: Vocabulary as Graph Nodes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../QUERY_SAFETY_BASELINE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Query Safety Baseline - Technical Debt
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Knowledge Graph System - Recursive Upsert Architecture
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System - Recursive Upsert Architecture
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#semantic-matching-intelligent-merge-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Semantic Matching &amp; Intelligent Merge Pattern
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      1. Executive Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Executive Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-capabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Key Capabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-use-case" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Use Case
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      2. Problem Statement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Problem Statement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-linear-information-problem" class="md-nav__link">
    <span class="md-ellipsis">
      The Linear Information Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    <span class="md-ellipsis">
      The Solution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-system-overview" class="md-nav__link">
    <span class="md-ellipsis">
      3. System Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. System Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#high-level-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Data Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      4. Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-concept-node" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Concept Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-instance-node" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Instance Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-source-node" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Source Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-relationship" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 Relationship
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      5. Architecture Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Architecture Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-component-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 Component Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-matching-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Matching Algorithm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-data-models" class="md-nav__link">
    <span class="md-ellipsis">
      6. Data Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Data Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-postgresql-schema-phase-1" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 PostgreSQL Schema (Phase 1)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-llm-output-schema" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 LLM Output Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-document-ingestion-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      7. Document Ingestion Pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Document Ingestion Pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-pipeline-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Pipeline Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-example-usage" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Example Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-mcp-server-specification" class="md-nav__link">
    <span class="md-ellipsis">
      8. MCP Server Specification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. MCP Server Specification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-mcp-server-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 MCP Server Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-tool-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Tool Definitions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-tool-implementation-examples" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 Tool Implementation Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-claude-desktop-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 Claude Desktop Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-3d-visualization-interface" class="md-nav__link">
    <span class="md-ellipsis">
      9. 3D Visualization Interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. 3D Visualization Interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-visualization-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 Visualization Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-frontend-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 Frontend Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-backend-api" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 Backend API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-visualization-features" class="md-nav__link">
    <span class="md-ellipsis">
      9.4 Visualization Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-implementation-examples" class="md-nav__link">
    <span class="md-ellipsis">
      10. Implementation Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Implementation Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-example-processing-watts-documents" class="md-nav__link">
    <span class="md-ellipsis">
      10.1 Example: Processing Watts Documents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-example-claude-desktop-conversation" class="md-nav__link">
    <span class="md-ellipsis">
      10.2 Example: Claude Desktop Conversation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-technology-stack" class="md-nav__link">
    <span class="md-ellipsis">
      11. Technology Stack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Technology Stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-core-technologies" class="md-nav__link">
    <span class="md-ellipsis">
      11.1 Core Technologies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-development-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      11.2 Development Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-infrastructure-setup" class="md-nav__link">
    <span class="md-ellipsis">
      11.3 Infrastructure Setup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-implementation-roadmap" class="md-nav__link">
    <span class="md-ellipsis">
      12. Implementation Roadmap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Implementation Roadmap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-foundation-weeks-1-2" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Foundation (Weeks 1-2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-graph-visualization-weeks-3-4" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Graph &amp; Visualization (Weeks 3-4)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-production-features-weeks-5-6" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Production Features (Weeks 5-6)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-enhancement-weeks-7-8" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Enhancement (Weeks 7-8)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Checklist
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-a-example-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix A: Example Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix A: Example Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a1-sql-queries" class="md-nav__link">
    <span class="md-ellipsis">
      A.1 SQL Queries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a2-opencypher-queries-apache-age" class="md-nav__link">
    <span class="md-ellipsis">
      A.2 openCypher Queries (Apache AGE)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-b-configuration-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix B: Configuration Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix B: Configuration Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#b1-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      B.1 Environment Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b2-database-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      B.2 Database Initialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-c-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix C: Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix C: Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c1-common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      C.1 Common Issues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-graphrag-integration-borrowing-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      13. GraphRAG Integration: Borrowing Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13. GraphRAG Integration: Borrowing Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131-graphrag-overview" class="md-nav__link">
    <span class="md-ellipsis">
      13.1 GraphRAG Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132-community-detection-leiden-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      13.2 Community Detection (Leiden Algorithm)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.2 Community Detection (Leiden Algorithm)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-schema-extension" class="md-nav__link">
    <span class="md-ellipsis">
      Database Schema Extension
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133-hierarchical-summarization" class="md-nav__link">
    <span class="md-ellipsis">
      13.3 Hierarchical Summarization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.3 Hierarchical Summarization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#134-global-vs-local-query-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      13.4 Global vs. Local Query Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.4 Global vs. Local Query Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation-in-mcp-server" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation in MCP Server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#135-enhanced-entity-extraction-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      13.5 Enhanced Entity Extraction Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#136-integration-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      13.6 Integration Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#137-mcp-tools-for-graphrag-features" class="md-nav__link">
    <span class="md-ellipsis">
      13.7 MCP Tools for GraphRAG Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#138-visualization-updates-for-communities" class="md-nav__link">
    <span class="md-ellipsis">
      13.8 Visualization Updates for Communities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#139-usage-examples-with-graphrag-features" class="md-nav__link">
    <span class="md-ellipsis">
      13.9 Usage Examples with GraphRAG Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1310-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      13.10 Performance Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1311-summary-what-were-borrowing" class="md-nav__link">
    <span class="md-ellipsis">
      13.11 Summary: What We're Borrowing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visualization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/AUTO-DOCUMENTATION-STRATEGY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auto-Documentation Strategy for CLI Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/DEV_JOURNAL_chunked_ingestion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development Journal: Chunked Ingestion System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/LEARNED_KNOWLEDGE_MCP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learned Knowledge Synthesis - MCP Enhancement Plan
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/pattern-repetition-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Repetition in Growth Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/relationship-semantics-comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Relationship Semantics: How Others Do It vs. Our Proposal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vocabulary-direction-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vocabulary Direction Semantics Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/INTEGRATION_TEST_NOTES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integration Test Notes - Working Commands &amp; Observations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/INTEGRATION_TEST_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Graph System - Integration Test Plan
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/SCHEMA_MIGRATION_TEST_REPORT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PostgreSQL Schema Migration - Functional Test Report
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/TEST_COVERAGE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Test Coverage Areas
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#semantic-matching-intelligent-merge-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Semantic Matching &amp; Intelligent Merge Pattern
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      1. Executive Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Executive Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-capabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Key Capabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-use-case" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Use Case
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      2. Problem Statement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Problem Statement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-linear-information-problem" class="md-nav__link">
    <span class="md-ellipsis">
      The Linear Information Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    <span class="md-ellipsis">
      The Solution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-system-overview" class="md-nav__link">
    <span class="md-ellipsis">
      3. System Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. System Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#high-level-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Data Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      4. Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-concept-node" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Concept Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-instance-node" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Instance Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-source-node" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Source Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-relationship" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 Relationship
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      5. Architecture Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Architecture Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-component-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 Component Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-matching-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Matching Algorithm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-data-models" class="md-nav__link">
    <span class="md-ellipsis">
      6. Data Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Data Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-postgresql-schema-phase-1" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 PostgreSQL Schema (Phase 1)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-llm-output-schema" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 LLM Output Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-document-ingestion-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      7. Document Ingestion Pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Document Ingestion Pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-pipeline-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Pipeline Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-example-usage" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Example Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-mcp-server-specification" class="md-nav__link">
    <span class="md-ellipsis">
      8. MCP Server Specification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. MCP Server Specification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-mcp-server-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 MCP Server Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-tool-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Tool Definitions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-tool-implementation-examples" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 Tool Implementation Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-claude-desktop-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 Claude Desktop Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-3d-visualization-interface" class="md-nav__link">
    <span class="md-ellipsis">
      9. 3D Visualization Interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. 3D Visualization Interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-visualization-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 Visualization Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-frontend-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 Frontend Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-backend-api" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 Backend API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-visualization-features" class="md-nav__link">
    <span class="md-ellipsis">
      9.4 Visualization Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-implementation-examples" class="md-nav__link">
    <span class="md-ellipsis">
      10. Implementation Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Implementation Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-example-processing-watts-documents" class="md-nav__link">
    <span class="md-ellipsis">
      10.1 Example: Processing Watts Documents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-example-claude-desktop-conversation" class="md-nav__link">
    <span class="md-ellipsis">
      10.2 Example: Claude Desktop Conversation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-technology-stack" class="md-nav__link">
    <span class="md-ellipsis">
      11. Technology Stack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Technology Stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-core-technologies" class="md-nav__link">
    <span class="md-ellipsis">
      11.1 Core Technologies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-development-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      11.2 Development Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-infrastructure-setup" class="md-nav__link">
    <span class="md-ellipsis">
      11.3 Infrastructure Setup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-implementation-roadmap" class="md-nav__link">
    <span class="md-ellipsis">
      12. Implementation Roadmap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Implementation Roadmap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-foundation-weeks-1-2" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Foundation (Weeks 1-2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-graph-visualization-weeks-3-4" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Graph &amp; Visualization (Weeks 3-4)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-production-features-weeks-5-6" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Production Features (Weeks 5-6)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-enhancement-weeks-7-8" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Enhancement (Weeks 7-8)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Checklist
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-a-example-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix A: Example Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix A: Example Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a1-sql-queries" class="md-nav__link">
    <span class="md-ellipsis">
      A.1 SQL Queries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a2-opencypher-queries-apache-age" class="md-nav__link">
    <span class="md-ellipsis">
      A.2 openCypher Queries (Apache AGE)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-b-configuration-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix B: Configuration Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix B: Configuration Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#b1-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      B.1 Environment Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b2-database-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      B.2 Database Initialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-c-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix C: Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix C: Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c1-common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      C.1 Common Issues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-graphrag-integration-borrowing-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      13. GraphRAG Integration: Borrowing Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13. GraphRAG Integration: Borrowing Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131-graphrag-overview" class="md-nav__link">
    <span class="md-ellipsis">
      13.1 GraphRAG Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132-community-detection-leiden-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      13.2 Community Detection (Leiden Algorithm)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.2 Community Detection (Leiden Algorithm)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-schema-extension" class="md-nav__link">
    <span class="md-ellipsis">
      Database Schema Extension
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133-hierarchical-summarization" class="md-nav__link">
    <span class="md-ellipsis">
      13.3 Hierarchical Summarization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.3 Hierarchical Summarization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#134-global-vs-local-query-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      13.4 Global vs. Local Query Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.4 Global vs. Local Query Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation-in-mcp-server" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation in MCP Server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#135-enhanced-entity-extraction-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      13.5 Enhanced Entity Extraction Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#136-integration-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      13.6 Integration Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#137-mcp-tools-for-graphrag-features" class="md-nav__link">
    <span class="md-ellipsis">
      13.7 MCP Tools for GraphRAG Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#138-visualization-updates-for-communities" class="md-nav__link">
    <span class="md-ellipsis">
      13.8 Visualization Updates for Communities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#139-usage-examples-with-graphrag-features" class="md-nav__link">
    <span class="md-ellipsis">
      13.9 Usage Examples with GraphRAG Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1310-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      13.10 Performance Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1311-summary-what-were-borrowing" class="md-nav__link">
    <span class="md-ellipsis">
      13.11 Summary: What We're Borrowing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="knowledge-graph-system-recursive-upsert-architecture">Knowledge Graph System - Recursive Upsert Architecture</h1>
<h2 id="semantic-matching-intelligent-merge-pattern">Semantic Matching &amp; Intelligent Merge Pattern</h2>
<p><strong>Version:</strong> 1.0
<strong>Date:</strong> October 4, 2025
<strong>Purpose:</strong> Multi-document knowledge extraction using recursive concept matching and semantic upsert</p>
<blockquote>
<p><strong>Core Innovation:</strong> This specification documents our recursive concept upsert pattern - a semantic matching system that intelligently merges or creates concepts based on vector similarity. This pattern is reusable for agent memory systems, thinking/reasoning traces, and any knowledge accumulation workflow.</p>
</blockquote>
<p><strong>Current Implementation Status:</strong> See <a href="../ARCHITECTURE_OVERVIEW/">ARCHITECTURE_OVERVIEW.md</a> for as-built system details using Apache AGE + FastAPI + TypeScript client.</p>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#problem-statement">Problem Statement</a></li>
<li><a href="#system-overview">System Overview</a></li>
<li><a href="#core-concepts">Core Concepts</a></li>
<li><a href="#architecture-design">Architecture Design</a></li>
<li><a href="#data-models">Data Models</a></li>
<li><a href="#document-ingestion-pipeline">Document Ingestion Pipeline</a></li>
<li><a href="#mcp-server-specification">MCP Server Specification</a></li>
<li><a href="#3d-visualization-interface">3D Visualization Interface</a></li>
<li><a href="#implementation-examples">Implementation Examples</a></li>
<li><a href="#technology-stack">Technology Stack</a></li>
<li><a href="#implementation-roadmap">Implementation Roadmap</a></li>
</ol>
<hr />
<h2 id="1-executive-summary">1. Executive Summary</h2>
<p>This specification defines a knowledge graph system designed to extract conceptual relationships from document collections, store them in a queryable graph database, and provide both conversational (via Claude Desktop/MCP) and visual (3D graph) interfaces for exploration.</p>
<h3 id="key-capabilities">Key Capabilities</h3>
<ul>
<li><strong>Multi-document ingestion</strong>: Process client documents, white papers, research materials</li>
<li><strong>Concept extraction</strong>: Use LLM to identify concepts, relationships, and evidence</li>
<li><strong>Graph storage</strong>: Maintain concepts as nodes with full provenance and text instances</li>
<li><strong>Conversational queries</strong>: Natural language exploration via Claude Desktop + MCP server</li>
<li><strong>3D visualization</strong>: "Step outside" linear thinking to see conceptual structures</li>
<li><strong>Semantic search</strong>: Vector embeddings for concept similarity and discovery</li>
</ul>
<h3 id="primary-use-case">Primary Use Case</h3>
<p>Consulting firm document analysis where practitioners need to:
- Quickly understand conceptual relationships across client engagements
- Find patterns and connections between projects
- Explore knowledge non-linearly
- Maintain complete provenance to source documents</p>
<hr />
<h2 id="2-problem-statement">2. Problem Statement</h2>
<h3 id="the-linear-information-problem">The Linear Information Problem</h3>
<p>As articulated in Alan Watts' critique of human intelligence:</p>
<blockquote>
<p><strong>Paragraph 4</strong> (Watts Doc 1):
"So the geneticists are now saying and many others are now saying that man must take the course of his evolution into his own hands. He can no longer trust the wiggly random and unintelligible processes of nature to develop him any further but he must interfere with his own intelligence. And through genetic alterations breed the kind of people who will be viable for human society and that sort of thing. Now this I submit is a ghastly era. Because human intelligence has a very serious limitation. That limitation is. That it is a scanning system, of conscious attention, which is linear. That is to say, it examines the world, in lines. Rather as you would pass the beam of a flashlight across a room or a spotlight. That's why our education takes so long. It takes so long because we have to scan miles of lines of print. And we regard that you see as basic information"</p>
<p><strong>Paragraph 5</strong> (Watts Doc 1):
"Now the universe does not come at us in lines. It comes at us. In a multidimensional continuum in which everything is happening all together everywhere at once. And it comes at us much too quickly, to be translated into lines of print. Or of other information, however fast they may be scanned. And that is our limitation so far as the intellectual life and the scientific life is concerned. The computer will greatly speed up the linear scanning. But it's still linear scanning. And so long as we are stuck with that form of wisdom we cannot deal with more than a few variables at once..."</p>
</blockquote>
<h3 id="the-solution">The Solution</h3>
<p>Build a system that:
1. <strong>Extracts conceptual structure</strong> from linear documents
2. <strong>Preserves relationships</strong> between ideas across documents
3. <strong>Enables non-linear exploration</strong> through graph visualization
4. <strong>Maintains provenance</strong> back to source material
5. <strong>Supports semantic discovery</strong> beyond keyword search</p>
<hr />
<h2 id="3-system-overview">3. System Overview</h2>
<h3 id="high-level-architecture">High-Level Architecture</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>                    TYPESCRIPT CLIENT LAYER                   
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                                                              
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  kg CLI + MCP Server (Unified Client)                       
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>   Ingest documents via REST API                             
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>   Query concepts via natural language                       
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>   Manage ontologies and backups                             
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                                                              
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  See: ADR-013 (Unified TypeScript Client)                   
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                            
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                    FASTAPI REST API SERVER                   
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                                                              
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>  Python FastAPI + Job Queue                                 
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>   /ingest - Document processing with approval              
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>   /query - Semantic search &amp; graph traversal               
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>   /admin - Backup/restore/integrity tools                  
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>   LLM extraction pipeline (GPT-4/Claude)                   
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                                                              
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>  See: ADR-012 (API Server Architecture)                     
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>  See: ADR-014 (Job Approval Workflow)                       
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                            
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                    KNOWLEDGE GRAPH DATABASE                  
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                                                              
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>  Apache AGE (PostgreSQL + openCypher)                       
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>  + pgvector for semantic search                             
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                                                              
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>   Concepts as vertices (RECURSIVE UPSERT)                  
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>   Relationships as edges                                    
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>   Full text instances with quotes                           
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>   Source provenance tracking                                
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>   1536-dim embeddings (OpenAI ada-002)                     
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>                                                              
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>  See: ADR-016 (Apache AGE Migration with openCypher)       
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                            
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                    
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                                   
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>           
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>           MCP TOOLS         WEB APP       
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>           (Claude           (3D Graph     
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            Desktop)          Visualization)
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>           
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                                    
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                                    
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>         Natural Language      Visual Analysis
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>         Queries               &quot;Step Outside&quot;
</code></pre></div>
<h3 id="data-flow">Data Flow</h3>
<ol>
<li><strong>Ingestion</strong>: Documents  Paragraphs  LLM extraction  Structured JSON</li>
<li><strong>Matching</strong>: New concepts  Vector similarity search  Match or create</li>
<li><strong>Storage</strong>: Concepts + Instances + Relationships  Graph database</li>
<li><strong>Query</strong>: Natural language  MCP tools  Graph queries  Structured results</li>
<li><strong>Visualization</strong>: Concept subset  3D layout  Interactive exploration</li>
</ol>
<hr />
<h2 id="4-core-concepts">4. Core Concepts</h2>
<h3 id="41-concept-node">4.1 Concept Node</h3>
<p>A <strong>Concept</strong> is an abstract idea extracted from text. Concepts can appear in multiple documents.</p>
<p><strong>Properties:</strong>
- <code>concept_id</code> (string, primary key): Kebab-case identifier (e.g., "linear-scanning-system")
- <code>label</code> (string): Human-readable name (e.g., "Linear scanning system")
- <code>embedding</code> (vector): 1536-dimensional semantic embedding
- <code>search_terms</code> (array): Keywords for fallback matching
- <code>created_at</code> (timestamp)
- <code>updated_at</code> (timestamp)</p>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Linear scanning system&quot;</span><span class="p">,</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="nt">&quot;search_terms&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;linear processing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sequential thinking&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scanning attention&quot;</span><span class="p">],</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-04T10:30:00Z&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="42-instance-node">4.2 Instance Node</h3>
<p>An <strong>Instance</strong> is a specific quote/evidence from a document that supports a concept.</p>
<p><strong>Properties:</strong>
- <code>instance_id</code> (uuid, primary key)
- <code>concept_id</code> (foreign key to Concept)
- <code>source_id</code> (foreign key to Source)
- <code>quote</code> (text): Exact text from document
- <code>created_at</code> (timestamp)</p>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">&quot;instance_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;550e8400-e29b-41d4-a716-446655440000&quot;</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nt">&quot;source_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;watts-doc-1-para-4&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="nt">&quot;quote&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;it is a scanning system, of conscious attention, which is linear&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="43-source-node">4.3 Source Node</h3>
<p>A <strong>Source</strong> represents a specific location in a document (paragraph, section, page).</p>
<p><strong>Properties:</strong>
- <code>source_id</code> (string, primary key): Format: <code>{document-slug}-para-{number}</code>
- <code>document</code> (string): Document name/identifier
- <code>paragraph</code> (integer): Paragraph number
- <code>section</code> (string, optional): Section/chapter identifier
- <code>full_text</code> (text): Complete paragraph text
- <code>created_at</code> (timestamp)</p>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="nt">&quot;source_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;watts-doc-1-para-4&quot;</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="nt">&quot;document&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Watts Doc 1&quot;</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">&quot;paragraph&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="nt">&quot;full_text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;So the geneticists are now saying...&quot;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="44-relationship">4.4 Relationship</h3>
<p>A <strong>Relationship</strong> connects two concepts with a typed edge.</p>
<p><strong>Types:</strong>
- <code>implies</code>: Concept A logically implies Concept B
- <code>contradicts</code>: Concept A contradicts Concept B
- <code>supports</code>: Concept A provides evidence for Concept B
- <code>part_of</code>: Concept A is a component of Concept B
- <code>requires</code>: Concept A requires Concept B</p>
<p><strong>Properties:</strong>
- <code>from_concept_id</code> (foreign key)
- <code>to_concept_id</code> (foreign key)
- <code>relationship_type</code> (enum)
- <code>confidence</code> (float, 0.0-1.0)
- <code>created_at</code> (timestamp)</p>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="nt">&quot;from_concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;intelligence-limitation&quot;</span><span class="p">,</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="nt">&quot;to_concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="nt">&quot;relationship_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;part_of&quot;</span><span class="p">,</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="nt">&quot;confidence&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.95</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="p">}</span>
</code></pre></div></p>
<hr />
<h2 id="5-architecture-design">5. Architecture Design</h2>
<h3 id="51-component-architecture">5.1 Component Architecture</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>         Document Processor              
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>  - Parse documents into paragraphs      
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  - Extract metadata                     
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>  - Batch processing support             
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                  
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>         LLM Extraction Engine           
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>  - Per-paragraph concept extraction     
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>  - Relationship identification          
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>  - Quote/instance extraction            
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>  - Structured JSON output               
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>                  
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>         Concept Matching Service        
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>  - Vector similarity search             
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>  - Multi-stage matching algorithm       
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>  - Deduplication logic                  
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>                  
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>         Graph Upsert Engine             
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>  - UPSERT concepts (add sources)        
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>  - INSERT instances                     
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>  - CREATE/UPDATE relationships          
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>  - Update vector embeddings             
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>
</code></pre></div>
<h3 id="52-matching-algorithm">5.2 Matching Algorithm</h3>
<p><strong>Multi-stage concept matching to prevent duplicates:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Stage 1: Exact ID Match
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>   If LLM predicted existing concept_id  Use it
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>   Confidence: 100%
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>Stage 2: Vector Similarity (Primary)
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>   Embed: label + search_terms
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>   Cosine similarity search
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>   Threshold: &gt; 0.85  Match
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>   Confidence: similarity_score
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>Stage 3: Keyword Overlap (Fallback)
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>   Compare search_terms arrays
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>   Intersection &gt; 50%  Potential match
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>   Require manual review or lower confidence
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>Stage 4: Create New Concept
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>   No match found
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>   Generate new concept_id
</code></pre></div>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_matching_concept</span><span class="p">(</span><span class="n">new_concept</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="c1"># Stage 1: Exact match</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="k">if</span> <span class="n">concept_exists</span><span class="p">(</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]):</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="k">return</span> <span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="c1"># Stage 2: Vector similarity</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="n">embedding</span> <span class="o">=</span> <span class="n">generate_embedding</span><span class="p">(</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">vector_search</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="k">if</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="c1"># Stage 3: Keyword overlap</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">get_all_concepts</span><span class="p">():</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="n">overlap</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">])</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>            <span class="c1"># Flag for review or use with lower confidence</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>            <span class="n">log_potential_duplicate</span><span class="p">(</span><span class="n">new_concept</span><span class="p">,</span> <span class="n">existing</span><span class="p">)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>    <span class="c1"># Stage 4: New concept</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></p>
<hr />
<h2 id="6-data-models">6. Data Models</h2>
<h3 id="61-postgresql-schema-phase-1">6.1 PostgreSQL Schema (Phase 1)</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">-- Enable vector extension</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">vector</span><span class="p">;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1">-- CONCEPTS TABLE</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="n">concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="n">label</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span><span class="w">  </span><span class="c1">-- OpenAI ada-002 dimensions</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="n">search_terms</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[],</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="p">);</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1">-- Vector similarity index</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_concept_embedding</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="k">USING</span><span class="w"> </span><span class="n">ivfflat</span><span class="w"> </span><span class="p">(</span><span class="n">embedding</span><span class="w"> </span><span class="n">vector_cosine_ops</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">lists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="c1">-- Text search index (fallback)</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_search_terms</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="w"> </span><span class="p">(</span><span class="n">search_terms</span><span class="p">);</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="c1">-- SOURCES TABLE</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">    </span><span class="n">source_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">    </span><span class="n">document</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">    </span><span class="n">paragraph</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="n">section</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">    </span><span class="n">full_text</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="p">);</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="c1">-- INSTANCES TABLE (quotes/evidence)</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">    </span><span class="n">instance_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="w">    </span><span class="n">concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">concepts</span><span class="p">(</span><span class="n">concept_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">    </span><span class="n">source_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">sources</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="w">    </span><span class="n">quote</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="p">);</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="c1">-- CONCEPT RELATIONSHIPS</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">concept_relationships</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="w">    </span><span class="n">from_concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">concepts</span><span class="p">(</span><span class="n">concept_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">    </span><span class="n">to_concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">concepts</span><span class="p">(</span><span class="n">concept_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="w">    </span><span class="n">relationship_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">relationship_type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;implies&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;contradicts&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;supports&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;part_of&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;requires&#39;</span><span class="p">)),</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="w">    </span><span class="n">confidence</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">confidence</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">from_concept_id</span><span class="p">,</span><span class="w"> </span><span class="n">to_concept_id</span><span class="p">,</span><span class="w"> </span><span class="n">relationship_type</span><span class="p">)</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="p">);</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="c1">-- CONCEPT SOURCES (many-to-many)</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">concept_sources</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="w">    </span><span class="n">concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">concepts</span><span class="p">(</span><span class="n">concept_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">    </span><span class="n">source_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">sources</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">    </span><span class="n">first_seen</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="p">);</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="c1">-- CONCEPT SEARCH TERMS (for keyword matching)</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">concept_search_terms</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">    </span><span class="n">concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">concepts</span><span class="p">(</span><span class="n">concept_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">    </span><span class="n">search_term</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="n">search_term</span><span class="p">)</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="p">);</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_search_term_lookup</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">concept_search_terms</span><span class="p">(</span><span class="n">search_term</span><span class="p">);</span>
</code></pre></div>
<h3 id="63-llm-output-schema">6.3 LLM Output Schema</h3>
<p><strong>JSON structure for LLM extraction output:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">  </span><span class="nt">&quot;extracted_concepts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;human-directed-evolution&quot;</span><span class="p">,</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">      </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Human-directed evolution&quot;</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">      </span><span class="nt">&quot;confidence&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.95</span><span class="p">,</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">      </span><span class="nt">&quot;search_terms&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="s2">&quot;human evolution control&quot;</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="s2">&quot;self-directed evolution&quot;</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="s2">&quot;evolutionary intervention&quot;</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="s2">&quot;genetic control&quot;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nature-unreliable&quot;</span><span class="p">,</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">      </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Nature is unreliable&quot;</span><span class="p">,</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">      </span><span class="nt">&quot;confidence&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.88</span><span class="p">,</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">      </span><span class="nt">&quot;search_terms&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">        </span><span class="s2">&quot;nature random&quot;</span><span class="p">,</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">        </span><span class="s2">&quot;natural processes unintelligible&quot;</span><span class="p">,</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">        </span><span class="s2">&quot;distrust nature&quot;</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">  </span><span class="nt">&quot;instances&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;human-directed-evolution&quot;</span><span class="p">,</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">      </span><span class="nt">&quot;quote&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;man must take the course of his evolution into his own hands&quot;</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nature-unreliable&quot;</span><span class="p">,</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">      </span><span class="nt">&quot;quote&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;He can no longer trust the wiggly random and unintelligible processes of nature&quot;</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">  </span><span class="nt">&quot;relationships&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">      </span><span class="nt">&quot;from_concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;human-directed-evolution&quot;</span><span class="p">,</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">      </span><span class="nt">&quot;to_concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nature-unreliable&quot;</span><span class="p">,</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">      </span><span class="nt">&quot;relationship_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;implies&quot;</span><span class="p">,</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">      </span><span class="nt">&quot;confidence&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.90</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">      </span><span class="nt">&quot;from_concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nature-unreliable&quot;</span><span class="p">,</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">      </span><span class="nt">&quot;to_concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;genetic-intervention-needed&quot;</span><span class="p">,</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a><span class="w">      </span><span class="nt">&quot;relationship_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;implies&quot;</span><span class="p">,</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">      </span><span class="nt">&quot;confidence&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.85</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a><span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="7-document-ingestion-pipeline">7. Document Ingestion Pipeline</h2>
<h3 id="71-pipeline-architecture">7.1 Pipeline Architecture</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># ingest/pipeline.py</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">anthropic</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentProcessor</span><span class="p">:</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="sd">    Main document ingestion pipeline</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">,</span> <span class="n">vector_db</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">):</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph_db</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector_db</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm_client</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span> <span class="o">=</span> <span class="s2">&quot;text-embedding-3-small&quot;</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_document</span><span class="p">(</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        <span class="n">doc_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> 
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>        <span class="n">doc_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="sd">        Process a single document through the pipeline</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="sd">        Args:</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="sd">            doc_path: Path to document file</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="sd">            doc_metadata: {&quot;name&quot;: &quot;Watts Doc 1&quot;, &quot;client&quot;: &quot;Research&quot;, ...}</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="sd">        Returns:</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="sd">            Processing statistics</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing document: </span><span class="si">{</span><span class="n">doc_metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>        <span class="c1"># 1. Parse document into paragraphs</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>        <span class="n">paragraphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">doc_path</span><span class="p">)</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span><span class="si">}</span><span class="s2"> paragraphs&quot;</span><span class="p">)</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>        <span class="c1"># 2. Get current graph state for context</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>        <span class="n">existing_concepts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_existing_concepts</span><span class="p">()</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>        <span class="c1"># 3. Process each paragraph</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>            <span class="s2">&quot;paragraphs_processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>            <span class="s2">&quot;concepts_created&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>            <span class="s2">&quot;concepts_updated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>            <span class="s2">&quot;instances_created&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>            <span class="s2">&quot;relationships_created&quot;</span><span class="p">:</span> <span class="mi">0</span>
<a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>        <span class="p">}</span>
<a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>
<a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">para_text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
<a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>            <span class="n">para_num</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>            <span class="n">source_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slugify</span><span class="p">(</span><span class="n">doc_metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">-para-</span><span class="si">{</span><span class="n">para_num</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>
<a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Processing paragraph </span><span class="si">{</span><span class="n">para_num</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>
<a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>            <span class="c1"># Store source</span>
<a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_source</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">doc_metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">para_num</span><span class="p">,</span> <span class="n">para_text</span><span class="p">)</span>
<a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>
<a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>            <span class="c1"># Extract concepts using LLM</span>
<a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>            <span class="n">extraction</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_concepts</span><span class="p">(</span>
<a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>                <span class="n">para_text</span><span class="p">,</span>
<a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>                <span class="n">source_id</span><span class="p">,</span>
<a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>                <span class="n">existing_concepts</span>
<a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>            <span class="p">)</span>
<a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>
<a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>            <span class="c1"># Upsert to graph</span>
<a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a>            <span class="n">upsert_stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsert_to_graph</span><span class="p">(</span><span class="n">extraction</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a>
<a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a>            <span class="c1"># Update statistics</span>
<a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;paragraphs_processed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;concepts_created&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">upsert_stats</span><span class="p">[</span><span class="s2">&quot;new_concepts&quot;</span><span class="p">]</span>
<a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;concepts_updated&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">upsert_stats</span><span class="p">[</span><span class="s2">&quot;updated_concepts&quot;</span><span class="p">]</span>
<a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;instances_created&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">upsert_stats</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span>
<a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;relationships_created&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">upsert_stats</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]</span>
<a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a>
<a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a>            <span class="c1"># Refresh existing concepts for next iteration</span>
<a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a>            <span class="n">existing_concepts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_existing_concepts</span><span class="p">()</span>
<a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a>
<a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a>        <span class="k">return</span> <span class="n">stats</span>
<a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a>
<a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse document into paragraphs based on file type&quot;&quot;&quot;</span>
<a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a>        <span class="k">if</span> <span class="n">doc_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.txt&#39;</span><span class="p">:</span>
<a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_text</span><span class="p">(</span><span class="n">doc_path</span><span class="p">)</span>
<a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a>        <span class="k">elif</span> <span class="n">doc_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">:</span>
<a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pdf</span><span class="p">(</span><span class="n">doc_path</span><span class="p">)</span>
<a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a>        <span class="k">elif</span> <span class="n">doc_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.docx&#39;</span><span class="p">,</span> <span class="s1">&#39;.doc&#39;</span><span class="p">]:</span>
<a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_docx</span><span class="p">(</span><span class="n">doc_path</span><span class="p">)</span>
<a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file type: </span><span class="si">{</span><span class="n">doc_path</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a>
<a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse plain text file into paragraphs&quot;&quot;&quot;</span>
<a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">doc_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a>
<a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a>        <span class="c1"># Split on double newlines</span>
<a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a>        <span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a>        <span class="k">return</span> <span class="n">paragraphs</span>
<a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a>
<a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">extract_concepts</span><span class="p">(</span>
<a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a>        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a>        <span class="n">source_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a>        <span class="n">existing_concepts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
<a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a><span class="sd">        Use Claude to extract concepts from paragraph</span>
<a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a>
<a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a><span class="sd">        Returns JSON matching the LLM output schema</span>
<a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-10-115" name="__codelineno-10-115" href="#__codelineno-10-115"></a>
<a id="__codelineno-10-116" name="__codelineno-10-116" href="#__codelineno-10-116"></a>        <span class="c1"># Limit existing concepts shown to LLM (top 50 by relevance)</span>
<a id="__codelineno-10-117" name="__codelineno-10-117" href="#__codelineno-10-117"></a>        <span class="n">concept_context</span> <span class="o">=</span> <span class="n">existing_concepts</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
<a id="__codelineno-10-118" name="__codelineno-10-118" href="#__codelineno-10-118"></a>
<a id="__codelineno-10-119" name="__codelineno-10-119" href="#__codelineno-10-119"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are a knowledge graph extraction system. Analyze the provided text and output structured JSON.</span>
<a id="__codelineno-10-120" name="__codelineno-10-120" href="#__codelineno-10-120"></a>
<a id="__codelineno-10-121" name="__codelineno-10-121" href="#__codelineno-10-121"></a><span class="s2">CONTEXT - EXISTING CONCEPTS (for matching):</span>
<a id="__codelineno-10-122" name="__codelineno-10-122" href="#__codelineno-10-122"></a><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">concept_context</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-10-123" name="__codelineno-10-123" href="#__codelineno-10-123"></a>
<a id="__codelineno-10-124" name="__codelineno-10-124" href="#__codelineno-10-124"></a><span class="s2">NEW TEXT TO PROCESS:</span>
<a id="__codelineno-10-125" name="__codelineno-10-125" href="#__codelineno-10-125"></a><span class="s2">Source: </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span>
<a id="__codelineno-10-126" name="__codelineno-10-126" href="#__codelineno-10-126"></a><span class="s2">Text: </span><span class="se">\&quot;\&quot;\&quot;</span>
<a id="__codelineno-10-127" name="__codelineno-10-127" href="#__codelineno-10-127"></a><span class="si">{</span><span class="n">text</span><span class="si">}</span>
<a id="__codelineno-10-128" name="__codelineno-10-128" href="#__codelineno-10-128"></a><span class="se">\&quot;\&quot;\&quot;</span>
<a id="__codelineno-10-129" name="__codelineno-10-129" href="#__codelineno-10-129"></a>
<a id="__codelineno-10-130" name="__codelineno-10-130" href="#__codelineno-10-130"></a><span class="s2">TASK:</span>
<a id="__codelineno-10-131" name="__codelineno-10-131" href="#__codelineno-10-131"></a><span class="s2">1. Extract key concepts (ideas, claims, arguments) from the text</span>
<a id="__codelineno-10-132" name="__codelineno-10-132" href="#__codelineno-10-132"></a><span class="s2">2. For EACH concept, provide search terms to help match against existing concepts</span>
<a id="__codelineno-10-133" name="__codelineno-10-133" href="#__codelineno-10-133"></a><span class="s2">3. Identify text instances (quotes) that support each concept</span>
<a id="__codelineno-10-134" name="__codelineno-10-134" href="#__codelineno-10-134"></a><span class="s2">4. Map logical relationships between concepts</span>
<a id="__codelineno-10-135" name="__codelineno-10-135" href="#__codelineno-10-135"></a>
<a id="__codelineno-10-136" name="__codelineno-10-136" href="#__codelineno-10-136"></a><span class="s2">MATCHING INSTRUCTIONS:</span>
<a id="__codelineno-10-137" name="__codelineno-10-137" href="#__codelineno-10-137"></a><span class="s2">- If a concept matches an existing one (same core idea, even if worded differently), use the existing concept_id</span>
<a id="__codelineno-10-138" name="__codelineno-10-138" href="#__codelineno-10-138"></a><span class="s2">- If it&#39;s a new concept, create a new kebab-case concept_id</span>
<a id="__codelineno-10-139" name="__codelineno-10-139" href="#__codelineno-10-139"></a><span class="s2">- Be conservative: only match if concepts are truly equivalent</span>
<a id="__codelineno-10-140" name="__codelineno-10-140" href="#__codelineno-10-140"></a>
<a id="__codelineno-10-141" name="__codelineno-10-141" href="#__codelineno-10-141"></a><span class="s2">OUTPUT REQUIREMENTS:</span>
<a id="__codelineno-10-142" name="__codelineno-10-142" href="#__codelineno-10-142"></a><span class="s2">- Return valid JSON matching the schema below</span>
<a id="__codelineno-10-143" name="__codelineno-10-143" href="#__codelineno-10-143"></a><span class="s2">- Use kebab-case for concept_ids (e.g., &quot;linear-scanning-system&quot;)</span>
<a id="__codelineno-10-144" name="__codelineno-10-144" href="#__codelineno-10-144"></a><span class="s2">- Provide 2-5 search terms per concept for semantic matching</span>
<a id="__codelineno-10-145" name="__codelineno-10-145" href="#__codelineno-10-145"></a><span class="s2">- Include confidence scores (0.0-1.0)</span>
<a id="__codelineno-10-146" name="__codelineno-10-146" href="#__codelineno-10-146"></a><span class="s2">- Quote instances should be verbatim from source text</span>
<a id="__codelineno-10-147" name="__codelineno-10-147" href="#__codelineno-10-147"></a><span class="s2">- Only include relationships between concepts in THIS extraction</span>
<a id="__codelineno-10-148" name="__codelineno-10-148" href="#__codelineno-10-148"></a>
<a id="__codelineno-10-149" name="__codelineno-10-149" href="#__codelineno-10-149"></a><span class="s2">RESPONSE SCHEMA:</span>
<a id="__codelineno-10-150" name="__codelineno-10-150" href="#__codelineno-10-150"></a><span class="se">{{</span>
<a id="__codelineno-10-151" name="__codelineno-10-151" href="#__codelineno-10-151"></a><span class="s2">  &quot;extracted_concepts&quot;: [</span>
<a id="__codelineno-10-152" name="__codelineno-10-152" href="#__codelineno-10-152"></a><span class="s2">    </span><span class="se">{{</span>
<a id="__codelineno-10-153" name="__codelineno-10-153" href="#__codelineno-10-153"></a><span class="s2">      &quot;concept_id&quot;: &quot;kebab-case-id&quot;,</span>
<a id="__codelineno-10-154" name="__codelineno-10-154" href="#__codelineno-10-154"></a><span class="s2">      &quot;label&quot;: &quot;Human readable label&quot;,</span>
<a id="__codelineno-10-155" name="__codelineno-10-155" href="#__codelineno-10-155"></a><span class="s2">      &quot;confidence&quot;: 0.95,</span>
<a id="__codelineno-10-156" name="__codelineno-10-156" href="#__codelineno-10-156"></a><span class="s2">      &quot;search_terms&quot;: [&quot;term1&quot;, &quot;term2&quot;, &quot;term3&quot;]</span>
<a id="__codelineno-10-157" name="__codelineno-10-157" href="#__codelineno-10-157"></a><span class="s2">    </span><span class="se">}}</span>
<a id="__codelineno-10-158" name="__codelineno-10-158" href="#__codelineno-10-158"></a><span class="s2">  ],</span>
<a id="__codelineno-10-159" name="__codelineno-10-159" href="#__codelineno-10-159"></a><span class="s2">  &quot;instances&quot;: [</span>
<a id="__codelineno-10-160" name="__codelineno-10-160" href="#__codelineno-10-160"></a><span class="s2">    </span><span class="se">{{</span>
<a id="__codelineno-10-161" name="__codelineno-10-161" href="#__codelineno-10-161"></a><span class="s2">      &quot;concept_id&quot;: &quot;matches-concept-above&quot;,</span>
<a id="__codelineno-10-162" name="__codelineno-10-162" href="#__codelineno-10-162"></a><span class="s2">      &quot;quote&quot;: &quot;exact verbatim quote from text&quot;</span>
<a id="__codelineno-10-163" name="__codelineno-10-163" href="#__codelineno-10-163"></a><span class="s2">    </span><span class="se">}}</span>
<a id="__codelineno-10-164" name="__codelineno-10-164" href="#__codelineno-10-164"></a><span class="s2">  ],</span>
<a id="__codelineno-10-165" name="__codelineno-10-165" href="#__codelineno-10-165"></a><span class="s2">  &quot;relationships&quot;: [</span>
<a id="__codelineno-10-166" name="__codelineno-10-166" href="#__codelineno-10-166"></a><span class="s2">    </span><span class="se">{{</span>
<a id="__codelineno-10-167" name="__codelineno-10-167" href="#__codelineno-10-167"></a><span class="s2">      &quot;from_concept_id&quot;: &quot;concept-a&quot;,</span>
<a id="__codelineno-10-168" name="__codelineno-10-168" href="#__codelineno-10-168"></a><span class="s2">      &quot;to_concept_id&quot;: &quot;concept-b&quot;,</span>
<a id="__codelineno-10-169" name="__codelineno-10-169" href="#__codelineno-10-169"></a><span class="s2">      &quot;relationship_type&quot;: &quot;implies&quot;,</span>
<a id="__codelineno-10-170" name="__codelineno-10-170" href="#__codelineno-10-170"></a><span class="s2">      &quot;confidence&quot;: 0.85</span>
<a id="__codelineno-10-171" name="__codelineno-10-171" href="#__codelineno-10-171"></a><span class="s2">    </span><span class="se">}}</span>
<a id="__codelineno-10-172" name="__codelineno-10-172" href="#__codelineno-10-172"></a><span class="s2">  ]</span>
<a id="__codelineno-10-173" name="__codelineno-10-173" href="#__codelineno-10-173"></a><span class="se">}}</span>
<a id="__codelineno-10-174" name="__codelineno-10-174" href="#__codelineno-10-174"></a>
<a id="__codelineno-10-175" name="__codelineno-10-175" href="#__codelineno-10-175"></a><span class="s2">RELATIONSHIP TYPES:</span>
<a id="__codelineno-10-176" name="__codelineno-10-176" href="#__codelineno-10-176"></a><span class="s2">- implies: A logically implies B</span>
<a id="__codelineno-10-177" name="__codelineno-10-177" href="#__codelineno-10-177"></a><span class="s2">- contradicts: A contradicts B</span>
<a id="__codelineno-10-178" name="__codelineno-10-178" href="#__codelineno-10-178"></a><span class="s2">- supports: A provides evidence for B</span>
<a id="__codelineno-10-179" name="__codelineno-10-179" href="#__codelineno-10-179"></a><span class="s2">- part_of: A is a component of B</span>
<a id="__codelineno-10-180" name="__codelineno-10-180" href="#__codelineno-10-180"></a><span class="s2">- requires: A requires B</span>
<a id="__codelineno-10-181" name="__codelineno-10-181" href="#__codelineno-10-181"></a>
<a id="__codelineno-10-182" name="__codelineno-10-182" href="#__codelineno-10-182"></a><span class="s2">Respond ONLY with valid JSON, no other text.&quot;&quot;&quot;</span>
<a id="__codelineno-10-183" name="__codelineno-10-183" href="#__codelineno-10-183"></a>
<a id="__codelineno-10-184" name="__codelineno-10-184" href="#__codelineno-10-184"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-10-185" name="__codelineno-10-185" href="#__codelineno-10-185"></a>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span>
<a id="__codelineno-10-186" name="__codelineno-10-186" href="#__codelineno-10-186"></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
<a id="__codelineno-10-187" name="__codelineno-10-187" href="#__codelineno-10-187"></a>            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
<a id="__codelineno-10-188" name="__codelineno-10-188" href="#__codelineno-10-188"></a>        <span class="p">)</span>
<a id="__codelineno-10-189" name="__codelineno-10-189" href="#__codelineno-10-189"></a>
<a id="__codelineno-10-190" name="__codelineno-10-190" href="#__codelineno-10-190"></a>        <span class="c1"># Parse JSON response</span>
<a id="__codelineno-10-191" name="__codelineno-10-191" href="#__codelineno-10-191"></a>        <span class="n">json_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-10-192" name="__codelineno-10-192" href="#__codelineno-10-192"></a>        <span class="c1"># Strip markdown code blocks if present</span>
<a id="__codelineno-10-193" name="__codelineno-10-193" href="#__codelineno-10-193"></a>        <span class="n">json_text</span> <span class="o">=</span> <span class="n">json_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;```json</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;```</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-10-194" name="__codelineno-10-194" href="#__codelineno-10-194"></a>
<a id="__codelineno-10-195" name="__codelineno-10-195" href="#__codelineno-10-195"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_text</span><span class="p">)</span>
<a id="__codelineno-10-196" name="__codelineno-10-196" href="#__codelineno-10-196"></a>
<a id="__codelineno-10-197" name="__codelineno-10-197" href="#__codelineno-10-197"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upsert_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extraction</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">source_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-10-198" name="__codelineno-10-198" href="#__codelineno-10-198"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-10-199" name="__codelineno-10-199" href="#__codelineno-10-199"></a><span class="sd">        Upsert extracted data to graph database</span>
<a id="__codelineno-10-200" name="__codelineno-10-200" href="#__codelineno-10-200"></a>
<a id="__codelineno-10-201" name="__codelineno-10-201" href="#__codelineno-10-201"></a><span class="sd">        Returns statistics about what was created/updated</span>
<a id="__codelineno-10-202" name="__codelineno-10-202" href="#__codelineno-10-202"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-10-203" name="__codelineno-10-203" href="#__codelineno-10-203"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-204" name="__codelineno-10-204" href="#__codelineno-10-204"></a>            <span class="s2">&quot;new_concepts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-205" name="__codelineno-10-205" href="#__codelineno-10-205"></a>            <span class="s2">&quot;updated_concepts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-206" name="__codelineno-10-206" href="#__codelineno-10-206"></a>            <span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-10-207" name="__codelineno-10-207" href="#__codelineno-10-207"></a>            <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="mi">0</span>
<a id="__codelineno-10-208" name="__codelineno-10-208" href="#__codelineno-10-208"></a>        <span class="p">}</span>
<a id="__codelineno-10-209" name="__codelineno-10-209" href="#__codelineno-10-209"></a>
<a id="__codelineno-10-210" name="__codelineno-10-210" href="#__codelineno-10-210"></a>        <span class="c1"># Process each extracted concept</span>
<a id="__codelineno-10-211" name="__codelineno-10-211" href="#__codelineno-10-211"></a>        <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">extraction</span><span class="p">[</span><span class="s1">&#39;extracted_concepts&#39;</span><span class="p">]:</span>
<a id="__codelineno-10-212" name="__codelineno-10-212" href="#__codelineno-10-212"></a>            <span class="c1"># Try to match with existing concept</span>
<a id="__codelineno-10-213" name="__codelineno-10-213" href="#__codelineno-10-213"></a>            <span class="n">matched_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_matching_concept</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span>
<a id="__codelineno-10-214" name="__codelineno-10-214" href="#__codelineno-10-214"></a>
<a id="__codelineno-10-215" name="__codelineno-10-215" href="#__codelineno-10-215"></a>            <span class="k">if</span> <span class="n">matched_id</span><span class="p">:</span>
<a id="__codelineno-10-216" name="__codelineno-10-216" href="#__codelineno-10-216"></a>                <span class="c1"># Update existing concept</span>
<a id="__codelineno-10-217" name="__codelineno-10-217" href="#__codelineno-10-217"></a>                <span class="n">concept_id</span> <span class="o">=</span> <span class="n">matched_id</span>
<a id="__codelineno-10-218" name="__codelineno-10-218" href="#__codelineno-10-218"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_concept</span><span class="p">(</span><span class="n">concept_id</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-10-219" name="__codelineno-10-219" href="#__codelineno-10-219"></a>                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;updated_concepts&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-10-220" name="__codelineno-10-220" href="#__codelineno-10-220"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-10-221" name="__codelineno-10-221" href="#__codelineno-10-221"></a>                <span class="c1"># Create new concept</span>
<a id="__codelineno-10-222" name="__codelineno-10-222" href="#__codelineno-10-222"></a>                <span class="n">concept_id</span> <span class="o">=</span> <span class="n">concept</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]</span>
<a id="__codelineno-10-223" name="__codelineno-10-223" href="#__codelineno-10-223"></a>                <span class="n">embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_embedding</span><span class="p">(</span>
<a id="__codelineno-10-224" name="__codelineno-10-224" href="#__codelineno-10-224"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">concept</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concept</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-10-225" name="__codelineno-10-225" href="#__codelineno-10-225"></a>                <span class="p">)</span>
<a id="__codelineno-10-226" name="__codelineno-10-226" href="#__codelineno-10-226"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_concept</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
<a id="__codelineno-10-227" name="__codelineno-10-227" href="#__codelineno-10-227"></a>                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;new_concepts&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-10-228" name="__codelineno-10-228" href="#__codelineno-10-228"></a>
<a id="__codelineno-10-229" name="__codelineno-10-229" href="#__codelineno-10-229"></a>            <span class="c1"># Store search terms</span>
<a id="__codelineno-10-230" name="__codelineno-10-230" href="#__codelineno-10-230"></a>            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">concept</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">]:</span>
<a id="__codelineno-10-231" name="__codelineno-10-231" href="#__codelineno-10-231"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_search_term</span><span class="p">(</span><span class="n">concept_id</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
<a id="__codelineno-10-232" name="__codelineno-10-232" href="#__codelineno-10-232"></a>
<a id="__codelineno-10-233" name="__codelineno-10-233" href="#__codelineno-10-233"></a>        <span class="c1"># Process instances</span>
<a id="__codelineno-10-234" name="__codelineno-10-234" href="#__codelineno-10-234"></a>        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">extraction</span><span class="p">[</span><span class="s1">&#39;instances&#39;</span><span class="p">]:</span>
<a id="__codelineno-10-235" name="__codelineno-10-235" href="#__codelineno-10-235"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span>
<a id="__codelineno-10-236" name="__codelineno-10-236" href="#__codelineno-10-236"></a>                <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">],</span>
<a id="__codelineno-10-237" name="__codelineno-10-237" href="#__codelineno-10-237"></a>                <span class="n">source_id</span><span class="p">,</span>
<a id="__codelineno-10-238" name="__codelineno-10-238" href="#__codelineno-10-238"></a>                <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;quote&#39;</span><span class="p">]</span>
<a id="__codelineno-10-239" name="__codelineno-10-239" href="#__codelineno-10-239"></a>            <span class="p">)</span>
<a id="__codelineno-10-240" name="__codelineno-10-240" href="#__codelineno-10-240"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-10-241" name="__codelineno-10-241" href="#__codelineno-10-241"></a>
<a id="__codelineno-10-242" name="__codelineno-10-242" href="#__codelineno-10-242"></a>        <span class="c1"># Process relationships</span>
<a id="__codelineno-10-243" name="__codelineno-10-243" href="#__codelineno-10-243"></a>        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">extraction</span><span class="p">[</span><span class="s1">&#39;relationships&#39;</span><span class="p">]:</span>
<a id="__codelineno-10-244" name="__codelineno-10-244" href="#__codelineno-10-244"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_relationship</span><span class="p">(</span>
<a id="__codelineno-10-245" name="__codelineno-10-245" href="#__codelineno-10-245"></a>                <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;from_concept_id&#39;</span><span class="p">],</span>
<a id="__codelineno-10-246" name="__codelineno-10-246" href="#__codelineno-10-246"></a>                <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;to_concept_id&#39;</span><span class="p">],</span>
<a id="__codelineno-10-247" name="__codelineno-10-247" href="#__codelineno-10-247"></a>                <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;relationship_type&#39;</span><span class="p">],</span>
<a id="__codelineno-10-248" name="__codelineno-10-248" href="#__codelineno-10-248"></a>                <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span>
<a id="__codelineno-10-249" name="__codelineno-10-249" href="#__codelineno-10-249"></a>            <span class="p">)</span>
<a id="__codelineno-10-250" name="__codelineno-10-250" href="#__codelineno-10-250"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;relationships&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-10-251" name="__codelineno-10-251" href="#__codelineno-10-251"></a>
<a id="__codelineno-10-252" name="__codelineno-10-252" href="#__codelineno-10-252"></a>        <span class="k">return</span> <span class="n">stats</span>
<a id="__codelineno-10-253" name="__codelineno-10-253" href="#__codelineno-10-253"></a>
<a id="__codelineno-10-254" name="__codelineno-10-254" href="#__codelineno-10-254"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_matching_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_concept</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-10-255" name="__codelineno-10-255" href="#__codelineno-10-255"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-10-256" name="__codelineno-10-256" href="#__codelineno-10-256"></a><span class="sd">        Multi-stage concept matching</span>
<a id="__codelineno-10-257" name="__codelineno-10-257" href="#__codelineno-10-257"></a>
<a id="__codelineno-10-258" name="__codelineno-10-258" href="#__codelineno-10-258"></a><span class="sd">        Returns: concept_id if match found, None otherwise</span>
<a id="__codelineno-10-259" name="__codelineno-10-259" href="#__codelineno-10-259"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-10-260" name="__codelineno-10-260" href="#__codelineno-10-260"></a>        <span class="c1"># Stage 1: Exact ID match</span>
<a id="__codelineno-10-261" name="__codelineno-10-261" href="#__codelineno-10-261"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">concept_exists</span><span class="p">(</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]):</span>
<a id="__codelineno-10-262" name="__codelineno-10-262" href="#__codelineno-10-262"></a>            <span class="k">return</span> <span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]</span>
<a id="__codelineno-10-263" name="__codelineno-10-263" href="#__codelineno-10-263"></a>
<a id="__codelineno-10-264" name="__codelineno-10-264" href="#__codelineno-10-264"></a>        <span class="c1"># Stage 2: Vector similarity</span>
<a id="__codelineno-10-265" name="__codelineno-10-265" href="#__codelineno-10-265"></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_embedding</span><span class="p">(</span>
<a id="__codelineno-10-266" name="__codelineno-10-266" href="#__codelineno-10-266"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_concept</span><span class="p">[</span><span class="s1">&#39;search_terms&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-10-267" name="__codelineno-10-267" href="#__codelineno-10-267"></a>        <span class="p">)</span>
<a id="__codelineno-10-268" name="__codelineno-10-268" href="#__codelineno-10-268"></a>
<a id="__codelineno-10-269" name="__codelineno-10-269" href="#__codelineno-10-269"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_search</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<a id="__codelineno-10-270" name="__codelineno-10-270" href="#__codelineno-10-270"></a>        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-10-271" name="__codelineno-10-271" href="#__codelineno-10-271"></a>            <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]</span>
<a id="__codelineno-10-272" name="__codelineno-10-272" href="#__codelineno-10-272"></a>
<a id="__codelineno-10-273" name="__codelineno-10-273" href="#__codelineno-10-273"></a>        <span class="c1"># Stage 3: No match</span>
<a id="__codelineno-10-274" name="__codelineno-10-274" href="#__codelineno-10-274"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-10-275" name="__codelineno-10-275" href="#__codelineno-10-275"></a>
<a id="__codelineno-10-276" name="__codelineno-10-276" href="#__codelineno-10-276"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-10-277" name="__codelineno-10-277" href="#__codelineno-10-277"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">slugify</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-10-278" name="__codelineno-10-278" href="#__codelineno-10-278"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert text to kebab-case slug&quot;&quot;&quot;</span>
<a id="__codelineno-10-279" name="__codelineno-10-279" href="#__codelineno-10-279"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-10-280" name="__codelineno-10-280" href="#__codelineno-10-280"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-10-281" name="__codelineno-10-281" href="#__codelineno-10-281"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-10-282" name="__codelineno-10-282" href="#__codelineno-10-282"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\s_-]+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-10-283" name="__codelineno-10-283" href="#__codelineno-10-283"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-+|-+$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-10-284" name="__codelineno-10-284" href="#__codelineno-10-284"></a>        <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
<h3 id="72-example-usage">7.2 Example Usage</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># ingest_documents.py</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentProcessor</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphDatabase</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">anthropic</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="c1"># Initialize components</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">db</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="p">(</span><span class="s2">&quot;postgresql://user:pass@localhost/knowledge_graph&quot;</span><span class="p">)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">llm</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">AsyncAnthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;your-api-key&quot;</span><span class="p">)</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="n">processor</span> <span class="o">=</span> <span class="n">DocumentProcessor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="c1"># Process Watts documents</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>        <span class="p">{</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./docs/watts_lecture_1.txt&quot;</span><span class="p">),</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Watts Doc 1&quot;</span><span class="p">,</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>                <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Alan Watts&quot;</span><span class="p">,</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;lecture_transcript&quot;</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>            <span class="p">}</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>        <span class="p">}</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    <span class="p">]</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_document</span><span class="p">(</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>            <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>            <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>        <span class="p">)</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<hr />
<h2 id="8-mcp-server-specification">8. MCP Server Specification</h2>
<h3 id="81-mcp-server-architecture">8.1 MCP Server Architecture</h3>
<p>The MCP (Model Context Protocol) server provides tools for Claude Desktop to interact with the knowledge graph.</p>
<p><strong>Location:</strong> <code>mcp-knowledge-graph-server/</code></p>
<p><strong>Key files:</strong>
- <code>src/index.ts</code> - Main server implementation
- <code>src/database.ts</code> - Database queries
- <code>src/tools/</code> - Individual tool implementations
- <code>package.json</code> - Dependencies
- <code>tsconfig.json</code> - TypeScript configuration</p>
<h3 id="82-tool-definitions">8.2 Tool Definitions</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// src/index.ts</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@modelcontextprotocol/sdk/server/index.js&quot;</span><span class="p">;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StdioServerTransport</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@modelcontextprotocol/sdk/server/stdio.js&quot;</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span><span class="nx">CallToolRequestSchema</span><span class="p">,</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="nx">ListToolsRequestSchema</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@modelcontextprotocol/sdk/types.js&quot;</span><span class="p">;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="kd">const</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Server</span><span class="p">(</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;knowledge-graph-server&quot;</span><span class="p">,</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="nx">capabilities</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">      </span><span class="nx">tools</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="p">);</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="c1">// Tool definitions</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="nx">server</span><span class="p">.</span><span class="nx">setRequestHandler</span><span class="p">(</span><span class="nx">ListToolsRequestSchema</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">  </span><span class="nx">tools</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;search_concepts&quot;</span><span class="p">,</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Search for concepts using semantic similarity or keywords. Returns concepts with their sources and evidence count.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">          </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Search query - can be keywords or natural language&quot;</span><span class="w"> </span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="w">          </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Maximum number of results to return&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a><span class="w">            </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="w">          </span><span class="nx">min_similarity</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Minimum similarity score (0.0-1.0) for vector search&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="w">            </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">0.7</span><span class="w"> </span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a><span class="w">        </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;get_concept_details&quot;</span><span class="p">,</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Get comprehensive details about a specific concept including all instances (quotes), sources, and related concepts.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a><span class="w">          </span><span class="nx">concept_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;The concept_id to retrieve (e.g., &#39;linear-scanning-system&#39;)&quot;</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a><span class="w">        </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;concept_id&quot;</span><span class="p">]</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;find_related_concepts&quot;</span><span class="p">,</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Find concepts related to a given concept through various relationship types. Can traverse multiple hops.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="w">          </span><span class="nx">concept_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Starting concept_id&quot;</span>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a><span class="w">          </span><span class="nx">relationship_types</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;array&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a><span class="w">            </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Filter by relationship types: implies, contradicts, supports, part_of, requires. Leave empty for all types.&quot;</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a><span class="w">          </span><span class="nx">max_depth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a><span class="w">            </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Maximum relationship hops to traverse&quot;</span>
<a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a><span class="w">        </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;concept_id&quot;</span><span class="p">]</span>
<a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;search_by_document&quot;</span><span class="p">,</span>
<a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Find all concepts that appear in a specific document or paragraph.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a><span class="w">          </span><span class="nx">document_name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Document name to search (e.g., &#39;Watts Doc 1&#39;)&quot;</span>
<a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a><span class="w">          </span><span class="nx">paragraph</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Optional: specific paragraph number to filter by&quot;</span><span class="w"> </span>
<a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a><span class="w">        </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;document_name&quot;</span><span class="p">]</span>
<a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;find_connections&quot;</span><span class="p">,</span>
<a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Find the shortest path(s) between two concepts in the knowledge graph.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a><span class="w">          </span><span class="nx">from_concept_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-12-112" name="__codelineno-12-112" href="#__codelineno-12-112"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Starting concept&quot;</span>
<a id="__codelineno-12-113" name="__codelineno-12-113" href="#__codelineno-12-113"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-114" name="__codelineno-12-114" href="#__codelineno-12-114"></a><span class="w">          </span><span class="nx">to_concept_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-115" name="__codelineno-12-115" href="#__codelineno-12-115"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-12-116" name="__codelineno-12-116" href="#__codelineno-12-116"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Target concept&quot;</span>
<a id="__codelineno-12-117" name="__codelineno-12-117" href="#__codelineno-12-117"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-118" name="__codelineno-12-118" href="#__codelineno-12-118"></a><span class="w">          </span><span class="nx">max_hops</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-119" name="__codelineno-12-119" href="#__codelineno-12-119"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-120" name="__codelineno-12-120" href="#__codelineno-12-120"></a><span class="w">            </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<a id="__codelineno-12-121" name="__codelineno-12-121" href="#__codelineno-12-121"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Maximum number of hops to search&quot;</span>
<a id="__codelineno-12-122" name="__codelineno-12-122" href="#__codelineno-12-122"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-12-123" name="__codelineno-12-123" href="#__codelineno-12-123"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-12-124" name="__codelineno-12-124" href="#__codelineno-12-124"></a><span class="w">        </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;from_concept_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;to_concept_id&quot;</span><span class="p">]</span>
<a id="__codelineno-12-125" name="__codelineno-12-125" href="#__codelineno-12-125"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-126" name="__codelineno-12-126" href="#__codelineno-12-126"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-127" name="__codelineno-12-127" href="#__codelineno-12-127"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-128" name="__codelineno-12-128" href="#__codelineno-12-128"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;get_visualization_url&quot;</span><span class="p">,</span>
<a id="__codelineno-12-129" name="__codelineno-12-129" href="#__codelineno-12-129"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Generate a URL to visualize a subgraph in 3D. Opens in web browser for visual exploration.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-130" name="__codelineno-12-130" href="#__codelineno-12-130"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-131" name="__codelineno-12-131" href="#__codelineno-12-131"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-132" name="__codelineno-12-132" href="#__codelineno-12-132"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-133" name="__codelineno-12-133" href="#__codelineno-12-133"></a><span class="w">          </span><span class="nx">concept_ids</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-134" name="__codelineno-12-134" href="#__codelineno-12-134"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;array&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-135" name="__codelineno-12-135" href="#__codelineno-12-135"></a><span class="w">            </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-12-136" name="__codelineno-12-136" href="#__codelineno-12-136"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Concepts to include in visualization. Can be empty to use depth-based expansion.&quot;</span>
<a id="__codelineno-12-137" name="__codelineno-12-137" href="#__codelineno-12-137"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-138" name="__codelineno-12-138" href="#__codelineno-12-138"></a><span class="w">          </span><span class="nx">depth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-12-139" name="__codelineno-12-139" href="#__codelineno-12-139"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-140" name="__codelineno-12-140" href="#__codelineno-12-140"></a><span class="w">            </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-141" name="__codelineno-12-141" href="#__codelineno-12-141"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Include neighbors up to this depth from specified concepts&quot;</span><span class="w"> </span>
<a id="__codelineno-12-142" name="__codelineno-12-142" href="#__codelineno-12-142"></a><span class="w">          </span><span class="p">},</span>
<a id="__codelineno-12-143" name="__codelineno-12-143" href="#__codelineno-12-143"></a><span class="w">          </span><span class="nx">center_concept</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-144" name="__codelineno-12-144" href="#__codelineno-12-144"></a><span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-12-145" name="__codelineno-12-145" href="#__codelineno-12-145"></a><span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Optional: concept to center the visualization on&quot;</span>
<a id="__codelineno-12-146" name="__codelineno-12-146" href="#__codelineno-12-146"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-12-147" name="__codelineno-12-147" href="#__codelineno-12-147"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-148" name="__codelineno-12-148" href="#__codelineno-12-148"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-149" name="__codelineno-12-149" href="#__codelineno-12-149"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-12-150" name="__codelineno-12-150" href="#__codelineno-12-150"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-151" name="__codelineno-12-151" href="#__codelineno-12-151"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;list_documents&quot;</span><span class="p">,</span>
<a id="__codelineno-12-152" name="__codelineno-12-152" href="#__codelineno-12-152"></a><span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;List all documents in the knowledge graph with concept counts.&quot;</span><span class="p">,</span>
<a id="__codelineno-12-153" name="__codelineno-12-153" href="#__codelineno-12-153"></a><span class="w">      </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-154" name="__codelineno-12-154" href="#__codelineno-12-154"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-12-155" name="__codelineno-12-155" href="#__codelineno-12-155"></a><span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-12-156" name="__codelineno-12-156" href="#__codelineno-12-156"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-12-157" name="__codelineno-12-157" href="#__codelineno-12-157"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-158" name="__codelineno-12-158" href="#__codelineno-12-158"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-12-159" name="__codelineno-12-159" href="#__codelineno-12-159"></a><span class="p">}));</span>
<a id="__codelineno-12-160" name="__codelineno-12-160" href="#__codelineno-12-160"></a>
<a id="__codelineno-12-161" name="__codelineno-12-161" href="#__codelineno-12-161"></a><span class="c1">// Tool handler</span>
<a id="__codelineno-12-162" name="__codelineno-12-162" href="#__codelineno-12-162"></a><span class="nx">server</span><span class="p">.</span><span class="nx">setRequestHandler</span><span class="p">(</span><span class="nx">CallToolRequestSchema</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-163" name="__codelineno-12-163" href="#__codelineno-12-163"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">arguments</span><span class="o">:</span><span class="w"> </span><span class="kt">args</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
<a id="__codelineno-12-164" name="__codelineno-12-164" href="#__codelineno-12-164"></a>
<a id="__codelineno-12-165" name="__codelineno-12-165" href="#__codelineno-12-165"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-166" name="__codelineno-12-166" href="#__codelineno-12-166"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;search_concepts&quot;</span><span class="o">:</span>
<a id="__codelineno-12-167" name="__codelineno-12-167" href="#__codelineno-12-167"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">searchConcepts</span><span class="p">(</span>
<a id="__codelineno-12-168" name="__codelineno-12-168" href="#__codelineno-12-168"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-169" name="__codelineno-12-169" href="#__codelineno-12-169"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-170" name="__codelineno-12-170" href="#__codelineno-12-170"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">min_similarity</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0.7</span>
<a id="__codelineno-12-171" name="__codelineno-12-171" href="#__codelineno-12-171"></a><span class="w">      </span><span class="p">);</span>
<a id="__codelineno-12-172" name="__codelineno-12-172" href="#__codelineno-12-172"></a>
<a id="__codelineno-12-173" name="__codelineno-12-173" href="#__codelineno-12-173"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;get_concept_details&quot;</span><span class="o">:</span>
<a id="__codelineno-12-174" name="__codelineno-12-174" href="#__codelineno-12-174"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getConceptDetails</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">concept_id</span><span class="p">);</span>
<a id="__codelineno-12-175" name="__codelineno-12-175" href="#__codelineno-12-175"></a>
<a id="__codelineno-12-176" name="__codelineno-12-176" href="#__codelineno-12-176"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;find_related_concepts&quot;</span><span class="o">:</span>
<a id="__codelineno-12-177" name="__codelineno-12-177" href="#__codelineno-12-177"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findRelatedConcepts</span><span class="p">(</span>
<a id="__codelineno-12-178" name="__codelineno-12-178" href="#__codelineno-12-178"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">concept_id</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-179" name="__codelineno-12-179" href="#__codelineno-12-179"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">relationship_types</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="p">[],</span>
<a id="__codelineno-12-180" name="__codelineno-12-180" href="#__codelineno-12-180"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">max_depth</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">2</span>
<a id="__codelineno-12-181" name="__codelineno-12-181" href="#__codelineno-12-181"></a><span class="w">      </span><span class="p">);</span>
<a id="__codelineno-12-182" name="__codelineno-12-182" href="#__codelineno-12-182"></a>
<a id="__codelineno-12-183" name="__codelineno-12-183" href="#__codelineno-12-183"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;search_by_document&quot;</span><span class="o">:</span>
<a id="__codelineno-12-184" name="__codelineno-12-184" href="#__codelineno-12-184"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">searchByDocument</span><span class="p">(</span>
<a id="__codelineno-12-185" name="__codelineno-12-185" href="#__codelineno-12-185"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">document_name</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-12-186" name="__codelineno-12-186" href="#__codelineno-12-186"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">paragraph</span>
<a id="__codelineno-12-187" name="__codelineno-12-187" href="#__codelineno-12-187"></a><span class="w">      </span><span class="p">);</span>
<a id="__codelineno-12-188" name="__codelineno-12-188" href="#__codelineno-12-188"></a>
<a id="__codelineno-12-189" name="__codelineno-12-189" href="#__codelineno-12-189"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;find_connections&quot;</span><span class="o">:</span>
<a id="__codelineno-12-190" name="__codelineno-12-190" href="#__codelineno-12-190"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findConnections</span><span class="p">(</span>
<a id="__codelineno-12-191" name="__codelineno-12-191" href="#__codelineno-12-191"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">from_concept_id</span><span class="p">,</span>
<a id="__codelineno-12-192" name="__codelineno-12-192" href="#__codelineno-12-192"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">to_concept_id</span><span class="p">,</span>
<a id="__codelineno-12-193" name="__codelineno-12-193" href="#__codelineno-12-193"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">max_hops</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">5</span>
<a id="__codelineno-12-194" name="__codelineno-12-194" href="#__codelineno-12-194"></a><span class="w">      </span><span class="p">);</span>
<a id="__codelineno-12-195" name="__codelineno-12-195" href="#__codelineno-12-195"></a>
<a id="__codelineno-12-196" name="__codelineno-12-196" href="#__codelineno-12-196"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;get_visualization_url&quot;</span><span class="o">:</span>
<a id="__codelineno-12-197" name="__codelineno-12-197" href="#__codelineno-12-197"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getVisualizationUrl</span><span class="p">(</span>
<a id="__codelineno-12-198" name="__codelineno-12-198" href="#__codelineno-12-198"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">concept_ids</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="p">[],</span>
<a id="__codelineno-12-199" name="__codelineno-12-199" href="#__codelineno-12-199"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">depth</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<a id="__codelineno-12-200" name="__codelineno-12-200" href="#__codelineno-12-200"></a><span class="w">        </span><span class="nx">args</span><span class="p">.</span><span class="nx">center_concept</span>
<a id="__codelineno-12-201" name="__codelineno-12-201" href="#__codelineno-12-201"></a><span class="w">      </span><span class="p">);</span>
<a id="__codelineno-12-202" name="__codelineno-12-202" href="#__codelineno-12-202"></a>
<a id="__codelineno-12-203" name="__codelineno-12-203" href="#__codelineno-12-203"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;list_documents&quot;</span><span class="o">:</span>
<a id="__codelineno-12-204" name="__codelineno-12-204" href="#__codelineno-12-204"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">listDocuments</span><span class="p">();</span>
<a id="__codelineno-12-205" name="__codelineno-12-205" href="#__codelineno-12-205"></a>
<a id="__codelineno-12-206" name="__codelineno-12-206" href="#__codelineno-12-206"></a><span class="w">    </span><span class="nx">default</span><span class="o">:</span>
<a id="__codelineno-12-207" name="__codelineno-12-207" href="#__codelineno-12-207"></a><span class="w">      </span><span class="kt">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unknown tool: </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-12-208" name="__codelineno-12-208" href="#__codelineno-12-208"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-12-209" name="__codelineno-12-209" href="#__codelineno-12-209"></a><span class="p">});</span>
<a id="__codelineno-12-210" name="__codelineno-12-210" href="#__codelineno-12-210"></a>
<a id="__codelineno-12-211" name="__codelineno-12-211" href="#__codelineno-12-211"></a><span class="c1">// Start server</span>
<a id="__codelineno-12-212" name="__codelineno-12-212" href="#__codelineno-12-212"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-213" name="__codelineno-12-213" href="#__codelineno-12-213"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">StdioServerTransport</span><span class="p">();</span>
<a id="__codelineno-12-214" name="__codelineno-12-214" href="#__codelineno-12-214"></a><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">server</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">transport</span><span class="p">);</span>
<a id="__codelineno-12-215" name="__codelineno-12-215" href="#__codelineno-12-215"></a><span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Knowledge Graph MCP server running on stdio&quot;</span><span class="p">);</span>
<a id="__codelineno-12-216" name="__codelineno-12-216" href="#__codelineno-12-216"></a><span class="p">}</span>
<a id="__codelineno-12-217" name="__codelineno-12-217" href="#__codelineno-12-217"></a>
<a id="__codelineno-12-218" name="__codelineno-12-218" href="#__codelineno-12-218"></a><span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</code></pre></div>
<h3 id="83-tool-implementation-examples">8.3 Tool Implementation Examples</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">// src/database.ts</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;pg&#39;</span><span class="p">;</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">import</span><span class="w"> </span><span class="nx">OpenAI</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;openai&#39;</span><span class="p">;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Client</span><span class="p">({</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="nx">connectionString</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.DATABASE_URL</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">});</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kd">const</span><span class="w"> </span><span class="nx">openai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenAI</span><span class="p">({</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">  </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.OPENAI_API_KEY</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="p">});</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="c1">// Generate embedding for search</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">generateEmbedding</span><span class="p">(</span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">number</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">embeddings</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">    </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">,</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">embedding</span><span class="p">;</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="p">}</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="c1">// Search concepts by semantic similarity</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">searchConcepts</span><span class="p">(</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">  </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">  </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">  </span><span class="nx">minSimilarity</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">embedding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">generateEmbedding</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="sb">    SELECT </span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="sb">      c.concept_id,</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="sb">      c.label,</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="sb">      1 - (c.embedding &lt;=&gt; $1::vector) as similarity,</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="sb">      array_agg(DISTINCT s.document) as documents,</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="sb">      count(DISTINCT i.instance_id) as evidence_count</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a><span class="sb">    FROM concepts c</span>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a><span class="sb">    LEFT JOIN concept_sources cs ON c.concept_id = cs.concept_id</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a><span class="sb">    LEFT JOIN sources s ON cs.source_id = s.source_id</span>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a><span class="sb">    LEFT JOIN instances i ON c.concept_id = i.concept_id</span>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a><span class="sb">    WHERE 1 - (c.embedding &lt;=&gt; $1::vector) &gt; $2</span>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a><span class="sb">    GROUP BY c.concept_id, c.label, c.embedding</span>
<a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a><span class="sb">    ORDER BY similarity DESC</span>
<a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a><span class="sb">    LIMIT $3</span>
<a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">embedding</span><span class="p">),</span><span class="w"> </span><span class="nx">minSimilarity</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">]);</span>
<a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>
<a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a><span class="w">        </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span>
<a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a><span class="w">        </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">result.rows</span>
<a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a><span class="p">}</span>
<a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>
<a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a><span class="c1">// Get concept details with instances</span>
<a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a><span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getConceptDetails</span><span class="p">(</span><span class="nx">conceptId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">conceptResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a><span class="sb">    SELECT c.*, array_agg(DISTINCT s.document) as documents</span>
<a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a><span class="sb">    FROM concepts c</span>
<a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a><span class="sb">    LEFT JOIN concept_sources cs ON c.concept_id = cs.concept_id</span>
<a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a><span class="sb">    LEFT JOIN sources s ON cs.source_id = s.source_id</span>
<a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a><span class="sb">    WHERE c.concept_id = $1</span>
<a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a><span class="sb">    GROUP BY c.concept_id</span>
<a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">conceptId</span><span class="p">]);</span>
<a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>
<a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">conceptResult</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Concept not found: </span><span class="si">${</span><span class="nx">conceptId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a>
<a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">instancesResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a><span class="sb">    SELECT i.quote, s.document, s.paragraph, s.source_id</span>
<a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a><span class="sb">    FROM instances i</span>
<a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a><span class="sb">    JOIN sources s ON i.source_id = s.source_id</span>
<a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a><span class="sb">    WHERE i.concept_id = $1</span>
<a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a><span class="sb">    ORDER BY s.document, s.paragraph</span>
<a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">conceptId</span><span class="p">]);</span>
<a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a>
<a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">relationshipsResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-84" name="__codelineno-13-84" href="#__codelineno-13-84"></a><span class="sb">    SELECT </span>
<a id="__codelineno-13-85" name="__codelineno-13-85" href="#__codelineno-13-85"></a><span class="sb">      cr.to_concept_id,</span>
<a id="__codelineno-13-86" name="__codelineno-13-86" href="#__codelineno-13-86"></a><span class="sb">      c.label as to_label,</span>
<a id="__codelineno-13-87" name="__codelineno-13-87" href="#__codelineno-13-87"></a><span class="sb">      cr.relationship_type,</span>
<a id="__codelineno-13-88" name="__codelineno-13-88" href="#__codelineno-13-88"></a><span class="sb">      cr.confidence</span>
<a id="__codelineno-13-89" name="__codelineno-13-89" href="#__codelineno-13-89"></a><span class="sb">    FROM concept_relationships cr</span>
<a id="__codelineno-13-90" name="__codelineno-13-90" href="#__codelineno-13-90"></a><span class="sb">    JOIN concepts c ON cr.to_concept_id = c.concept_id</span>
<a id="__codelineno-13-91" name="__codelineno-13-91" href="#__codelineno-13-91"></a><span class="sb">    WHERE cr.from_concept_id = $1</span>
<a id="__codelineno-13-92" name="__codelineno-13-92" href="#__codelineno-13-92"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">conceptId</span><span class="p">]);</span>
<a id="__codelineno-13-93" name="__codelineno-13-93" href="#__codelineno-13-93"></a>
<a id="__codelineno-13-94" name="__codelineno-13-94" href="#__codelineno-13-94"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-95" name="__codelineno-13-95" href="#__codelineno-13-95"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-13-96" name="__codelineno-13-96" href="#__codelineno-13-96"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-13-97" name="__codelineno-13-97" href="#__codelineno-13-97"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-13-98" name="__codelineno-13-98" href="#__codelineno-13-98"></a><span class="w">        </span><span class="nx">concept</span><span class="o">:</span><span class="w"> </span><span class="kt">conceptResult.rows</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
<a id="__codelineno-13-99" name="__codelineno-13-99" href="#__codelineno-13-99"></a><span class="w">        </span><span class="nx">instances</span><span class="o">:</span><span class="w"> </span><span class="kt">instancesResult.rows</span><span class="p">,</span>
<a id="__codelineno-13-100" name="__codelineno-13-100" href="#__codelineno-13-100"></a><span class="w">        </span><span class="nx">relationships</span><span class="o">:</span><span class="w"> </span><span class="kt">relationshipsResult.rows</span>
<a id="__codelineno-13-101" name="__codelineno-13-101" href="#__codelineno-13-101"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-13-102" name="__codelineno-13-102" href="#__codelineno-13-102"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-13-103" name="__codelineno-13-103" href="#__codelineno-13-103"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-13-104" name="__codelineno-13-104" href="#__codelineno-13-104"></a><span class="p">}</span>
<a id="__codelineno-13-105" name="__codelineno-13-105" href="#__codelineno-13-105"></a>
<a id="__codelineno-13-106" name="__codelineno-13-106" href="#__codelineno-13-106"></a><span class="c1">// Find connections between concepts</span>
<a id="__codelineno-13-107" name="__codelineno-13-107" href="#__codelineno-13-107"></a><span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">findConnections</span><span class="p">(</span>
<a id="__codelineno-13-108" name="__codelineno-13-108" href="#__codelineno-13-108"></a><span class="w">  </span><span class="nx">fromId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-13-109" name="__codelineno-13-109" href="#__codelineno-13-109"></a><span class="w">  </span><span class="nx">toId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-13-110" name="__codelineno-13-110" href="#__codelineno-13-110"></a><span class="w">  </span><span class="nx">maxHops</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<a id="__codelineno-13-111" name="__codelineno-13-111" href="#__codelineno-13-111"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-112" name="__codelineno-13-112" href="#__codelineno-13-112"></a><span class="w">  </span><span class="c1">// Use recursive CTE to find paths</span>
<a id="__codelineno-13-113" name="__codelineno-13-113" href="#__codelineno-13-113"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-114" name="__codelineno-13-114" href="#__codelineno-13-114"></a><span class="sb">    WITH RECURSIVE paths AS (</span>
<a id="__codelineno-13-115" name="__codelineno-13-115" href="#__codelineno-13-115"></a><span class="sb">      -- Base case: direct relationships</span>
<a id="__codelineno-13-116" name="__codelineno-13-116" href="#__codelineno-13-116"></a><span class="sb">      SELECT </span>
<a id="__codelineno-13-117" name="__codelineno-13-117" href="#__codelineno-13-117"></a><span class="sb">        from_concept_id,</span>
<a id="__codelineno-13-118" name="__codelineno-13-118" href="#__codelineno-13-118"></a><span class="sb">        to_concept_id,</span>
<a id="__codelineno-13-119" name="__codelineno-13-119" href="#__codelineno-13-119"></a><span class="sb">        relationship_type,</span>
<a id="__codelineno-13-120" name="__codelineno-13-120" href="#__codelineno-13-120"></a><span class="sb">        ARRAY[from_concept_id, to_concept_id] as path,</span>
<a id="__codelineno-13-121" name="__codelineno-13-121" href="#__codelineno-13-121"></a><span class="sb">        1 as depth</span>
<a id="__codelineno-13-122" name="__codelineno-13-122" href="#__codelineno-13-122"></a><span class="sb">      FROM concept_relationships</span>
<a id="__codelineno-13-123" name="__codelineno-13-123" href="#__codelineno-13-123"></a><span class="sb">      WHERE from_concept_id = $1</span>
<a id="__codelineno-13-124" name="__codelineno-13-124" href="#__codelineno-13-124"></a>
<a id="__codelineno-13-125" name="__codelineno-13-125" href="#__codelineno-13-125"></a><span class="sb">      UNION ALL</span>
<a id="__codelineno-13-126" name="__codelineno-13-126" href="#__codelineno-13-126"></a>
<a id="__codelineno-13-127" name="__codelineno-13-127" href="#__codelineno-13-127"></a><span class="sb">      -- Recursive case: extend paths</span>
<a id="__codelineno-13-128" name="__codelineno-13-128" href="#__codelineno-13-128"></a><span class="sb">      SELECT </span>
<a id="__codelineno-13-129" name="__codelineno-13-129" href="#__codelineno-13-129"></a><span class="sb">        p.from_concept_id,</span>
<a id="__codelineno-13-130" name="__codelineno-13-130" href="#__codelineno-13-130"></a><span class="sb">        cr.to_concept_id,</span>
<a id="__codelineno-13-131" name="__codelineno-13-131" href="#__codelineno-13-131"></a><span class="sb">        cr.relationship_type,</span>
<a id="__codelineno-13-132" name="__codelineno-13-132" href="#__codelineno-13-132"></a><span class="sb">        p.path || cr.to_concept_id,</span>
<a id="__codelineno-13-133" name="__codelineno-13-133" href="#__codelineno-13-133"></a><span class="sb">        p.depth + 1</span>
<a id="__codelineno-13-134" name="__codelineno-13-134" href="#__codelineno-13-134"></a><span class="sb">      FROM paths p</span>
<a id="__codelineno-13-135" name="__codelineno-13-135" href="#__codelineno-13-135"></a><span class="sb">      JOIN concept_relationships cr ON p.to_concept_id = cr.from_concept_id</span>
<a id="__codelineno-13-136" name="__codelineno-13-136" href="#__codelineno-13-136"></a><span class="sb">      WHERE </span>
<a id="__codelineno-13-137" name="__codelineno-13-137" href="#__codelineno-13-137"></a><span class="sb">        NOT cr.to_concept_id = ANY(p.path)  -- Prevent cycles</span>
<a id="__codelineno-13-138" name="__codelineno-13-138" href="#__codelineno-13-138"></a><span class="sb">        AND p.depth &lt; $3</span>
<a id="__codelineno-13-139" name="__codelineno-13-139" href="#__codelineno-13-139"></a><span class="sb">    )</span>
<a id="__codelineno-13-140" name="__codelineno-13-140" href="#__codelineno-13-140"></a><span class="sb">    SELECT </span>
<a id="__codelineno-13-141" name="__codelineno-13-141" href="#__codelineno-13-141"></a><span class="sb">      path,</span>
<a id="__codelineno-13-142" name="__codelineno-13-142" href="#__codelineno-13-142"></a><span class="sb">      depth,</span>
<a id="__codelineno-13-143" name="__codelineno-13-143" href="#__codelineno-13-143"></a><span class="sb">      array_agg(relationship_type) as relationship_types</span>
<a id="__codelineno-13-144" name="__codelineno-13-144" href="#__codelineno-13-144"></a><span class="sb">    FROM paths</span>
<a id="__codelineno-13-145" name="__codelineno-13-145" href="#__codelineno-13-145"></a><span class="sb">    WHERE to_concept_id = $2</span>
<a id="__codelineno-13-146" name="__codelineno-13-146" href="#__codelineno-13-146"></a><span class="sb">    GROUP BY path, depth</span>
<a id="__codelineno-13-147" name="__codelineno-13-147" href="#__codelineno-13-147"></a><span class="sb">    ORDER BY depth</span>
<a id="__codelineno-13-148" name="__codelineno-13-148" href="#__codelineno-13-148"></a><span class="sb">    LIMIT 5</span>
<a id="__codelineno-13-149" name="__codelineno-13-149" href="#__codelineno-13-149"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">fromId</span><span class="p">,</span><span class="w"> </span><span class="nx">toId</span><span class="p">,</span><span class="w"> </span><span class="nx">maxHops</span><span class="p">]);</span>
<a id="__codelineno-13-150" name="__codelineno-13-150" href="#__codelineno-13-150"></a>
<a id="__codelineno-13-151" name="__codelineno-13-151" href="#__codelineno-13-151"></a><span class="w">  </span><span class="c1">// Enrich with concept labels</span>
<a id="__codelineno-13-152" name="__codelineno-13-152" href="#__codelineno-13-152"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">enrichedPaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<a id="__codelineno-13-153" name="__codelineno-13-153" href="#__codelineno-13-153"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-154" name="__codelineno-13-154" href="#__codelineno-13-154"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-155" name="__codelineno-13-155" href="#__codelineno-13-155"></a><span class="sb">      SELECT concept_id, label</span>
<a id="__codelineno-13-156" name="__codelineno-13-156" href="#__codelineno-13-156"></a><span class="sb">      FROM concepts</span>
<a id="__codelineno-13-157" name="__codelineno-13-157" href="#__codelineno-13-157"></a><span class="sb">      WHERE concept_id = ANY($1)</span>
<a id="__codelineno-13-158" name="__codelineno-13-158" href="#__codelineno-13-158"></a><span class="sb">    `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">row</span><span class="p">.</span><span class="nx">path</span><span class="p">]);</span>
<a id="__codelineno-13-159" name="__codelineno-13-159" href="#__codelineno-13-159"></a>
<a id="__codelineno-13-160" name="__codelineno-13-160" href="#__codelineno-13-160"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">labelMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span>
<a id="__codelineno-13-161" name="__codelineno-13-161" href="#__codelineno-13-161"></a><span class="w">      </span><span class="nx">labels</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">concept_id</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">label</span><span class="p">])</span>
<a id="__codelineno-13-162" name="__codelineno-13-162" href="#__codelineno-13-162"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-13-163" name="__codelineno-13-163" href="#__codelineno-13-163"></a>
<a id="__codelineno-13-164" name="__codelineno-13-164" href="#__codelineno-13-164"></a><span class="w">    </span><span class="nx">enrichedPaths</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<a id="__codelineno-13-165" name="__codelineno-13-165" href="#__codelineno-13-165"></a><span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">row.path.map</span><span class="p">((</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<a id="__codelineno-13-166" name="__codelineno-13-166" href="#__codelineno-13-166"></a><span class="w">        </span><span class="nx">concept_id</span><span class="o">:</span><span class="w"> </span><span class="kt">id</span><span class="p">,</span>
<a id="__codelineno-13-167" name="__codelineno-13-167" href="#__codelineno-13-167"></a><span class="w">        </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">labelMap</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
<a id="__codelineno-13-168" name="__codelineno-13-168" href="#__codelineno-13-168"></a><span class="w">      </span><span class="p">})),</span>
<a id="__codelineno-13-169" name="__codelineno-13-169" href="#__codelineno-13-169"></a><span class="w">      </span><span class="nx">depth</span><span class="o">:</span><span class="w"> </span><span class="kt">row.depth</span><span class="p">,</span>
<a id="__codelineno-13-170" name="__codelineno-13-170" href="#__codelineno-13-170"></a><span class="w">      </span><span class="nx">relationship_types</span><span class="o">:</span><span class="w"> </span><span class="kt">row.relationship_types</span>
<a id="__codelineno-13-171" name="__codelineno-13-171" href="#__codelineno-13-171"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-13-172" name="__codelineno-13-172" href="#__codelineno-13-172"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-13-173" name="__codelineno-13-173" href="#__codelineno-13-173"></a>
<a id="__codelineno-13-174" name="__codelineno-13-174" href="#__codelineno-13-174"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-175" name="__codelineno-13-175" href="#__codelineno-13-175"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-13-176" name="__codelineno-13-176" href="#__codelineno-13-176"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-13-177" name="__codelineno-13-177" href="#__codelineno-13-177"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-13-178" name="__codelineno-13-178" href="#__codelineno-13-178"></a><span class="w">        </span><span class="nx">from</span><span class="o">:</span><span class="w"> </span><span class="kt">fromId</span><span class="p">,</span>
<a id="__codelineno-13-179" name="__codelineno-13-179" href="#__codelineno-13-179"></a><span class="w">        </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="kt">toId</span><span class="p">,</span>
<a id="__codelineno-13-180" name="__codelineno-13-180" href="#__codelineno-13-180"></a><span class="w">        </span><span class="nx">paths</span><span class="o">:</span><span class="w"> </span><span class="kt">enrichedPaths</span><span class="p">,</span>
<a id="__codelineno-13-181" name="__codelineno-13-181" href="#__codelineno-13-181"></a><span class="w">        </span><span class="nx">paths_found</span><span class="o">:</span><span class="w"> </span><span class="kt">enrichedPaths.length</span>
<a id="__codelineno-13-182" name="__codelineno-13-182" href="#__codelineno-13-182"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-13-183" name="__codelineno-13-183" href="#__codelineno-13-183"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-13-184" name="__codelineno-13-184" href="#__codelineno-13-184"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-13-185" name="__codelineno-13-185" href="#__codelineno-13-185"></a><span class="p">}</span>
<a id="__codelineno-13-186" name="__codelineno-13-186" href="#__codelineno-13-186"></a>
<a id="__codelineno-13-187" name="__codelineno-13-187" href="#__codelineno-13-187"></a><span class="c1">// Generate visualization URL</span>
<a id="__codelineno-13-188" name="__codelineno-13-188" href="#__codelineno-13-188"></a><span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getVisualizationUrl</span><span class="p">(</span>
<a id="__codelineno-13-189" name="__codelineno-13-189" href="#__codelineno-13-189"></a><span class="w">  </span><span class="nx">conceptIds</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span>
<a id="__codelineno-13-190" name="__codelineno-13-190" href="#__codelineno-13-190"></a><span class="w">  </span><span class="nx">depth</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<a id="__codelineno-13-191" name="__codelineno-13-191" href="#__codelineno-13-191"></a><span class="w">  </span><span class="nx">centerConcept?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-13-192" name="__codelineno-13-192" href="#__codelineno-13-192"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-193" name="__codelineno-13-193" href="#__codelineno-13-193"></a><span class="w">  </span><span class="c1">// Generate unique session ID</span>
<a id="__codelineno-13-194" name="__codelineno-13-194" href="#__codelineno-13-194"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sessionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mf">7</span><span class="p">);</span>
<a id="__codelineno-13-195" name="__codelineno-13-195" href="#__codelineno-13-195"></a>
<a id="__codelineno-13-196" name="__codelineno-13-196" href="#__codelineno-13-196"></a><span class="w">  </span><span class="c1">// Store visualization config in temporary table or cache</span>
<a id="__codelineno-13-197" name="__codelineno-13-197" href="#__codelineno-13-197"></a><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-13-198" name="__codelineno-13-198" href="#__codelineno-13-198"></a><span class="sb">    INSERT INTO visualization_sessions (session_id, concept_ids, depth, center_concept, created_at)</span>
<a id="__codelineno-13-199" name="__codelineno-13-199" href="#__codelineno-13-199"></a><span class="sb">    VALUES ($1, $2, $3, $4, NOW())</span>
<a id="__codelineno-13-200" name="__codelineno-13-200" href="#__codelineno-13-200"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">sessionId</span><span class="p">,</span><span class="w"> </span><span class="nx">conceptIds</span><span class="p">,</span><span class="w"> </span><span class="nx">depth</span><span class="p">,</span><span class="w"> </span><span class="nx">centerConcept</span><span class="p">]);</span>
<a id="__codelineno-13-201" name="__codelineno-13-201" href="#__codelineno-13-201"></a>
<a id="__codelineno-13-202" name="__codelineno-13-202" href="#__codelineno-13-202"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VISUALIZATION_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">;</span>
<a id="__codelineno-13-203" name="__codelineno-13-203" href="#__codelineno-13-203"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/viz/</span><span class="si">${</span><span class="nx">sessionId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<a id="__codelineno-13-204" name="__codelineno-13-204" href="#__codelineno-13-204"></a>
<a id="__codelineno-13-205" name="__codelineno-13-205" href="#__codelineno-13-205"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-206" name="__codelineno-13-206" href="#__codelineno-13-206"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-13-207" name="__codelineno-13-207" href="#__codelineno-13-207"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-13-208" name="__codelineno-13-208" href="#__codelineno-13-208"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-13-209" name="__codelineno-13-209" href="#__codelineno-13-209"></a><span class="w">        </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">url</span><span class="p">,</span>
<a id="__codelineno-13-210" name="__codelineno-13-210" href="#__codelineno-13-210"></a><span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Open this URL in your browser to explore the graph in 3D&quot;</span><span class="p">,</span>
<a id="__codelineno-13-211" name="__codelineno-13-211" href="#__codelineno-13-211"></a><span class="w">        </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-212" name="__codelineno-13-212" href="#__codelineno-13-212"></a><span class="w">          </span><span class="nx">concept_ids</span><span class="o">:</span><span class="w"> </span><span class="kt">conceptIds</span><span class="p">,</span>
<a id="__codelineno-13-213" name="__codelineno-13-213" href="#__codelineno-13-213"></a><span class="w">          </span><span class="nx">depth</span><span class="o">:</span><span class="w"> </span><span class="kt">depth</span><span class="p">,</span>
<a id="__codelineno-13-214" name="__codelineno-13-214" href="#__codelineno-13-214"></a><span class="w">          </span><span class="nx">center</span><span class="o">:</span><span class="w"> </span><span class="kt">centerConcept</span>
<a id="__codelineno-13-215" name="__codelineno-13-215" href="#__codelineno-13-215"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-13-216" name="__codelineno-13-216" href="#__codelineno-13-216"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-13-217" name="__codelineno-13-217" href="#__codelineno-13-217"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-13-218" name="__codelineno-13-218" href="#__codelineno-13-218"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-13-219" name="__codelineno-13-219" href="#__codelineno-13-219"></a><span class="p">}</span>
</code></pre></div>
<h3 id="84-claude-desktop-configuration">8.4 Claude Desktop Configuration</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nt">&quot;mcpServers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="nt">&quot;knowledge-graph&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">      </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;node&quot;</span><span class="p">,</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">      </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">        </span><span class="s2">&quot;/absolute/path/to/mcp-knowledge-graph-server/build/index.js&quot;</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">      </span><span class="p">],</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">        </span><span class="nt">&quot;DATABASE_URL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgresql://user:password@localhost:5432/knowledge_graph&quot;</span><span class="p">,</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">        </span><span class="nt">&quot;OPENAI_API_KEY&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sk-...&quot;</span><span class="p">,</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">        </span><span class="nt">&quot;VISUALIZATION_URL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://localhost:3000&quot;</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Location:</strong> <code>~/Library/Application Support/Claude/claude_desktop_config.json</code> (macOS)</p>
<hr />
<h2 id="9-3d-visualization-interface">9. 3D Visualization Interface</h2>
<h3 id="91-visualization-architecture">9.1 Visualization Architecture</h3>
<p><strong>Tech Stack:</strong>
- React + TypeScript
- force-graph-3d (Three.js wrapper)
- FastAPI backend
- WebSocket for real-time updates (optional)</p>
<h3 id="92-frontend-implementation">9.2 Frontend Implementation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">// src/components/Graph3DViewer.tsx</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">import</span><span class="w"> </span><span class="nx">ForceGraph3D</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-force-graph-3d&#39;</span><span class="p">;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">THREE</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;three&#39;</span><span class="p">;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">Node</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">  </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">  </span><span class="nx">sources</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">  </span><span class="nx">evidenceCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">  </span><span class="nx">color?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="p">}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">Link</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">  </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">  </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">  </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">  </span><span class="nx">confidence</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="p">}</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">GraphData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">  </span><span class="nx">nodes</span><span class="o">:</span><span class="w"> </span><span class="kt">Node</span><span class="p">[];</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">  </span><span class="nx">links</span><span class="o">:</span><span class="w"> </span><span class="kt">Link</span><span class="p">[];</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="p">}</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">Graph3DViewerProps</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">  </span><span class="nx">sessionId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="p">}</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Graph3DViewer</span><span class="p">({</span><span class="w"> </span><span class="nx">sessionId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">Graph3DViewerProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">graphData</span><span class="p">,</span><span class="w"> </span><span class="nx">setGraphData</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">GraphData</span><span class="o">&gt;</span><span class="p">({</span><span class="w"> </span><span class="nx">nodes</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">links</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">selectedNode</span><span class="p">,</span><span class="w"> </span><span class="nx">setSelectedNode</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Node</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">loading</span><span class="p">,</span><span class="w"> </span><span class="nx">setLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fgRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">    </span><span class="c1">// Fetch graph data from API</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/graph/session/</span><span class="si">${</span><span class="nx">sessionId</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="w">        </span><span class="nx">setGraphData</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="w">        </span><span class="nx">setLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a><span class="w">      </span><span class="p">})</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to load graph:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="w">        </span><span class="nx">setLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a><span class="w">      </span><span class="p">});</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a><span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">sessionId</span><span class="p">]);</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleNodeClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">Node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a><span class="w">    </span><span class="nx">setSelectedNode</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a><span class="w">    </span><span class="c1">// Fetch full concept details</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a><span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/concept/</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">details</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a><span class="w">        </span><span class="c1">// Update side panel with details</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a><span class="w">        </span><span class="nx">setSelectedNode</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">details</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a><span class="w">      </span><span class="p">});</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">getNodeColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">Node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a><span class="w">    </span><span class="c1">// Color by number of sources</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">sources</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sourceCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;#ff6b6b&#39;</span><span class="p">;</span><span class="w">  </span><span class="c1">// Red: appears in many docs</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sourceCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;#ffd93d&#39;</span><span class="p">;</span><span class="w">  </span><span class="c1">// Yellow: medium frequency</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;#6bcf7f&#39;</span><span class="p">;</span><span class="w">  </span><span class="c1">// Green: single or few sources</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">getLinkColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">link</span><span class="o">:</span><span class="w"> </span><span class="kt">Link</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a><span class="w">    </span><span class="c1">// Color by relationship type</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a><span class="w">      </span><span class="s1">&#39;implies&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4dabf7&#39;</span><span class="p">,</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a><span class="w">      </span><span class="s1">&#39;contradicts&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff6b6b&#39;</span><span class="p">,</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a><span class="w">      </span><span class="s1">&#39;supports&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#51cf66&#39;</span><span class="p">,</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a><span class="w">      </span><span class="s1">&#39;part_of&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#845ef7&#39;</span><span class="p">,</span>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a><span class="w">      </span><span class="s1">&#39;requires&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ffd43b&#39;</span>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nx">link</span><span class="p">.</span><span class="kr">type</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;#adb5bd&#39;</span><span class="p">;</span>
<a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>
<a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">loading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;loading&quot;</span><span class="o">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">graph</span><span class="p">...</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
<a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a>
<a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;graph-container&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;graph-3d&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a><span class="w">        </span><span class="o">&lt;</span><span class="nx">ForceGraph3D</span>
<a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a><span class="w">          </span><span class="nx">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">fgRef</span><span class="p">}</span>
<a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a><span class="w">          </span><span class="nx">graphData</span><span class="o">=</span><span class="p">{</span><span class="nx">graphData</span><span class="p">}</span>
<a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>
<a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a><span class="w">          </span><span class="c1">// Node configuration</span>
<a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a><span class="w">          </span><span class="nx">nodeLabel</span><span class="o">=</span><span class="p">{(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">\n</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">evidenceCount</span><span class="si">}</span><span class="sb"> instances`</span><span class="p">}</span>
<a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a><span class="w">          </span><span class="nx">nodeAutoColorBy</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span>
<a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a><span class="w">          </span><span class="nx">nodeColor</span><span class="o">=</span><span class="p">{</span><span class="nx">getNodeColor</span><span class="p">}</span>
<a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a><span class="w">          </span><span class="nx">nodeVal</span><span class="o">=</span><span class="p">{(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">evidenceCount</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span>
<a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>
<a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a><span class="w">          </span><span class="c1">// Link configuration</span>
<a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a><span class="w">          </span><span class="nx">linkDirectionalArrowLength</span><span class="o">=</span><span class="p">{</span><span class="mf">3.5</span><span class="p">}</span>
<a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a><span class="w">          </span><span class="nx">linkDirectionalArrowRelPos</span><span class="o">=</span><span class="p">{</span><span class="mf">1</span><span class="p">}</span>
<a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a><span class="w">          </span><span class="nx">linkCurvature</span><span class="o">=</span><span class="p">{</span><span class="mf">0.25</span><span class="p">}</span>
<a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a><span class="w">          </span><span class="nx">linkLabel</span><span class="o">=</span><span class="p">{(</span><span class="nx">link</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">link</span><span class="p">.</span><span class="kr">type</span><span class="si">}</span><span class="sb"> (</span><span class="si">${</span><span class="nx">link</span><span class="p">.</span><span class="nx">confidence</span><span class="si">}</span><span class="sb">)`</span><span class="p">}</span>
<a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a><span class="w">          </span><span class="nx">linkColor</span><span class="o">=</span><span class="p">{</span><span class="nx">getLinkColor</span><span class="p">}</span>
<a id="__codelineno-15-105" name="__codelineno-15-105" href="#__codelineno-15-105"></a><span class="w">          </span><span class="nx">linkWidth</span><span class="o">=</span><span class="p">{(</span><span class="nx">link</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">link</span><span class="p">.</span><span class="nx">confidence</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">}</span>
<a id="__codelineno-15-106" name="__codelineno-15-106" href="#__codelineno-15-106"></a>
<a id="__codelineno-15-107" name="__codelineno-15-107" href="#__codelineno-15-107"></a><span class="w">          </span><span class="c1">// Interaction</span>
<a id="__codelineno-15-108" name="__codelineno-15-108" href="#__codelineno-15-108"></a><span class="w">          </span><span class="nx">onNodeClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleNodeClick</span><span class="p">}</span>
<a id="__codelineno-15-109" name="__codelineno-15-109" href="#__codelineno-15-109"></a><span class="w">          </span><span class="nx">onNodeHover</span><span class="o">=</span><span class="p">{(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-110" name="__codelineno-15-110" href="#__codelineno-15-110"></a><span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;pointer&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">;</span>
<a id="__codelineno-15-111" name="__codelineno-15-111" href="#__codelineno-15-111"></a><span class="w">          </span><span class="p">}}</span>
<a id="__codelineno-15-112" name="__codelineno-15-112" href="#__codelineno-15-112"></a>
<a id="__codelineno-15-113" name="__codelineno-15-113" href="#__codelineno-15-113"></a><span class="w">          </span><span class="c1">// Custom rendering</span>
<a id="__codelineno-15-114" name="__codelineno-15-114" href="#__codelineno-15-114"></a><span class="w">          </span><span class="nx">nodeThreeObject</span><span class="o">=</span><span class="p">{(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-115" name="__codelineno-15-115" href="#__codelineno-15-115"></a><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">sprite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">THREE</span><span class="p">.</span><span class="nx">Sprite</span><span class="p">(</span>
<a id="__codelineno-15-116" name="__codelineno-15-116" href="#__codelineno-15-116"></a><span class="w">              </span><span class="ow">new</span><span class="w"> </span><span class="nx">THREE</span><span class="p">.</span><span class="nx">SpriteMaterial</span><span class="p">({</span>
<a id="__codelineno-15-117" name="__codelineno-15-117" href="#__codelineno-15-117"></a><span class="w">                </span><span class="nx">map</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nx">THREE</span><span class="p">.</span><span class="nx">CanvasTexture</span><span class="p">(</span>
<a id="__codelineno-15-118" name="__codelineno-15-118" href="#__codelineno-15-118"></a><span class="w">                  </span><span class="nx">generateNodeTexture</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="p">)</span>
<a id="__codelineno-15-119" name="__codelineno-15-119" href="#__codelineno-15-119"></a><span class="w">                </span><span class="p">),</span>
<a id="__codelineno-15-120" name="__codelineno-15-120" href="#__codelineno-15-120"></a><span class="w">                </span><span class="nx">transparent</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span>
<a id="__codelineno-15-121" name="__codelineno-15-121" href="#__codelineno-15-121"></a><span class="w">              </span><span class="p">})</span>
<a id="__codelineno-15-122" name="__codelineno-15-122" href="#__codelineno-15-122"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-15-123" name="__codelineno-15-123" href="#__codelineno-15-123"></a><span class="w">            </span><span class="nx">sprite</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mf">12</span><span class="p">,</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<a id="__codelineno-15-124" name="__codelineno-15-124" href="#__codelineno-15-124"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">sprite</span><span class="p">;</span>
<a id="__codelineno-15-125" name="__codelineno-15-125" href="#__codelineno-15-125"></a><span class="w">          </span><span class="p">}}</span>
<a id="__codelineno-15-126" name="__codelineno-15-126" href="#__codelineno-15-126"></a>
<a id="__codelineno-15-127" name="__codelineno-15-127" href="#__codelineno-15-127"></a><span class="w">          </span><span class="c1">// Camera</span>
<a id="__codelineno-15-128" name="__codelineno-15-128" href="#__codelineno-15-128"></a><span class="w">          </span><span class="nx">backgroundColor</span><span class="o">=</span><span class="s2">&quot;#1a1a1a&quot;</span>
<a id="__codelineno-15-129" name="__codelineno-15-129" href="#__codelineno-15-129"></a><span class="w">        </span><span class="o">/&gt;</span>
<a id="__codelineno-15-130" name="__codelineno-15-130" href="#__codelineno-15-130"></a><span class="w">      </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-15-131" name="__codelineno-15-131" href="#__codelineno-15-131"></a>
<a id="__codelineno-15-132" name="__codelineno-15-132" href="#__codelineno-15-132"></a><span class="w">      </span><span class="p">{</span><span class="nx">selectedNode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-15-133" name="__codelineno-15-133" href="#__codelineno-15-133"></a><span class="w">        </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;side-panel&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-15-134" name="__codelineno-15-134" href="#__codelineno-15-134"></a><span class="w">          </span><span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">selectedNode</span><span class="p">.</span><span class="nx">label</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
<a id="__codelineno-15-135" name="__codelineno-15-135" href="#__codelineno-15-135"></a><span class="w">          </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;node-details&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-15-136" name="__codelineno-15-136" href="#__codelineno-15-136"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Sources</span><span class="o">:&lt;</span><span class="err">/h3&gt;</span>
<a id="__codelineno-15-137" name="__codelineno-15-137" href="#__codelineno-15-137"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
<a id="__codelineno-15-138" name="__codelineno-15-138" href="#__codelineno-15-138"></a><span class="w">              </span><span class="p">{</span><span class="nx">selectedNode</span><span class="p">.</span><span class="nx">sources</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">src</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-15-139" name="__codelineno-15-139" href="#__codelineno-15-139"></a><span class="w">                </span><span class="o">&lt;</span><span class="nx">li</span><span class="w"> </span><span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">src</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">src</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
<a id="__codelineno-15-140" name="__codelineno-15-140" href="#__codelineno-15-140"></a><span class="w">              </span><span class="p">))}</span>
<a id="__codelineno-15-141" name="__codelineno-15-141" href="#__codelineno-15-141"></a><span class="w">            </span><span class="o">&lt;</span><span class="err">/ul&gt;</span>
<a id="__codelineno-15-142" name="__codelineno-15-142" href="#__codelineno-15-142"></a>
<a id="__codelineno-15-143" name="__codelineno-15-143" href="#__codelineno-15-143"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Evidence</span><span class="w"> </span><span class="p">({</span><span class="nx">selectedNode</span><span class="p">.</span><span class="nx">evidenceCount</span><span class="p">}</span><span class="w"> </span><span class="nx">instances</span><span class="p">)</span><span class="o">:&lt;</span><span class="err">/h3&gt;</span>
<a id="__codelineno-15-144" name="__codelineno-15-144" href="#__codelineno-15-144"></a><span class="w">            </span><span class="p">{</span><span class="cm">/* Render instances if available */</span><span class="p">}</span>
<a id="__codelineno-15-145" name="__codelineno-15-145" href="#__codelineno-15-145"></a>
<a id="__codelineno-15-146" name="__codelineno-15-146" href="#__codelineno-15-146"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">button</span><span class="w"> </span><span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-147" name="__codelineno-15-147" href="#__codelineno-15-147"></a><span class="w">              </span><span class="c1">// Expand graph from this node</span>
<a id="__codelineno-15-148" name="__codelineno-15-148" href="#__codelineno-15-148"></a><span class="w">              </span><span class="nx">expandFromNode</span><span class="p">(</span><span class="nx">selectedNode</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<a id="__codelineno-15-149" name="__codelineno-15-149" href="#__codelineno-15-149"></a><span class="w">            </span><span class="p">}}</span><span class="o">&gt;</span>
<a id="__codelineno-15-150" name="__codelineno-15-150" href="#__codelineno-15-150"></a><span class="w">              </span><span class="nx">Expand</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="nx">concept</span>
<a id="__codelineno-15-151" name="__codelineno-15-151" href="#__codelineno-15-151"></a><span class="w">            </span><span class="o">&lt;</span><span class="err">/button&gt;</span>
<a id="__codelineno-15-152" name="__codelineno-15-152" href="#__codelineno-15-152"></a><span class="w">          </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-15-153" name="__codelineno-15-153" href="#__codelineno-15-153"></a><span class="w">        </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-15-154" name="__codelineno-15-154" href="#__codelineno-15-154"></a><span class="w">      </span><span class="p">)}</span>
<a id="__codelineno-15-155" name="__codelineno-15-155" href="#__codelineno-15-155"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-15-156" name="__codelineno-15-156" href="#__codelineno-15-156"></a><span class="w">  </span><span class="p">);</span>
<a id="__codelineno-15-157" name="__codelineno-15-157" href="#__codelineno-15-157"></a><span class="p">}</span>
<a id="__codelineno-15-158" name="__codelineno-15-158" href="#__codelineno-15-158"></a>
<a id="__codelineno-15-159" name="__codelineno-15-159" href="#__codelineno-15-159"></a><span class="c1">// Helper function to generate node texture</span>
<a id="__codelineno-15-160" name="__codelineno-15-160" href="#__codelineno-15-160"></a><span class="kd">function</span><span class="w"> </span><span class="nx">generateNodeTexture</span><span class="p">(</span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">HTMLCanvasElement</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-161" name="__codelineno-15-161" href="#__codelineno-15-161"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
<a id="__codelineno-15-162" name="__codelineno-15-162" href="#__codelineno-15-162"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
<a id="__codelineno-15-163" name="__codelineno-15-163" href="#__codelineno-15-163"></a>
<a id="__codelineno-15-164" name="__codelineno-15-164" href="#__codelineno-15-164"></a><span class="w">  </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">256</span><span class="p">;</span>
<a id="__codelineno-15-165" name="__codelineno-15-165" href="#__codelineno-15-165"></a><span class="w">  </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<a id="__codelineno-15-166" name="__codelineno-15-166" href="#__codelineno-15-166"></a>
<a id="__codelineno-15-167" name="__codelineno-15-167" href="#__codelineno-15-167"></a><span class="w">  </span><span class="c1">// Background</span>
<a id="__codelineno-15-168" name="__codelineno-15-168" href="#__codelineno-15-168"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;rgba(0, 0, 0, 0.8)&#39;</span><span class="p">;</span>
<a id="__codelineno-15-169" name="__codelineno-15-169" href="#__codelineno-15-169"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">256</span><span class="p">,</span><span class="w"> </span><span class="mf">128</span><span class="p">);</span>
<a id="__codelineno-15-170" name="__codelineno-15-170" href="#__codelineno-15-170"></a>
<a id="__codelineno-15-171" name="__codelineno-15-171" href="#__codelineno-15-171"></a><span class="w">  </span><span class="c1">// Text</span>
<a id="__codelineno-15-172" name="__codelineno-15-172" href="#__codelineno-15-172"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<a id="__codelineno-15-173" name="__codelineno-15-173" href="#__codelineno-15-173"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;20px Arial&#39;</span><span class="p">;</span>
<a id="__codelineno-15-174" name="__codelineno-15-174" href="#__codelineno-15-174"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">textAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">;</span>
<a id="__codelineno-15-175" name="__codelineno-15-175" href="#__codelineno-15-175"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">textBaseline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;middle&#39;</span><span class="p">;</span>
<a id="__codelineno-15-176" name="__codelineno-15-176" href="#__codelineno-15-176"></a>
<a id="__codelineno-15-177" name="__codelineno-15-177" href="#__codelineno-15-177"></a><span class="w">  </span><span class="c1">// Word wrap</span>
<a id="__codelineno-15-178" name="__codelineno-15-178" href="#__codelineno-15-178"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">label</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<a id="__codelineno-15-179" name="__codelineno-15-179" href="#__codelineno-15-179"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<a id="__codelineno-15-180" name="__codelineno-15-180" href="#__codelineno-15-180"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">64</span><span class="p">;</span>
<a id="__codelineno-15-181" name="__codelineno-15-181" href="#__codelineno-15-181"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lineHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">25</span><span class="p">;</span>
<a id="__codelineno-15-182" name="__codelineno-15-182" href="#__codelineno-15-182"></a>
<a id="__codelineno-15-183" name="__codelineno-15-183" href="#__codelineno-15-183"></a><span class="w">  </span><span class="nx">words</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">word</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-184" name="__codelineno-15-184" href="#__codelineno-15-184"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">testLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">word</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">;</span>
<a id="__codelineno-15-185" name="__codelineno-15-185" href="#__codelineno-15-185"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">testLine</span><span class="p">);</span>
<a id="__codelineno-15-186" name="__codelineno-15-186" href="#__codelineno-15-186"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">230</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-187" name="__codelineno-15-187" href="#__codelineno-15-187"></a><span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="mf">128</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">);</span>
<a id="__codelineno-15-188" name="__codelineno-15-188" href="#__codelineno-15-188"></a><span class="w">      </span><span class="nx">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">word</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">;</span>
<a id="__codelineno-15-189" name="__codelineno-15-189" href="#__codelineno-15-189"></a><span class="w">      </span><span class="nx">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">lineHeight</span><span class="p">;</span>
<a id="__codelineno-15-190" name="__codelineno-15-190" href="#__codelineno-15-190"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-191" name="__codelineno-15-191" href="#__codelineno-15-191"></a><span class="w">      </span><span class="nx">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">testLine</span><span class="p">;</span>
<a id="__codelineno-15-192" name="__codelineno-15-192" href="#__codelineno-15-192"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-193" name="__codelineno-15-193" href="#__codelineno-15-193"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-15-194" name="__codelineno-15-194" href="#__codelineno-15-194"></a><span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="mf">128</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">);</span>
<a id="__codelineno-15-195" name="__codelineno-15-195" href="#__codelineno-15-195"></a>
<a id="__codelineno-15-196" name="__codelineno-15-196" href="#__codelineno-15-196"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">canvas</span><span class="p">;</span>
<a id="__codelineno-15-197" name="__codelineno-15-197" href="#__codelineno-15-197"></a><span class="p">}</span>
</code></pre></div>
<h3 id="93-backend-api">9.3 Backend API</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># api/main.py</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncpg</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Knowledge Graph Visualization API&quot;</span><span class="p">)</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="c1"># CORS for local development</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">CORSMiddleware</span><span class="p">,</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">],</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="p">)</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="c1"># Database connection</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">():</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncpg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">))</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/graph/session/</span><span class="si">{session_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_session_graph</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="sd">    Retrieve graph data for a visualization session</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>    <span class="n">db</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_db</span><span class="p">()</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>        <span class="c1"># Get session config</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>        <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchrow</span><span class="p">(</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>            <span class="s2">&quot;SELECT * FROM visualization_sessions WHERE session_id = $1&quot;</span><span class="p">,</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>            <span class="n">session_id</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>        <span class="p">)</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Session not found&quot;</span><span class="p">)</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>        <span class="n">concept_ids</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;concept_ids&#39;</span><span class="p">]</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>        <span class="n">depth</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>        <span class="c1"># Build subgraph</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>        <span class="k">if</span> <span class="n">concept_ids</span><span class="p">:</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>            <span class="c1"># Start from specified concepts</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="s2">            WITH RECURSIVE subgraph AS (</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="s2">                -- Base: specified concepts</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="s2">                SELECT concept_id, label, 0 as distance</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="s2">                FROM concepts</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="s2">                WHERE concept_id = ANY($1)</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a><span class="s2">                UNION</span>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a><span class="s2">                -- Recursive: neighbors</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="s2">                SELECT c.concept_id, c.label, sg.distance + 1</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="s2">                FROM subgraph sg</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a><span class="s2">                JOIN concept_relationships cr ON </span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a><span class="s2">                    cr.from_concept_id = sg.concept_id OR</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a><span class="s2">                    cr.to_concept_id = sg.concept_id</span>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="s2">                JOIN concepts c ON </span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a><span class="s2">                    c.concept_id = cr.from_concept_id OR</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a><span class="s2">                    c.concept_id = cr.to_concept_id</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="s2">                WHERE sg.distance &lt; $2</span>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a><span class="s2">                AND c.concept_id != sg.concept_id</span>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a><span class="s2">            )</span>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a><span class="s2">            SELECT DISTINCT </span>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a><span class="s2">                c.concept_id,</span>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a><span class="s2">                c.label,</span>
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a><span class="s2">                array_agg(DISTINCT s.document) as sources,</span>
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a><span class="s2">                count(DISTINCT i.instance_id) as evidence_count</span>
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a><span class="s2">            FROM subgraph sg</span>
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a><span class="s2">            JOIN concepts c ON sg.concept_id = c.concept_id</span>
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a><span class="s2">            LEFT JOIN concept_sources cs ON c.concept_id = cs.concept_id</span>
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a><span class="s2">            LEFT JOIN sources s ON cs.source_id = s.source_id</span>
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a><span class="s2">            LEFT JOIN instances i ON c.concept_id = i.concept_id</span>
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a><span class="s2">            GROUP BY c.concept_id, c.label</span>
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a><span class="s2">            &quot;&quot;&quot;</span>
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>            <span class="n">nodes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">concept_ids</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>            <span class="c1"># No specific concepts: return top concepts by centrality</span>
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>            <span class="n">nodes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a><span class="s2">                SELECT </span>
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a><span class="s2">                    c.concept_id,</span>
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a><span class="s2">                    c.label,</span>
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a><span class="s2">                    array_agg(DISTINCT s.document) as sources,</span>
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a><span class="s2">                    count(DISTINCT i.instance_id) as evidence_count</span>
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a><span class="s2">                FROM concepts c</span>
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a><span class="s2">                LEFT JOIN concept_sources cs ON c.concept_id = cs.concept_id</span>
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a><span class="s2">                LEFT JOIN sources s ON cs.source_id = s.source_id</span>
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a><span class="s2">                LEFT JOIN instances i ON c.concept_id = i.concept_id</span>
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a><span class="s2">                GROUP BY c.concept_id, c.label</span>
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a><span class="s2">                ORDER BY count(DISTINCT i.instance_id) DESC</span>
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a><span class="s2">                LIMIT 50</span>
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>
<a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>        <span class="n">node_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
<a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>
<a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>        <span class="c1"># Get relationships between these nodes</span>
<a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>        <span class="n">links</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a><span class="s2">            SELECT </span>
<a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a><span class="s2">                from_concept_id as source,</span>
<a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a><span class="s2">                to_concept_id as target,</span>
<a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a><span class="s2">                relationship_type as type,</span>
<a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a><span class="s2">                confidence</span>
<a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a><span class="s2">            FROM concept_relationships</span>
<a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a><span class="s2">            WHERE from_concept_id = ANY($1)</span>
<a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a><span class="s2">            AND to_concept_id = ANY($1)</span>
<a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">node_ids</span><span class="p">)</span>
<a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>
<a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">],</span>
<a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>            <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span>
<a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>        <span class="p">}</span>
<a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>
<a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a>
<a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/concept/</span><span class="si">{concept_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_concept_full</span><span class="p">(</span><span class="n">concept_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a><span class="sd">    Get full concept details including instances</span>
<a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>    <span class="n">db</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_db</span><span class="p">()</span>
<a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>
<a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a>        <span class="n">concept</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchrow</span><span class="p">(</span>
<a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>            <span class="s2">&quot;SELECT * FROM concepts WHERE concept_id = $1&quot;</span><span class="p">,</span>
<a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>            <span class="n">concept_id</span>
<a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>        <span class="p">)</span>
<a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>
<a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">concept</span><span class="p">:</span>
<a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Concept not found&quot;</span><span class="p">)</span>
<a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a>
<a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a>        <span class="n">instances</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a><span class="s2">            SELECT i.quote, s.document, s.paragraph</span>
<a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a><span class="s2">            FROM instances i</span>
<a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a><span class="s2">            JOIN sources s ON i.source_id = s.source_id</span>
<a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a><span class="s2">            WHERE i.concept_id = $1</span>
<a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a><span class="s2">            ORDER BY s.document, s.paragraph</span>
<a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">)</span>
<a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a>
<a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a>        <span class="n">relationships</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a><span class="s2">            SELECT </span>
<a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a><span class="s2">                to_concept_id,</span>
<a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a><span class="s2">                c.label as to_label,</span>
<a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a><span class="s2">                relationship_type,</span>
<a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a><span class="s2">                confidence</span>
<a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a><span class="s2">            FROM concept_relationships cr</span>
<a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a><span class="s2">            JOIN concepts c ON cr.to_concept_id = c.concept_id</span>
<a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a><span class="s2">            WHERE from_concept_id = $1</span>
<a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">)</span>
<a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a>
<a id="__codelineno-16-154" name="__codelineno-16-154" href="#__codelineno-16-154"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-16-155" name="__codelineno-16-155" href="#__codelineno-16-155"></a>            <span class="s2">&quot;concept&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">concept</span><span class="p">),</span>
<a id="__codelineno-16-156" name="__codelineno-16-156" href="#__codelineno-16-156"></a>            <span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">],</span>
<a id="__codelineno-16-157" name="__codelineno-16-157" href="#__codelineno-16-157"></a>            <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relationships</span><span class="p">]</span>
<a id="__codelineno-16-158" name="__codelineno-16-158" href="#__codelineno-16-158"></a>        <span class="p">}</span>
<a id="__codelineno-16-159" name="__codelineno-16-159" href="#__codelineno-16-159"></a>
<a id="__codelineno-16-160" name="__codelineno-16-160" href="#__codelineno-16-160"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-16-161" name="__codelineno-16-161" href="#__codelineno-16-161"></a>        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-16-162" name="__codelineno-16-162" href="#__codelineno-16-162"></a>
<a id="__codelineno-16-163" name="__codelineno-16-163" href="#__codelineno-16-163"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/graph/expand/</span><span class="si">{concept_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-164" name="__codelineno-16-164" href="#__codelineno-16-164"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">expand_from_concept</span><span class="p">(</span><span class="n">concept_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-16-165" name="__codelineno-16-165" href="#__codelineno-16-165"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-166" name="__codelineno-16-166" href="#__codelineno-16-166"></a><span class="sd">    Expand graph from a specific concept</span>
<a id="__codelineno-16-167" name="__codelineno-16-167" href="#__codelineno-16-167"></a><span class="sd">    Returns additional nodes and links</span>
<a id="__codelineno-16-168" name="__codelineno-16-168" href="#__codelineno-16-168"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-169" name="__codelineno-16-169" href="#__codelineno-16-169"></a>    <span class="c1"># Similar to get_session_graph but starts from one concept</span>
<a id="__codelineno-16-170" name="__codelineno-16-170" href="#__codelineno-16-170"></a>    <span class="k">pass</span>
</code></pre></div>
<h3 id="94-visualization-features">9.4 Visualization Features</h3>
<p><strong>Interactive Controls:</strong>
- Mouse drag: Rotate camera
- Scroll: Zoom in/out
- Click node: Show details panel
- Double-click node: Center on node
- Right-click node: Expand from this concept</p>
<p><strong>Visual Encoding:</strong>
- <strong>Node size</strong>: Proportional to evidence count (number of instances)
- <strong>Node color</strong>: By number of source documents (green=1, yellow=3+, red=5+)
- <strong>Link color</strong>: By relationship type (blue=implies, red=contradicts, etc.)
- <strong>Link thickness</strong>: By confidence score</p>
<p><strong>UI Elements:</strong>
- Search bar: Find and highlight concepts
- Filters: Show/hide relationship types
- Legend: Explain colors and symbols
- Mini-map: Show overview of large graphs
- Export: Save as image or export data</p>
<hr />
<h2 id="10-implementation-examples">10. Implementation Examples</h2>
<h3 id="101-example-processing-watts-documents">10.1 Example: Processing Watts Documents</h3>
<p><strong>Input Files:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>docs/
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>  watts_lecture_1.txt
</code></pre></div></p>
<p><strong>Content (watts_lecture_1.txt):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>So the geneticists are now saying and many others are now saying that man must take the course of his evolution into his own hands. He can no longer trust the wiggly random and unintelligible processes of nature to develop him any further but he must interfere with his own intelligence. And through genetic alterations breed the kind of people who will be viable for human society and that sort of thing. Now this I submit is a ghastly era. Because human intelligence has a very serious limitation. That limitation is. That it is a scanning system, of conscious attention, which is linear. That is to say, it examines the world, in lines. Rather as you would pass the beam of a flashlight across a room or a spotlight. That&#39;s why our education takes so long. It takes so long because we have to scan miles of lines of print. And we regard that you see as basic information
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Now the universe does not come at us in lines. It comes at us. In a multidimensional continuum in which everything is happening all together everywhere at once. And it comes at us much too quickly, to be translated into lines of print. Or of other information, however fast they may be scanned. And that is our limitation so far as the intellectual life and the scientific life is concerned. The computer will greatly speed up the linear scanning. But it&#39;s still linear scanning. And so long as we are stuck with that form of wisdom we cannot deal with more than a few variables at once. Now what do I mean by that. What is a variable? A variable is any one linear process let&#39;s take music when you play a bar few. And there are four parts to it you have four variables you have four moving lines and you can take care of that with two hands. An organist using two feet can put into more variables and have six going and you may realize if you&#39;ve ever tried to play the organ that it&#39;s quite difficult to make six independent motions go at once. The average person cannot do that without training the average person cannot deal with more than three variables at once without using a pencil. Now when we study physics we are dealing with processes in which there are millions of variables. This however we handle by statistics in the same way as insurance companies use actuarial tables to predict when most people will die. If the average age of death is sixty five however, this prediction does not apply to any given individual. Any given individual will live to plus or minus sixty five years. And the range of difference may be very wide indeed of course. But this is all right the sixty five guesses all right when you&#39;re doing large scale gambling. And that&#39;s the way the physicist works in predicting the behavior of nuclear wavicles. But the practical problems of human life deal with variables in the hundreds of thousands. Here statistical methods are very poor. And thinking it out by linear consideration is impossible. With that equipment then we are proposing to interfere with our genes. And with that equipment also be it said we are trying to solve our political economic and social problems. And naturally everybody has the sense of total frustration. And the individual feels &#39;what what on earth can I do? &#39;
</code></pre></div></p>
<p><strong>Run ingestion:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>python<span class="w"> </span>ingest_documents.py<span class="w"> </span>--file<span class="w"> </span>docs/watts_lecture_1.txt<span class="w"> </span>--document<span class="w"> </span><span class="s2">&quot;Watts Doc 1&quot;</span>
</code></pre></div></p>
<p><strong>Expected Graph Output (Mermaid visualization):</strong></p>
<pre class="mermaid"><code>graph TD
    A["Human-directed evolution&lt;br/&gt;(Watts Doc 1, Para 1)"] --&gt; B["Nature is unreliable&lt;br/&gt;(Watts Doc 1, Para 1)"]
    B --&gt; C["Genetic intervention needed&lt;br/&gt;(Watts Doc 1, Para 1)"]
    C --&gt; D["Breeding viable people&lt;br/&gt;(Watts Doc 1, Para 1)"]

    D --&gt; E["Ghastly era&lt;br/&gt;(Watts Doc 1, Para 1)"]

    E --&gt; F["Intelligence limitation&lt;br/&gt;(Watts Doc 1, Para 1, 2)"]
    F --&gt; G["Linear scanning system&lt;br/&gt;(Watts Doc 1, Para 1, 2)"]
    G --&gt; H["Sequential examination&lt;br/&gt;(Watts Doc 1, Para 1)"]
    H --&gt; I["Flashlight metaphor&lt;br/&gt;(Watts Doc 1, Para 1)"]

    G --&gt; J["Education takes time&lt;br/&gt;(Watts Doc 1, Para 1)"]
    J --&gt; K["Scanning lines of text&lt;br/&gt;(Watts Doc 1, Para 1)"]
    K --&gt; L["Linear information paradigm&lt;br/&gt;(Watts Doc 1, Para 1)"]

    F --&gt; M["Multidimensional reality&lt;br/&gt;(Watts Doc 1, Para 2)"]
    M --&gt; N["Everything simultaneous&lt;br/&gt;(Watts Doc 1, Para 2)"]
    N --&gt; O["Too fast for linear translation&lt;br/&gt;(Watts Doc 1, Para 2)"]

    G --&gt; P["Limited variable handling&lt;br/&gt;(Watts Doc 1, Para 2)"]
    P --&gt; Q["Statistics for many variables&lt;br/&gt;(Watts Doc 1, Para 2)"]
    Q --&gt; R["Stats work for large scale&lt;br/&gt;(Watts Doc 1, Para 2)"]
    R --&gt; S["Poor for human complexity&lt;br/&gt;(Watts Doc 1, Para 2)"]

    S --&gt; T["Inadequate tools for intervention&lt;br/&gt;(Watts Doc 1, Para 2)"]
    T --&gt; C
    T --&gt; U["Inadequate for social problems&lt;br/&gt;(Watts Doc 1, Para 2)"]

    U --&gt; V["Total frustration&lt;br/&gt;(Watts Doc 1, Para 2)"]
    V --&gt; W["Individual helplessness&lt;br/&gt;(Watts Doc 1, Para 2)"]</code></pre>
<h3 id="102-example-claude-desktop-conversation">10.2 Example: Claude Desktop Conversation</h3>
<p><strong>User query via Claude Desktop:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>User: &quot;What concepts appear in Watts Doc 1 about linear thinking?&quot;
</code></pre></div></p>
<p><strong>Claude uses MCP tool:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nx">search_concepts</span><span class="p">({</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;linear thinking&quot;</span><span class="p">,</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="nx">min_similarity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.7</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="p">})</span>
</code></pre></div></p>
<p><strong>Tool returns:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">  </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear thinking&quot;</span><span class="p">,</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="nt">&quot;results&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">      </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Linear scanning system&quot;</span><span class="p">,</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">      </span><span class="nt">&quot;similarity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.93</span><span class="p">,</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">      </span><span class="nt">&quot;documents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Watts Doc 1&quot;</span><span class="p">],</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">      </span><span class="nt">&quot;evidence_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sequential-examination&quot;</span><span class="p">,</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">      </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Sequential examination&quot;</span><span class="p">,</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">      </span><span class="nt">&quot;similarity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.87</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">      </span><span class="nt">&quot;documents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Watts Doc 1&quot;</span><span class="p">],</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">      </span><span class="nt">&quot;evidence_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">      </span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;limited-variable-handling&quot;</span><span class="p">,</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">      </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Limited variable handling&quot;</span><span class="p">,</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">      </span><span class="nt">&quot;similarity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.82</span><span class="p">,</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">      </span><span class="nt">&quot;documents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Watts Doc 1&quot;</span><span class="p">],</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">      </span><span class="nt">&quot;evidence_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Claude's response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>I found 3 key concepts in Watts Doc 1 related to linear thinking:
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>1. **Linear scanning system** (3 instances)
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>   - Watts describes human intelligence as a &quot;scanning system of conscious attention, which is linear&quot;
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>   - This is the core limitation he identifies
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>2. **Sequential examination** (1 instance)
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>   - The idea that we examine the world &quot;in lines&quot;
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>   - Like &quot;passing the beam of a flashlight across a room&quot;
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>3. **Limited variable handling** (2 instances)
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>   - Because of linear processing, &quot;the average person cannot deal with more than three variables at once&quot;
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>   - This limitation makes it impossible to handle complex real-world problems
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>Would you like to see how these concepts relate to each other, or explore the evidence from the text?
</code></pre></div></p>
<p><strong>User follow-up:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>User: &quot;How do these concepts connect to Watts&#39; critique of genetic intervention?&quot;
</code></pre></div></p>
<p><strong>Claude uses:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nx">find_connections</span><span class="p">({</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">  </span><span class="nx">from_concept_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">  </span><span class="nx">to_concept_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;genetic-intervention-needed&quot;</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="nx">max_hops</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="p">})</span>
</code></pre></div></p>
<p><strong>Tool returns path:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">  </span><span class="nt">&quot;from&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="nt">&quot;to&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;genetic-intervention-needed&quot;</span><span class="p">,</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">  </span><span class="nt">&quot;paths&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">        </span><span class="p">{</span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Linear scanning system&quot;</span><span class="p">},</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">        </span><span class="p">{</span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;intelligence-limitation&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Intelligence limitation&quot;</span><span class="p">},</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">        </span><span class="p">{</span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;inadequate-tools-for-intervention&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Inadequate tools for intervention&quot;</span><span class="p">},</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">        </span><span class="p">{</span><span class="nt">&quot;concept_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;genetic-intervention-needed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Genetic intervention needed&quot;</span><span class="p">}</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">      </span><span class="p">],</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">      </span><span class="nt">&quot;depth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">      </span><span class="nt">&quot;relationship_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;part_of&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;implies&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;contradicts&quot;</span><span class="p">]</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">  </span><span class="nt">&quot;paths_found&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Claude's response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>I found the connection! Watts creates an ironic argument:
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>Linear scanning system 
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>   (part of)
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>Intelligence limitation 
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>   (implies)
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>Inadequate tools for intervention 
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>   (contradicts)
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>Genetic intervention needed
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>The irony: We&#39;re proposing to use our limited, linear intelligence (which can&#39;t handle complex variables) to interfere with our own genetic evolution. As Watts says: &quot;With that equipment then we are proposing to interfere with our genes.&quot;
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>Would you like to visualize this connection in 3D to see the broader context?
</code></pre></div></p>
<p><strong>User:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Yes, show me the visualization
</code></pre></div></p>
<p><strong>Claude uses:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nx">get_visualization_url</span><span class="p">({</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">  </span><span class="nx">concept_ids</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="s2">&quot;linear-scanning-system&quot;</span><span class="p">,</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="s2">&quot;genetic-intervention-needed&quot;</span><span class="p">,</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="s2">&quot;intelligence-limitation&quot;</span><span class="p">,</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="s2">&quot;inadequate-tools-for-intervention&quot;</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">  </span><span class="nx">depth</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">  </span><span class="nx">center_concept</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;intelligence-limitation&quot;</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="p">})</span>
</code></pre></div></p>
<p><strong>Response:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>View the 3D graph here: http://localhost:3000/viz/a7f3k9m
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>This visualization shows the concepts and their relationships, centered on &quot;Intelligence limitation&quot;. You can:
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>- Rotate to see different perspectives
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>- Click nodes to see evidence from the text
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>- Explore related concepts
</code></pre></div></p>
<hr />
<h2 id="11-technology-stack">11. Technology Stack</h2>
<h3 id="111-core-technologies">11.1 Core Technologies</h3>
<p><strong>Document Processing:</strong>
- Python 3.11+
- Anthropic SDK (Claude API)
- PyPDF2 or pypdf (PDF parsing)
- python-docx (Word document parsing)
- Beautiful Soup 4 (HTML parsing)
- asyncio (concurrent processing)</p>
<p><strong>Graph Database:</strong>
- <strong>Current:</strong> PostgreSQL 16+ with Apache AGE (graph extension)
- <strong>Note:</strong> Migrated from Neo4j to Apache AGE per ADR-016</p>
<p><strong>Vector Search:</strong>
- pgvector (PostgreSQL extension)
- OpenAI Embeddings API (text-embedding-3-small)</p>
<p><strong>MCP Server:</strong>
- Node.js 18+
- TypeScript 5+
- @modelcontextprotocol/sdk
- pg (PostgreSQL client)
- openai (embeddings)</p>
<p><strong>Visualization:</strong>
- React 18+
- TypeScript 5+
- force-graph-3d
- Three.js
- D3.js (optional, for layouts)</p>
<p><strong>Backend API:</strong>
- FastAPI (Python)
- asyncpg (async PostgreSQL)
- Pydantic (data validation)</p>
<p><strong>Infrastructure:</strong>
- Docker &amp; Docker Compose
- GitHub (version control)
- Environment variable management (.env)</p>
<h3 id="112-development-dependencies">11.2 Development Dependencies</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">// package.json (MCP Server)</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="p">{</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mcp-knowledge-graph-server&quot;</span><span class="p">,</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="p">,</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="nt">&quot;@modelcontextprotocol/sdk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">    </span><span class="nt">&quot;pg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^8.11.3&quot;</span><span class="p">,</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="nt">&quot;openai&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.20.0&quot;</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">    </span><span class="nt">&quot;@types/node&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^20.10.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">    </span><span class="nt">&quot;@types/pg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^8.10.9&quot;</span><span class="p">,</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.3.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">    </span><span class="nt">&quot;tsx&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.7.0&quot;</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1">// package.json (Visualization)</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="p">{</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;knowledge-graph-viz&quot;</span><span class="p">,</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="nt">&quot;react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.2.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="nt">&quot;react-dom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.2.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="nt">&quot;react-force-graph-3d&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^1.24.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">    </span><span class="nt">&quot;three&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.160.0&quot;</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">    </span><span class="nt">&quot;@types/react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.2.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">    </span><span class="nt">&quot;@types/three&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.160.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.3.0&quot;</span><span class="p">,</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">    </span><span class="nt">&quot;vite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.0.0&quot;</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># requirements.txt (Python)</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">anthropic</span><span class="o">&gt;=</span><span class="mf">0.18.0</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="n">asyncpg</span><span class="o">&gt;=</span><span class="mf">0.29.0</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="n">fastapi</span><span class="o">&gt;=</span><span class="mf">0.109.0</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="n">uvicorn</span><span class="o">&gt;=</span><span class="mf">0.27.0</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="n">pydantic</span><span class="o">&gt;=</span><span class="mf">2.5.0</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="n">python</span><span class="o">-</span><span class="n">dotenv</span><span class="o">&gt;=</span><span class="mf">1.0.0</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="n">PyPDF2</span><span class="o">&gt;=</span><span class="mf">3.0.0</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="n">python</span><span class="o">-</span><span class="n">docx</span><span class="o">&gt;=</span><span class="mf">1.1.0</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="n">beautifulsoup4</span><span class="o">&gt;=</span><span class="mf">4.12.0</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="n">openai</span><span class="o">&gt;=</span><span class="mf">1.10.0</span>
</code></pre></div>
<h3 id="113-infrastructure-setup">11.3 Infrastructure Setup</h3>
<p><strong>Docker Compose:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># docker-compose.yml</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">  </span><span class="nt">postgres</span><span class="p">:</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pgvector/pgvector:pg15</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">      </span><span class="nt">POSTGRES_DB</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">knowledge_graph</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">      </span><span class="nt">POSTGRES_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kg_user</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">      </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;5432:5432&quot;</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./init.sql:/docker-entrypoint-initdb.d/init.sql</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="w">  </span><span class="nt">api</span><span class="p">:</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./api</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="w">      </span><span class="nt">DATABASE_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql://kg_user:${POSTGRES_PASSWORD}@postgres:5432/knowledge_graph</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="w">      </span><span class="nt">OPENAI_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${OPENAI_API_KEY}</span>
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./api:/app</span>
<a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>
<a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a><span class="w">  </span><span class="nt">viz</span><span class="p">:</span>
<a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./visualization</span>
<a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3000:3000&quot;</span>
<a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a><span class="w">      </span><span class="nt">REACT_APP_API_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost:8000</span>
<a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./visualization:/app</span>
<a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a>
<a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a><span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span>
</code></pre></div></p>
<hr />
<h2 id="12-implementation-roadmap">12. Implementation Roadmap</h2>
<h3 id="phase-1-foundation-weeks-1-2">Phase 1: Foundation (Weeks 1-2)</h3>
<p><strong>Goals:</strong>
- Set up core infrastructure
- Implement basic document ingestion
- Create simple MCP server</p>
<p><strong>Deliverables:</strong>
1. PostgreSQL + pgvector database
2. Document parser (text files)
3. LLM extraction pipeline (single paragraph)
4. Basic concept storage with vector embeddings
5. MCP server with 3 tools:
   - search_concepts
   - get_concept_details
   - search_by_document
6. Claude Desktop integration working</p>
<p><strong>Testing:</strong>
- Process Watts documents
- Query via Claude Desktop
- Verify concept deduplication</p>
<h3 id="phase-2-graph-visualization-weeks-3-4">Phase 2: Graph &amp; Visualization (Weeks 3-4)</h3>
<p><strong>Goals:</strong>
- Enhance relationship handling
- Build 3D visualization
- Add advanced querying</p>
<p><strong>Deliverables:</strong>
1. Relationship extraction and storage
2. Graph traversal queries
3. MCP tools for graph navigation:
   - find_related_concepts
   - find_connections
4. 3D visualization web app
5. Session-based visualization URLs
6. Interactive graph controls</p>
<p><strong>Testing:</strong>
- Visualize Watts concept graph
- Test path finding between concepts
- Verify relationship types display correctly</p>
<h3 id="phase-3-production-features-weeks-5-6">Phase 3: Production Features (Weeks 5-6)</h3>
<p><strong>Goals:</strong>
- Multi-document support
- Advanced parsing
- Analytics and insights</p>
<p><strong>Deliverables:</strong>
1. PDF and DOCX parsing
2. Batch document processing
3. Multi-client/project isolation
4. Graph analytics:
   - Concept centrality
   - Cluster detection
   - Cross-document patterns
5. Export capabilities (JSON, CSV)
6. Search improvements (hybrid vector + keyword)</p>
<p><strong>Testing:</strong>
- Process 10+ diverse documents
- Test multi-client isolation
- Verify analytics accuracy</p>
<h3 id="phase-4-enhancement-weeks-7-8">Phase 4: Enhancement (Weeks 7-8)</h3>
<p><strong>Goals:</strong>
- Performance optimization
- Advanced features
- Production hardening</p>
<p><strong>Deliverables:</strong>
1. Apache AGE optimization (completed - see ADR-016)
2. Caching layer (Redis)
3. Advanced visualization:
   - Time-based filtering
   - Document comparison view
   - Concept evolution tracking
4. API authentication
5. Monitoring and logging
6. Documentation</p>
<p><strong>Testing:</strong>
- Load testing (1000+ documents)
- Security audit
- User acceptance testing</p>
<h3 id="deployment-checklist">Deployment Checklist</h3>
<p><strong>Infrastructure:</strong>
- [ ] Set up production database (PostgreSQL + Apache AGE)
- [ ] Configure vector index optimization (pgvector or in-app)
- [ ] Set up backup strategy
- [ ] Configure monitoring (logs, metrics)</p>
<p><strong>Security:</strong>
- [ ] Environment variable management
- [ ] API authentication (if exposing publicly)
- [ ] Database connection security
- [ ] Rate limiting</p>
<p><strong>Documentation:</strong>
- [ ] API documentation
- [ ] MCP tool usage guide
- [ ] Visualization user guide
- [ ] Administrator guide</p>
<hr />
<h2 id="appendix-a-example-queries">Appendix A: Example Queries</h2>
<h3 id="a1-sql-queries">A.1 SQL Queries</h3>
<p><strong>Find concepts with most cross-document appearances:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">SELECT</span><span class="w"> </span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="p">,</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">label</span><span class="p">,</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">source_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="n">array_agg</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">document</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">documents</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="k">FROM</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="k">c</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">concept_sources</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">concept_id</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">source_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">source_id</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">label</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">document</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">source_count</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>Find isolated concepts (no relationships):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">label</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="k">c</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">concept_relationships</span><span class="w"> </span><span class="n">cr1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cr1</span><span class="p">.</span><span class="n">from_concept_id</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">concept_relationships</span><span class="w"> </span><span class="n">cr2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cr2</span><span class="p">.</span><span class="n">to_concept_id</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">cr1</span><span class="p">.</span><span class="n">from_concept_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">AND</span><span class="w"> </span><span class="n">cr2</span><span class="p">.</span><span class="n">to_concept_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>Concept co-occurrence (appear in same documents):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">SELECT</span><span class="w"> </span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">    </span><span class="n">c1</span><span class="p">.</span><span class="n">label</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">concept_1</span><span class="p">,</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">    </span><span class="n">c2</span><span class="p">.</span><span class="n">label</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">concept_2</span><span class="p">,</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">co_occurrence_count</span><span class="p">,</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="n">array_agg</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">document</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">shared_documents</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="k">FROM</span><span class="w"> </span><span class="n">concept_sources</span><span class="w"> </span><span class="n">cs1</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">concept_sources</span><span class="w"> </span><span class="n">cs2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cs1</span><span class="p">.</span><span class="n">source_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs2</span><span class="p">.</span><span class="n">source_id</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cs1</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c1</span><span class="p">.</span><span class="n">concept_id</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cs2</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">concept_id</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cs1</span><span class="p">.</span><span class="n">source_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">source_id</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">cs1</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cs2</span><span class="p">.</span><span class="n">concept_id</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c1</span><span class="p">.</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">label</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">co_occurrence_count</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div></p>
<h3 id="a2-opencypher-queries-apache-age">A.2 openCypher Queries (Apache AGE)</h3>
<p><strong>Find most central concepts (highest degree):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Concept</span><span class="p">)</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="k">OPTIONAL</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">-[</span><span class="n">r</span><span class="o">]-</span><span class="p">()</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">WITH</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">degree</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="k">RETURN</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">degree</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">degree</span><span class="w"> </span><span class="k">DESC</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="k">LIMIT</span><span class="w"> </span><span class="m">10</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>Find concept clusters (community detection):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">CALL</span><span class="w"> </span><span class="n">gds</span><span class="p">.</span><span class="n">louvain</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">&#39;concept-graph&#39;</span><span class="p">)</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="k">YIELD</span><span class="w"> </span><span class="n">nodeId</span><span class="p">,</span><span class="w"> </span><span class="n">communityId</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="k">RETURN</span><span class="w"> </span><span class="n">gds</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">asNode</span><span class="p">(</span><span class="n">nodeId</span><span class="p">).</span><span class="n">label</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">concept</span><span class="p">,</span><span class="w"> </span><span class="n">communityId</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">communityId</span><span class="p">,</span><span class="w"> </span><span class="n">concept</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>Find contradicting concept pairs:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="p">:</span><span class="n">Concept</span><span class="p">)</span><span class="o">-[</span><span class="n">r</span><span class="p">:</span><span class="n">CONTRADICTS</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c2</span><span class="p">:</span><span class="n">Concept</span><span class="p">)</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="k">RETURN</span><span class="w"> </span><span class="n">c1</span><span class="p">.</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">confidence</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">confidence</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div></p>
<hr />
<h2 id="appendix-b-configuration-examples">Appendix B: Configuration Examples</h2>
<h3 id="b1-environment-variables">B.1 Environment Variables</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1"># .env</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://kg_user:password@localhost:5432/knowledge_graph
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="nv">OPENAI_API_KEY</span><span class="o">=</span>sk-...
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="nv">ANTHROPIC_API_KEY</span><span class="o">=</span>sk-ant-...
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="nv">VISUALIZATION_URL</span><span class="o">=</span>http://localhost:3000
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
</code></pre></div>
<h3 id="b2-database-initialization">B.2 Database Initialization</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1">-- init.sql</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">vector</span><span class="p">;</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">pg_trgm</span><span class="p">;</span><span class="w">  </span><span class="c1">-- For text similarity</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="c1">-- Run the main schema from section 6.1</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="c1">-- Create indexes</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_sources_document</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sources</span><span class="p">(</span><span class="n">document</span><span class="p">);</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_instances_concept</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">instances</span><span class="p">(</span><span class="n">concept_id</span><span class="p">);</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_concept_labels_trgm</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">gin</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="n">gin_trgm_ops</span><span class="p">);</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="c1">-- Create view for common queries</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">concept_summary</span><span class="w"> </span><span class="k">AS</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="k">SELECT</span><span class="w"> </span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="p">,</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">label</span><span class="p">,</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">source_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">instance_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">instance_count</span><span class="p">,</span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">    </span><span class="n">array_agg</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">document</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">documents</span>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="k">FROM</span><span class="w"> </span><span class="n">concepts</span><span class="w"> </span><span class="k">c</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">concept_sources</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">concept_id</span>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">source_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">source_id</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">concept_id</span>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">label</span><span class="p">;</span>
</code></pre></div>
<hr />
<h2 id="appendix-c-troubleshooting">Appendix C: Troubleshooting</h2>
<h3 id="c1-common-issues">C.1 Common Issues</h3>
<p><strong>Vector search returns no results:</strong>
- Check that embeddings are being generated correctly
- Verify pgvector extension is installed: <code>SELECT * FROM pg_extension WHERE extname = 'vector';</code>
- Lower the similarity threshold
- Check vector dimensions match (1536 for text-embedding-3-small)</p>
<p><strong>Concept deduplication creating too many duplicates:</strong>
- Lower the similarity threshold (try 0.80 instead of 0.85)
- Improve search_terms quality in LLM prompt
- Add manual review step for borderline matches</p>
<p><strong>MCP server not appearing in Claude Desktop:</strong>
- Check config file location is correct
- Verify JSON syntax is valid
- Check file permissions on the server build
- Review Claude Desktop logs: <code>~/Library/Logs/Claude/mcp*.log</code></p>
<p><strong>Graph visualization is slow:</strong>
- Limit number of nodes (50-100 max for smooth performance)
- Use WebGL rendering optimizations
- Implement level-of-detail (LOD) for distant nodes
- Add pagination for large graphs</p>
<hr />
<h2 id="13-graphrag-integration-borrowing-best-practices">13. GraphRAG Integration: Borrowing Best Practices</h2>
<p>While Microsoft's GraphRAG uses a different storage approach (parquet files vs. graph databases), several of their techniques can significantly enhance our architecture. This section details what to borrow and how to integrate it.</p>
<h3 id="131-graphrag-overview">13.1 GraphRAG Overview</h3>
<p><strong>What GraphRAG Does Well:</strong>
- Advanced entity extraction with LLM prompting
- Community detection (Leiden algorithm) for concept clustering
- Hierarchical summarization across graph communities
- Global vs. Local query strategies
- Multi-level reasoning over large graphs</p>
<p><strong>What GraphRAG Doesn't Provide (that we need):</strong>
- Real-time graph database (uses parquet files)
- Interactive graph traversal
- 3D visualization support
- Multi-client isolation
- Direct conversational interface (MCP)</p>
<p><strong>Our Approach:</strong> Use GraphRAG's algorithms and prompt patterns while keeping our graph database architecture.</p>
<hr />
<h3 id="132-community-detection-leiden-algorithm">13.2 Community Detection (Leiden Algorithm)</h3>
<p><strong>What it is:</strong> Hierarchical clustering of concepts based on relationship density. Concepts that are highly interconnected form "communities" which can be summarized.</p>
<p><strong>Why it matters:</strong> In consulting documents, communities represent coherent themes (e.g., "Digital Transformation Challenges", "Change Management Strategies"). This enables better summarization and querying.</p>
<h4 id="implementation">Implementation</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1"># community_detection.py</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">graspologic.partition</span><span class="w"> </span><span class="kn">import</span> <span class="n">hierarchical_leiden</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncpg</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">detect_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="sd">    Detect hierarchical communities in the concept graph using Leiden algorithm</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="sd">    Args:</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="sd">        db_connection: PostgreSQL connection</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="sd">        resolution: Higher values create more, smaller communities</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="sd">    Returns:</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="sd">        Dictionary mapping concept_id to community assignments at each level</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>    <span class="c1"># Build NetworkX graph from database</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>    <span class="c1"># Add nodes</span>
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>    <span class="n">nodes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="s2">        SELECT concept_id, label</span>
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="s2">        FROM concepts</span>
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>
<a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
<a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
<a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a>
<a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a>    <span class="c1"># Add edges (relationships)</span>
<a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a>    <span class="n">edges</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a><span class="s2">        SELECT from_concept_id, to_concept_id, confidence</span>
<a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="s2">        FROM concept_relationships</span>
<a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a>
<a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a>    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
<a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
<a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a>            <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;from_concept_id&#39;</span><span class="p">],</span> 
<a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a>            <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;to_concept_id&#39;</span><span class="p">],</span>
<a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a>            <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span>
<a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a>        <span class="p">)</span>
<a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a>
<a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a>    <span class="c1"># Run hierarchical Leiden</span>
<a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a>    <span class="n">communities</span> <span class="o">=</span> <span class="n">hierarchical_leiden</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
<a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a>
<a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a>    <span class="c1"># Store community assignments in database</span>
<a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a>    <span class="k">await</span> <span class="n">store_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">communities</span><span class="p">)</span>
<a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a>
<a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a>    <span class="k">return</span> <span class="n">communities</span>
<a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a>
<a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">communities</span><span class="p">):</span>
<a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Store community assignments in database&quot;&quot;&quot;</span>
<a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a>
<a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a>    <span class="c1"># Create community tables if not exist</span>
<a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a>    <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a><span class="s2">        CREATE TABLE IF NOT EXISTS concept_communities (</span>
<a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a><span class="s2">            concept_id VARCHAR(255) REFERENCES concepts(concept_id),</span>
<a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a><span class="s2">            level INTEGER,</span>
<a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a><span class="s2">            community_id INTEGER,</span>
<a id="__codelineno-43-60" name="__codelineno-43-60" href="#__codelineno-43-60"></a><span class="s2">            created_at TIMESTAMP DEFAULT NOW(),</span>
<a id="__codelineno-43-61" name="__codelineno-43-61" href="#__codelineno-43-61"></a><span class="s2">            PRIMARY KEY (concept_id, level)</span>
<a id="__codelineno-43-62" name="__codelineno-43-62" href="#__codelineno-43-62"></a><span class="s2">        )</span>
<a id="__codelineno-43-63" name="__codelineno-43-63" href="#__codelineno-43-63"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-43-64" name="__codelineno-43-64" href="#__codelineno-43-64"></a>
<a id="__codelineno-43-65" name="__codelineno-43-65" href="#__codelineno-43-65"></a>    <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-43-66" name="__codelineno-43-66" href="#__codelineno-43-66"></a><span class="s2">        CREATE TABLE IF NOT EXISTS community_summaries (</span>
<a id="__codelineno-43-67" name="__codelineno-43-67" href="#__codelineno-43-67"></a><span class="s2">            level INTEGER,</span>
<a id="__codelineno-43-68" name="__codelineno-43-68" href="#__codelineno-43-68"></a><span class="s2">            community_id INTEGER,</span>
<a id="__codelineno-43-69" name="__codelineno-43-69" href="#__codelineno-43-69"></a><span class="s2">            title VARCHAR(500),</span>
<a id="__codelineno-43-70" name="__codelineno-43-70" href="#__codelineno-43-70"></a><span class="s2">            summary TEXT,</span>
<a id="__codelineno-43-71" name="__codelineno-43-71" href="#__codelineno-43-71"></a><span class="s2">            concept_count INTEGER,</span>
<a id="__codelineno-43-72" name="__codelineno-43-72" href="#__codelineno-43-72"></a><span class="s2">            created_at TIMESTAMP DEFAULT NOW(),</span>
<a id="__codelineno-43-73" name="__codelineno-43-73" href="#__codelineno-43-73"></a><span class="s2">            PRIMARY KEY (level, community_id)</span>
<a id="__codelineno-43-74" name="__codelineno-43-74" href="#__codelineno-43-74"></a><span class="s2">        )</span>
<a id="__codelineno-43-75" name="__codelineno-43-75" href="#__codelineno-43-75"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-43-76" name="__codelineno-43-76" href="#__codelineno-43-76"></a>
<a id="__codelineno-43-77" name="__codelineno-43-77" href="#__codelineno-43-77"></a>    <span class="c1"># Insert community assignments</span>
<a id="__codelineno-43-78" name="__codelineno-43-78" href="#__codelineno-43-78"></a>    <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">level_communities</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">communities</span><span class="p">):</span>
<a id="__codelineno-43-79" name="__codelineno-43-79" href="#__codelineno-43-79"></a>        <span class="k">for</span> <span class="n">concept_id</span><span class="p">,</span> <span class="n">community_id</span> <span class="ow">in</span> <span class="n">level_communities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-43-80" name="__codelineno-43-80" href="#__codelineno-43-80"></a>            <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-43-81" name="__codelineno-43-81" href="#__codelineno-43-81"></a><span class="s2">                INSERT INTO concept_communities (concept_id, level, community_id)</span>
<a id="__codelineno-43-82" name="__codelineno-43-82" href="#__codelineno-43-82"></a><span class="s2">                VALUES ($1, $2, $3)</span>
<a id="__codelineno-43-83" name="__codelineno-43-83" href="#__codelineno-43-83"></a><span class="s2">                ON CONFLICT (concept_id, level) </span>
<a id="__codelineno-43-84" name="__codelineno-43-84" href="#__codelineno-43-84"></a><span class="s2">                DO UPDATE SET community_id = $3</span>
<a id="__codelineno-43-85" name="__codelineno-43-85" href="#__codelineno-43-85"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">community_id</span><span class="p">)</span>
</code></pre></div>
<h4 id="database-schema-extension">Database Schema Extension</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1">-- Add to existing schema</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="c1">-- Community assignments</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">concept_communities</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="n">concept_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">concepts</span><span class="p">(</span><span class="n">concept_id</span><span class="p">),</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="k">level</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 0 = finest granularity, higher = more general</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">    </span><span class="n">community_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">concept_id</span><span class="p">,</span><span class="w"> </span><span class="k">level</span><span class="p">)</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="p">);</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="c1">-- Community summaries (generated by LLM)</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">community_summaries</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="k">level</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">    </span><span class="n">community_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="n">concept_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">    </span><span class="n">key_concepts</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[],</span><span class="w">  </span><span class="c1">-- Top concepts in community</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="k">level</span><span class="p">,</span><span class="w"> </span><span class="n">community_id</span><span class="p">)</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="p">);</span>
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_community_level</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">concept_communities</span><span class="p">(</span><span class="k">level</span><span class="p">,</span><span class="w"> </span><span class="n">community_id</span><span class="p">);</span>
</code></pre></div>
<hr />
<h3 id="133-hierarchical-summarization">13.3 Hierarchical Summarization</h3>
<p><strong>What it is:</strong> Generate LLM-based summaries for each community at each hierarchy level.</p>
<p><strong>Why it matters:</strong> Enables "global" queries that ask about overall themes without retrieving every concept.</p>
<h4 id="implementation_1">Implementation</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># hierarchical_summarization.py</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">anthropic</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_community_summaries</span><span class="p">(</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>    <span class="n">db_connection</span><span class="p">,</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>    <span class="n">llm_client</span><span class="p">:</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">AsyncAnthropic</span><span class="p">,</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="p">):</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="sd">    Generate summaries for all communities at a given level</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>    <span class="c1"># Get all communities at this level</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>    <span class="n">communities</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="s2">        SELECT DISTINCT community_id</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="s2">        FROM concept_communities</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="s2">        WHERE level = $1</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="s2">        ORDER BY community_id</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a>    <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">communities</span><span class="p">:</span>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>        <span class="n">community_id</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;community_id&#39;</span><span class="p">]</span>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a>
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a>        <span class="c1"># Get all concepts in this community</span>
<a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a>        <span class="n">concepts_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="s2">            SELECT c.concept_id, c.label, array_agg(i.quote) as quotes</span>
<a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="s2">            FROM concept_communities cc</span>
<a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="s2">            JOIN concepts c ON cc.concept_id = c.concept_id</span>
<a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="s2">            LEFT JOIN instances i ON c.concept_id = i.concept_id</span>
<a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a><span class="s2">            WHERE cc.level = $1 AND cc.community_id = $2</span>
<a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="s2">            GROUP BY c.concept_id, c.label</span>
<a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">community_id</span><span class="p">)</span>
<a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a>
<a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a>        <span class="c1"># Prepare data for LLM</span>
<a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a>        <span class="n">concepts_text</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-45-37" name="__codelineno-45-37" href="#__codelineno-45-37"></a>        <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">concepts_data</span><span class="p">:</span>
<a id="__codelineno-45-38" name="__codelineno-45-38" href="#__codelineno-45-38"></a>            <span class="n">quotes</span> <span class="o">=</span> <span class="n">concept</span><span class="p">[</span><span class="s1">&#39;quotes&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">concept</span><span class="p">[</span><span class="s1">&#39;quotes&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>  <span class="c1"># Max 3 quotes</span>
<a id="__codelineno-45-39" name="__codelineno-45-39" href="#__codelineno-45-39"></a>            <span class="n">concepts_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">concept</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-45-40" name="__codelineno-45-40" href="#__codelineno-45-40"></a>
<a id="__codelineno-45-41" name="__codelineno-45-41" href="#__codelineno-45-41"></a>        <span class="c1"># Generate summary</span>
<a id="__codelineno-45-42" name="__codelineno-45-42" href="#__codelineno-45-42"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are analyzing a cluster of related concepts from documents.</span>
<a id="__codelineno-45-43" name="__codelineno-45-43" href="#__codelineno-45-43"></a>
<a id="__codelineno-45-44" name="__codelineno-45-44" href="#__codelineno-45-44"></a><span class="s2">CONCEPTS IN THIS CLUSTER:</span>
<a id="__codelineno-45-45" name="__codelineno-45-45" href="#__codelineno-45-45"></a><span class="si">{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concepts_text</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-45-46" name="__codelineno-45-46" href="#__codelineno-45-46"></a>
<a id="__codelineno-45-47" name="__codelineno-45-47" href="#__codelineno-45-47"></a><span class="s2">TASK:</span>
<a id="__codelineno-45-48" name="__codelineno-45-48" href="#__codelineno-45-48"></a><span class="s2">1. Create a concise title (5-10 words) that captures the main theme</span>
<a id="__codelineno-45-49" name="__codelineno-45-49" href="#__codelineno-45-49"></a><span class="s2">2. Write a 2-3 sentence summary explaining what these concepts have in common</span>
<a id="__codelineno-45-50" name="__codelineno-45-50" href="#__codelineno-45-50"></a><span class="s2">3. Identify 3-5 key concepts that best represent this cluster</span>
<a id="__codelineno-45-51" name="__codelineno-45-51" href="#__codelineno-45-51"></a>
<a id="__codelineno-45-52" name="__codelineno-45-52" href="#__codelineno-45-52"></a><span class="s2">Respond in JSON format:</span>
<a id="__codelineno-45-53" name="__codelineno-45-53" href="#__codelineno-45-53"></a><span class="se">{{</span>
<a id="__codelineno-45-54" name="__codelineno-45-54" href="#__codelineno-45-54"></a><span class="s2">  &quot;title&quot;: &quot;Main theme title&quot;,</span>
<a id="__codelineno-45-55" name="__codelineno-45-55" href="#__codelineno-45-55"></a><span class="s2">  &quot;summary&quot;: &quot;2-3 sentence summary&quot;,</span>
<a id="__codelineno-45-56" name="__codelineno-45-56" href="#__codelineno-45-56"></a><span class="s2">  &quot;key_concepts&quot;: [&quot;concept-id-1&quot;, &quot;concept-id-2&quot;, ...]</span>
<a id="__codelineno-45-57" name="__codelineno-45-57" href="#__codelineno-45-57"></a><span class="se">}}</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-45-58" name="__codelineno-45-58" href="#__codelineno-45-58"></a>
<a id="__codelineno-45-59" name="__codelineno-45-59" href="#__codelineno-45-59"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-45-60" name="__codelineno-45-60" href="#__codelineno-45-60"></a>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span>
<a id="__codelineno-45-61" name="__codelineno-45-61" href="#__codelineno-45-61"></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-45-62" name="__codelineno-45-62" href="#__codelineno-45-62"></a>            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
<a id="__codelineno-45-63" name="__codelineno-45-63" href="#__codelineno-45-63"></a>        <span class="p">)</span>
<a id="__codelineno-45-64" name="__codelineno-45-64" href="#__codelineno-45-64"></a>
<a id="__codelineno-45-65" name="__codelineno-45-65" href="#__codelineno-45-65"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-45-66" name="__codelineno-45-66" href="#__codelineno-45-66"></a>
<a id="__codelineno-45-67" name="__codelineno-45-67" href="#__codelineno-45-67"></a>        <span class="c1"># Store summary</span>
<a id="__codelineno-45-68" name="__codelineno-45-68" href="#__codelineno-45-68"></a>        <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-45-69" name="__codelineno-45-69" href="#__codelineno-45-69"></a><span class="s2">            INSERT INTO community_summaries </span>
<a id="__codelineno-45-70" name="__codelineno-45-70" href="#__codelineno-45-70"></a><span class="s2">            (level, community_id, title, summary, concept_count, key_concepts)</span>
<a id="__codelineno-45-71" name="__codelineno-45-71" href="#__codelineno-45-71"></a><span class="s2">            VALUES ($1, $2, $3, $4, $5, $6)</span>
<a id="__codelineno-45-72" name="__codelineno-45-72" href="#__codelineno-45-72"></a><span class="s2">            ON CONFLICT (level, community_id)</span>
<a id="__codelineno-45-73" name="__codelineno-45-73" href="#__codelineno-45-73"></a><span class="s2">            DO UPDATE SET </span>
<a id="__codelineno-45-74" name="__codelineno-45-74" href="#__codelineno-45-74"></a><span class="s2">                title = $3, </span>
<a id="__codelineno-45-75" name="__codelineno-45-75" href="#__codelineno-45-75"></a><span class="s2">                summary = $4, </span>
<a id="__codelineno-45-76" name="__codelineno-45-76" href="#__codelineno-45-76"></a><span class="s2">                concept_count = $5,</span>
<a id="__codelineno-45-77" name="__codelineno-45-77" href="#__codelineno-45-77"></a><span class="s2">                key_concepts = $6,</span>
<a id="__codelineno-45-78" name="__codelineno-45-78" href="#__codelineno-45-78"></a><span class="s2">                updated_at = NOW()</span>
<a id="__codelineno-45-79" name="__codelineno-45-79" href="#__codelineno-45-79"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">community_id</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span> 
<a id="__codelineno-45-80" name="__codelineno-45-80" href="#__codelineno-45-80"></a>             <span class="nb">len</span><span class="p">(</span><span class="n">concepts_data</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;key_concepts&#39;</span><span class="p">])</span>
<a id="__codelineno-45-81" name="__codelineno-45-81" href="#__codelineno-45-81"></a>
<a id="__codelineno-45-82" name="__codelineno-45-82" href="#__codelineno-45-82"></a><span class="c1"># Run for all hierarchy levels</span>
<a id="__codelineno-45-83" name="__codelineno-45-83" href="#__codelineno-45-83"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">summarize_all_levels</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">):</span>
<a id="__codelineno-45-84" name="__codelineno-45-84" href="#__codelineno-45-84"></a>    <span class="n">max_level</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span>
<a id="__codelineno-45-85" name="__codelineno-45-85" href="#__codelineno-45-85"></a>        <span class="s2">&quot;SELECT MAX(level) FROM concept_communities&quot;</span>
<a id="__codelineno-45-86" name="__codelineno-45-86" href="#__codelineno-45-86"></a>    <span class="p">)</span>
<a id="__codelineno-45-87" name="__codelineno-45-87" href="#__codelineno-45-87"></a>
<a id="__codelineno-45-88" name="__codelineno-45-88" href="#__codelineno-45-88"></a>    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-45-89" name="__codelineno-45-89" href="#__codelineno-45-89"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summarizing level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<a id="__codelineno-45-90" name="__codelineno-45-90" href="#__codelineno-45-90"></a>        <span class="k">await</span> <span class="n">generate_community_summaries</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="134-global-vs-local-query-strategies">13.4 Global vs. Local Query Strategies</h3>
<p><strong>GraphRAG distinguishes two query modes:</strong></p>
<ol>
<li><strong>Global Queries:</strong> High-level questions about themes, patterns, overarching concepts</li>
<li>"What are the main themes in our client documents?"</li>
<li>"What are the biggest challenges mentioned across all projects?"</li>
<li>
<p>Uses community summaries, not individual concepts</p>
</li>
<li>
<p><strong>Local Queries:</strong> Specific questions about particular entities or detailed relationships</p>
</li>
<li>"How does linear thinking relate to genetic intervention in Watts Doc 1?"</li>
<li>"What evidence supports the concept of 'inadequate tools'?"</li>
<li>Uses traditional graph traversal and vector search</li>
</ol>
<h4 id="implementation-in-mcp-server">Implementation in MCP Server</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1">// Add to MCP server tools</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="p">{</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;global_query&quot;</span><span class="p">,</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Answer high-level questions about themes and patterns across all documents using community summaries&quot;</span><span class="p">,</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">  </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">    </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">      </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;High-level question about themes, patterns, or overarching concepts&quot;</span><span class="w"> </span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">      </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Hierarchy level to query (0=detailed, higher=more general)&quot;</span><span class="p">,</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="w">        </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="p">}</span>
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a>
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a><span class="c1">// Implementation</span>
<a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">globalQuery</span><span class="p">(</span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a><span class="w">  </span><span class="c1">// Get all community summaries at this level</span>
<a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">communities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a><span class="sb">    SELECT </span>
<a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a><span class="sb">      cs.title,</span>
<a id="__codelineno-46-29" name="__codelineno-46-29" href="#__codelineno-46-29"></a><span class="sb">      cs.summary,</span>
<a id="__codelineno-46-30" name="__codelineno-46-30" href="#__codelineno-46-30"></a><span class="sb">      cs.key_concepts,</span>
<a id="__codelineno-46-31" name="__codelineno-46-31" href="#__codelineno-46-31"></a><span class="sb">      array_agg(c.label) as concept_labels</span>
<a id="__codelineno-46-32" name="__codelineno-46-32" href="#__codelineno-46-32"></a><span class="sb">    FROM community_summaries cs</span>
<a id="__codelineno-46-33" name="__codelineno-46-33" href="#__codelineno-46-33"></a><span class="sb">    JOIN concept_communities cc ON </span>
<a id="__codelineno-46-34" name="__codelineno-46-34" href="#__codelineno-46-34"></a><span class="sb">      cs.level = cc.level AND cs.community_id = cc.community_id</span>
<a id="__codelineno-46-35" name="__codelineno-46-35" href="#__codelineno-46-35"></a><span class="sb">    JOIN concepts c ON cc.concept_id = c.concept_id</span>
<a id="__codelineno-46-36" name="__codelineno-46-36" href="#__codelineno-46-36"></a><span class="sb">    WHERE cs.level = $1</span>
<a id="__codelineno-46-37" name="__codelineno-46-37" href="#__codelineno-46-37"></a><span class="sb">    GROUP BY cs.level, cs.community_id, cs.title, cs.summary, cs.key_concepts</span>
<a id="__codelineno-46-38" name="__codelineno-46-38" href="#__codelineno-46-38"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">level</span><span class="p">]);</span>
<a id="__codelineno-46-39" name="__codelineno-46-39" href="#__codelineno-46-39"></a>
<a id="__codelineno-46-40" name="__codelineno-46-40" href="#__codelineno-46-40"></a><span class="w">  </span><span class="c1">// Build context from community summaries</span>
<a id="__codelineno-46-41" name="__codelineno-46-41" href="#__codelineno-46-41"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">communities</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<a id="__codelineno-46-42" name="__codelineno-46-42" href="#__codelineno-46-42"></a><span class="w">    </span><span class="sb">`**</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="sb">**\n</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">summary</span><span class="si">}</span><span class="sb">\nKey concepts: </span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">concept_labels</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
<a id="__codelineno-46-43" name="__codelineno-46-43" href="#__codelineno-46-43"></a><span class="w">  </span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">);</span>
<a id="__codelineno-46-44" name="__codelineno-46-44" href="#__codelineno-46-44"></a>
<a id="__codelineno-46-45" name="__codelineno-46-45" href="#__codelineno-46-45"></a><span class="w">  </span><span class="c1">// Use LLM to synthesize answer from community summaries</span>
<a id="__codelineno-46-46" name="__codelineno-46-46" href="#__codelineno-46-46"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">anthropic</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<a id="__codelineno-46-47" name="__codelineno-46-47" href="#__codelineno-46-47"></a><span class="w">    </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span>
<a id="__codelineno-46-48" name="__codelineno-46-48" href="#__codelineno-46-48"></a><span class="w">    </span><span class="nx">max_tokens</span><span class="o">:</span><span class="w"> </span><span class="kt">2000</span><span class="p">,</span>
<a id="__codelineno-46-49" name="__codelineno-46-49" href="#__codelineno-46-49"></a><span class="w">    </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-46-50" name="__codelineno-46-50" href="#__codelineno-46-50"></a><span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<a id="__codelineno-46-51" name="__codelineno-46-51" href="#__codelineno-46-51"></a><span class="w">      </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="sb">`Based on these thematic clusters from documents, answer the question.</span>
<a id="__codelineno-46-52" name="__codelineno-46-52" href="#__codelineno-46-52"></a>
<a id="__codelineno-46-53" name="__codelineno-46-53" href="#__codelineno-46-53"></a><span class="sb">THEMATIC CLUSTERS:</span>
<a id="__codelineno-46-54" name="__codelineno-46-54" href="#__codelineno-46-54"></a><span class="si">${</span><span class="nx">context</span><span class="si">}</span>
<a id="__codelineno-46-55" name="__codelineno-46-55" href="#__codelineno-46-55"></a>
<a id="__codelineno-46-56" name="__codelineno-46-56" href="#__codelineno-46-56"></a><span class="sb">QUESTION: </span><span class="si">${</span><span class="nx">query</span><span class="si">}</span>
<a id="__codelineno-46-57" name="__codelineno-46-57" href="#__codelineno-46-57"></a>
<a id="__codelineno-46-58" name="__codelineno-46-58" href="#__codelineno-46-58"></a><span class="sb">Provide a comprehensive answer that synthesizes insights across clusters.`</span>
<a id="__codelineno-46-59" name="__codelineno-46-59" href="#__codelineno-46-59"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-46-60" name="__codelineno-46-60" href="#__codelineno-46-60"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-46-61" name="__codelineno-46-61" href="#__codelineno-46-61"></a>
<a id="__codelineno-46-62" name="__codelineno-46-62" href="#__codelineno-46-62"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-63" name="__codelineno-46-63" href="#__codelineno-46-63"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-46-64" name="__codelineno-46-64" href="#__codelineno-46-64"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-46-65" name="__codelineno-46-65" href="#__codelineno-46-65"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-46-66" name="__codelineno-46-66" href="#__codelineno-46-66"></a><span class="w">        </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span>
<a id="__codelineno-46-67" name="__codelineno-46-67" href="#__codelineno-46-67"></a><span class="w">        </span><span class="nx">answer</span><span class="o">:</span><span class="w"> </span><span class="kt">response.content</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">text</span><span class="p">,</span>
<a id="__codelineno-46-68" name="__codelineno-46-68" href="#__codelineno-46-68"></a><span class="w">        </span><span class="nx">communities_used</span><span class="o">:</span><span class="w"> </span><span class="kt">communities.rows.length</span><span class="p">,</span>
<a id="__codelineno-46-69" name="__codelineno-46-69" href="#__codelineno-46-69"></a><span class="w">        </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">level</span>
<a id="__codelineno-46-70" name="__codelineno-46-70" href="#__codelineno-46-70"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-46-71" name="__codelineno-46-71" href="#__codelineno-46-71"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-46-72" name="__codelineno-46-72" href="#__codelineno-46-72"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-46-73" name="__codelineno-46-73" href="#__codelineno-46-73"></a><span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="135-enhanced-entity-extraction-prompts">13.5 Enhanced Entity Extraction Prompts</h3>
<p><strong>GraphRAG's entity extraction prompts are well-tuned.</strong> Adapt their pattern for better concept extraction:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1"># Enhanced extraction prompt (inspired by GraphRAG)</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">EXTRACTION_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a knowledge graph extraction expert. Extract concepts, relationships, and claims from the text.</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="s2"># EXTRACTION GUIDELINES</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="s2">## Concepts (Entities)</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="s2">- Extract key IDEAS, ARGUMENTS, CLAIMS, and PHENOMENA</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="s2">- Each concept should be:</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="s2">  * Atomic (one clear idea)</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="s2">  * Generalizable (not overly specific to this text)</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="s2">  * Meaningful (substantive, not trivial)</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="s2">- Examples: &quot;Linear thinking&quot;, &quot;Human intelligence limitation&quot;, &quot;Statistical methods&quot;</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="s2">## Relationships</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="s2">- Extract LOGICAL connections between concepts</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="s2">- Types:</span>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="s2">  * IMPLIES: Concept A logically leads to B</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="s2">  * CONTRADICTS: A is in tension with B</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="s2">  * SUPPORTS: A provides evidence for B</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a><span class="s2">  * PART_OF: A is a component of B</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="s2">  * REQUIRES: A needs B to function</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a><span class="s2">- Each relationship needs:</span>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a><span class="s2">  * Clear directionality (from  to)</span>
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a><span class="s2">  * Confidence score (0.0-1.0)</span>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="s2">## Evidence (Instances)</span>
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a><span class="s2">- Quote EXACT text that supports each concept</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a><span class="s2">- Keep quotes focused (1-2 sentences max)</span>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a><span class="s2">- Multiple quotes OK for same concept</span>
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a>
<a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="s2"># INPUT TEXT</span>
<a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a><span class="s2">Source: </span><span class="si">{source_id}</span>
<a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a>
<a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a><span class="si">{text}</span>
<a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a>
<a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a><span class="s2"># EXISTING CONCEPTS (for matching)</span>
<a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a><span class="si">{existing_concepts_json}</span>
<a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a>
<a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a><span class="s2"># CRITICAL MATCHING RULES</span>
<a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a><span class="s2">- If a concept MEANS THE SAME as an existing one  USE the existing concept_id</span>
<a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a><span class="s2">- If it&#39;s SIMILAR but DIFFERENT  CREATE a new concept_id</span>
<a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a><span class="s2">- When unsure  CREATE new (we can merge later)</span>
<a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a>
<a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a><span class="s2"># OUTPUT FORMAT (JSON only)</span>
<a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a><span class="s2">{{</span>
<a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a><span class="s2">  &quot;extracted_concepts&quot;: [</span>
<a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a><span class="s2">    {{</span>
<a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a><span class="s2">      &quot;concept_id&quot;: &quot;kebab-case-id&quot;,</span>
<a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a><span class="s2">      &quot;label&quot;: &quot;Human Readable Label&quot;,</span>
<a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a><span class="s2">      &quot;confidence&quot;: 0.95,</span>
<a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a><span class="s2">      &quot;search_terms&quot;: [&quot;synonym1&quot;, &quot;synonym2&quot;, &quot;related-term&quot;],</span>
<a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a><span class="s2">      &quot;description&quot;: &quot;One sentence explaining this concept&quot;</span>
<a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a><span class="s2">    }}</span>
<a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a><span class="s2">  ],</span>
<a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a><span class="s2">  &quot;instances&quot;: [</span>
<a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a><span class="s2">    {{</span>
<a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a><span class="s2">      &quot;concept_id&quot;: &quot;matching-id-above&quot;,</span>
<a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a><span class="s2">      &quot;quote&quot;: &quot;exact text from input&quot;</span>
<a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a><span class="s2">    }}</span>
<a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a><span class="s2">  ],</span>
<a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a><span class="s2">  &quot;relationships&quot;: [</span>
<a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a><span class="s2">    {{</span>
<a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a><span class="s2">      &quot;from_concept_id&quot;: &quot;concept-a&quot;,</span>
<a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a><span class="s2">      &quot;to_concept_id&quot;: &quot;concept-b&quot;,</span>
<a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a><span class="s2">      &quot;relationship_type&quot;: &quot;implies&quot;,</span>
<a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a><span class="s2">      &quot;confidence&quot;: 0.85,</span>
<a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a><span class="s2">      &quot;explanation&quot;: &quot;Why this relationship exists&quot;</span>
<a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a><span class="s2">    }}</span>
<a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a><span class="s2">  ]</span>
<a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a><span class="s2">}}</span>
<a id="__codelineno-47-71" name="__codelineno-47-71" href="#__codelineno-47-71"></a>
<a id="__codelineno-47-72" name="__codelineno-47-72" href="#__codelineno-47-72"></a><span class="s2">RESPOND WITH ONLY VALID JSON.&quot;&quot;&quot;</span>
</code></pre></div>
<hr />
<h3 id="136-integration-workflow">13.6 Integration Workflow</h3>
<p><strong>Complete workflow incorporating GraphRAG techniques:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># integrated_pipeline.py</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_document_with_graphrag_techniques</span><span class="p">(</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>    <span class="n">doc_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>    <span class="n">doc_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>    <span class="n">db_connection</span><span class="p">,</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>    <span class="n">llm_client</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="p">):</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="sd">    Enhanced document processing with GraphRAG-inspired techniques</span>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>    <span class="c1"># Step 1: Standard extraction (our original pipeline)</span>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 1: Extracting concepts...&quot;</span><span class="p">)</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">parse_document</span><span class="p">(</span><span class="n">doc_path</span><span class="p">)</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">para</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>        <span class="n">source_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc_metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-para-</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>        <span class="n">extraction</span> <span class="o">=</span> <span class="k">await</span> <span class="n">extract_concepts</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>        <span class="k">await</span> <span class="n">upsert_to_graph</span><span class="p">(</span><span class="n">extraction</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">)</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>    <span class="c1"># Step 2: Community detection (GraphRAG technique)</span>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 2: Detecting communities...&quot;</span><span class="p">)</span>
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>    <span class="n">communities</span> <span class="o">=</span> <span class="k">await</span> <span class="n">detect_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a>    <span class="c1"># Step 3: Hierarchical summarization (GraphRAG technique)</span>
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 3: Generating community summaries...&quot;</span><span class="p">)</span>
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>    <span class="k">await</span> <span class="n">summarize_all_levels</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span>
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a>
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>    <span class="c1"># Step 4: Update visualization metadata</span>
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 4: Updating visualization metadata...&quot;</span><span class="p">)</span>
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>    <span class="k">await</span> <span class="n">update_visualization_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">)</span>
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a>
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing complete with GraphRAG enhancements!&quot;</span><span class="p">)</span>
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a>
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_visualization_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">):</span>
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a><span class="sd">    Add community colors/groupings to visualization data</span>
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a>    <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a><span class="s2">        CREATE TABLE IF NOT EXISTS visualization_metadata (</span>
<a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a><span class="s2">            concept_id VARCHAR(255) PRIMARY KEY REFERENCES concepts(concept_id),</span>
<a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a><span class="s2">            community_color VARCHAR(7),  -- Hex color code</span>
<a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a><span class="s2">            community_label VARCHAR(255),</span>
<a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a><span class="s2">            size_multiplier DECIMAL(3,2) DEFAULT 1.0</span>
<a id="__codelineno-48-45" name="__codelineno-48-45" href="#__codelineno-48-45"></a><span class="s2">        )</span>
<a id="__codelineno-48-46" name="__codelineno-48-46" href="#__codelineno-48-46"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-48-47" name="__codelineno-48-47" href="#__codelineno-48-47"></a>
<a id="__codelineno-48-48" name="__codelineno-48-48" href="#__codelineno-48-48"></a>    <span class="c1"># Assign colors to communities</span>
<a id="__codelineno-48-49" name="__codelineno-48-49" href="#__codelineno-48-49"></a>    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#ff6b6b&#39;</span><span class="p">,</span> <span class="s1">&#39;#4dabf7&#39;</span><span class="p">,</span> <span class="s1">&#39;#51cf66&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffd43b&#39;</span><span class="p">,</span> <span class="s1">&#39;#845ef7&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8787&#39;</span><span class="p">,</span> <span class="s1">&#39;#69db7c&#39;</span><span class="p">]</span>
<a id="__codelineno-48-50" name="__codelineno-48-50" href="#__codelineno-48-50"></a>
<a id="__codelineno-48-51" name="__codelineno-48-51" href="#__codelineno-48-51"></a>    <span class="n">communities</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-48-52" name="__codelineno-48-52" href="#__codelineno-48-52"></a><span class="s2">        SELECT cc.concept_id, cc.community_id, cs.title</span>
<a id="__codelineno-48-53" name="__codelineno-48-53" href="#__codelineno-48-53"></a><span class="s2">        FROM concept_communities cc</span>
<a id="__codelineno-48-54" name="__codelineno-48-54" href="#__codelineno-48-54"></a><span class="s2">        JOIN community_summaries cs ON </span>
<a id="__codelineno-48-55" name="__codelineno-48-55" href="#__codelineno-48-55"></a><span class="s2">            cc.level = cs.level AND cc.community_id = cs.community_id</span>
<a id="__codelineno-48-56" name="__codelineno-48-56" href="#__codelineno-48-56"></a><span class="s2">        WHERE cc.level = 0  -- Use finest level for visualization</span>
<a id="__codelineno-48-57" name="__codelineno-48-57" href="#__codelineno-48-57"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-48-58" name="__codelineno-48-58" href="#__codelineno-48-58"></a>
<a id="__codelineno-48-59" name="__codelineno-48-59" href="#__codelineno-48-59"></a>    <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">communities</span><span class="p">:</span>
<a id="__codelineno-48-60" name="__codelineno-48-60" href="#__codelineno-48-60"></a>        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;community_id&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
<a id="__codelineno-48-61" name="__codelineno-48-61" href="#__codelineno-48-61"></a>        <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-48-62" name="__codelineno-48-62" href="#__codelineno-48-62"></a><span class="s2">            INSERT INTO visualization_metadata (concept_id, community_color, community_label)</span>
<a id="__codelineno-48-63" name="__codelineno-48-63" href="#__codelineno-48-63"></a><span class="s2">            VALUES ($1, $2, $3)</span>
<a id="__codelineno-48-64" name="__codelineno-48-64" href="#__codelineno-48-64"></a><span class="s2">            ON CONFLICT (concept_id) </span>
<a id="__codelineno-48-65" name="__codelineno-48-65" href="#__codelineno-48-65"></a><span class="s2">            DO UPDATE SET community_color = $2, community_label = $3</span>
<a id="__codelineno-48-66" name="__codelineno-48-66" href="#__codelineno-48-66"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;concept_id&#39;</span><span class="p">],</span> <span class="n">color</span><span class="p">,</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
</code></pre></div>
<hr />
<h3 id="137-mcp-tools-for-graphrag-features">13.7 MCP Tools for GraphRAG Features</h3>
<p><strong>Add these tools to the MCP server:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1">// Community-based tools</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">{</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;get_communities&quot;</span><span class="p">,</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Get thematic communities/clusters detected in the knowledge graph&quot;</span><span class="p">,</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">  </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">      </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Hierarchy level (0=detailed, higher=more general)&quot;</span><span class="p">,</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">        </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">      </span><span class="p">},</span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">      </span><span class="nx">min_concepts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Minimum number of concepts in community&quot;</span><span class="p">,</span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="w">        </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="p">},</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="p">{</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;explore_community&quot;</span><span class="p">,</span>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Explore all concepts within a specific thematic community&quot;</span><span class="p">,</span>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">  </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a><span class="w">    </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="w">      </span><span class="nx">community_id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a><span class="w">      </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a><span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;community_id&quot;</span><span class="p">]</span>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a><span class="p">},</span>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a><span class="p">{</span>
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;compare_communities&quot;</span><span class="p">,</span>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Compare concepts and themes across different communities&quot;</span><span class="p">,</span>
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a><span class="w">  </span><span class="nx">inputSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a><span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a><span class="w">    </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a><span class="w">      </span><span class="nx">community_ids</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a><span class="w">        </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;List of community IDs to compare&quot;</span>
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a><span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;community_ids&quot;</span><span class="p">]</span>
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a><span class="p">}</span>
<a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a>
<a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a><span class="c1">// Implementations</span>
<a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a>
<a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getCommunities</span><span class="p">(</span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">minConcepts</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a><span class="sb">    SELECT </span>
<a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a><span class="sb">      cs.community_id,</span>
<a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a><span class="sb">      cs.title,</span>
<a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a><span class="sb">      cs.summary,</span>
<a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a><span class="sb">      cs.concept_count,</span>
<a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a><span class="sb">      cs.key_concepts</span>
<a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a><span class="sb">    FROM community_summaries cs</span>
<a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a><span class="sb">    WHERE cs.level = $1 AND cs.concept_count &gt;= $2</span>
<a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a><span class="sb">    ORDER BY cs.concept_count DESC</span>
<a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">minConcepts</span><span class="p">]);</span>
<a id="__codelineno-49-66" name="__codelineno-49-66" href="#__codelineno-49-66"></a>
<a id="__codelineno-49-67" name="__codelineno-49-67" href="#__codelineno-49-67"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-68" name="__codelineno-49-68" href="#__codelineno-49-68"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-49-69" name="__codelineno-49-69" href="#__codelineno-49-69"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-49-70" name="__codelineno-49-70" href="#__codelineno-49-70"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-49-71" name="__codelineno-49-71" href="#__codelineno-49-71"></a><span class="w">        </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">level</span><span class="p">,</span>
<a id="__codelineno-49-72" name="__codelineno-49-72" href="#__codelineno-49-72"></a><span class="w">        </span><span class="nx">communities</span><span class="o">:</span><span class="w"> </span><span class="kt">result.rows</span><span class="p">,</span>
<a id="__codelineno-49-73" name="__codelineno-49-73" href="#__codelineno-49-73"></a><span class="w">        </span><span class="nx">total_communities</span><span class="o">:</span><span class="w"> </span><span class="kt">result.rows.length</span>
<a id="__codelineno-49-74" name="__codelineno-49-74" href="#__codelineno-49-74"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-49-75" name="__codelineno-49-75" href="#__codelineno-49-75"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-49-76" name="__codelineno-49-76" href="#__codelineno-49-76"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-49-77" name="__codelineno-49-77" href="#__codelineno-49-77"></a><span class="p">}</span>
<a id="__codelineno-49-78" name="__codelineno-49-78" href="#__codelineno-49-78"></a>
<a id="__codelineno-49-79" name="__codelineno-49-79" href="#__codelineno-49-79"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploreCommunity</span><span class="p">(</span><span class="nx">communityId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-80" name="__codelineno-49-80" href="#__codelineno-49-80"></a><span class="w">  </span><span class="c1">// Get community summary</span>
<a id="__codelineno-49-81" name="__codelineno-49-81" href="#__codelineno-49-81"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-49-82" name="__codelineno-49-82" href="#__codelineno-49-82"></a><span class="sb">    SELECT * FROM community_summaries</span>
<a id="__codelineno-49-83" name="__codelineno-49-83" href="#__codelineno-49-83"></a><span class="sb">    WHERE level = $1 AND community_id = $2</span>
<a id="__codelineno-49-84" name="__codelineno-49-84" href="#__codelineno-49-84"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">communityId</span><span class="p">]);</span>
<a id="__codelineno-49-85" name="__codelineno-49-85" href="#__codelineno-49-85"></a>
<a id="__codelineno-49-86" name="__codelineno-49-86" href="#__codelineno-49-86"></a><span class="w">  </span><span class="c1">// Get all concepts in community</span>
<a id="__codelineno-49-87" name="__codelineno-49-87" href="#__codelineno-49-87"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">concepts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-49-88" name="__codelineno-49-88" href="#__codelineno-49-88"></a><span class="sb">    SELECT </span>
<a id="__codelineno-49-89" name="__codelineno-49-89" href="#__codelineno-49-89"></a><span class="sb">      c.concept_id,</span>
<a id="__codelineno-49-90" name="__codelineno-49-90" href="#__codelineno-49-90"></a><span class="sb">      c.label,</span>
<a id="__codelineno-49-91" name="__codelineno-49-91" href="#__codelineno-49-91"></a><span class="sb">      array_agg(DISTINCT s.document) as documents,</span>
<a id="__codelineno-49-92" name="__codelineno-49-92" href="#__codelineno-49-92"></a><span class="sb">      count(DISTINCT i.instance_id) as evidence_count</span>
<a id="__codelineno-49-93" name="__codelineno-49-93" href="#__codelineno-49-93"></a><span class="sb">    FROM concept_communities cc</span>
<a id="__codelineno-49-94" name="__codelineno-49-94" href="#__codelineno-49-94"></a><span class="sb">    JOIN concepts c ON cc.concept_id = c.concept_id</span>
<a id="__codelineno-49-95" name="__codelineno-49-95" href="#__codelineno-49-95"></a><span class="sb">    LEFT JOIN concept_sources cs ON c.concept_id = cs.concept_id</span>
<a id="__codelineno-49-96" name="__codelineno-49-96" href="#__codelineno-49-96"></a><span class="sb">    LEFT JOIN sources s ON cs.source_id = s.source_id</span>
<a id="__codelineno-49-97" name="__codelineno-49-97" href="#__codelineno-49-97"></a><span class="sb">    LEFT JOIN instances i ON c.concept_id = i.concept_id</span>
<a id="__codelineno-49-98" name="__codelineno-49-98" href="#__codelineno-49-98"></a><span class="sb">    WHERE cc.level = $1 AND cc.community_id = $2</span>
<a id="__codelineno-49-99" name="__codelineno-49-99" href="#__codelineno-49-99"></a><span class="sb">    GROUP BY c.concept_id, c.label</span>
<a id="__codelineno-49-100" name="__codelineno-49-100" href="#__codelineno-49-100"></a><span class="sb">    ORDER BY evidence_count DESC</span>
<a id="__codelineno-49-101" name="__codelineno-49-101" href="#__codelineno-49-101"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">communityId</span><span class="p">]);</span>
<a id="__codelineno-49-102" name="__codelineno-49-102" href="#__codelineno-49-102"></a>
<a id="__codelineno-49-103" name="__codelineno-49-103" href="#__codelineno-49-103"></a><span class="w">  </span><span class="c1">// Get internal relationships</span>
<a id="__codelineno-49-104" name="__codelineno-49-104" href="#__codelineno-49-104"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">relationships</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<a id="__codelineno-49-105" name="__codelineno-49-105" href="#__codelineno-49-105"></a><span class="sb">    SELECT </span>
<a id="__codelineno-49-106" name="__codelineno-49-106" href="#__codelineno-49-106"></a><span class="sb">      cr.from_concept_id,</span>
<a id="__codelineno-49-107" name="__codelineno-49-107" href="#__codelineno-49-107"></a><span class="sb">      c1.label as from_label,</span>
<a id="__codelineno-49-108" name="__codelineno-49-108" href="#__codelineno-49-108"></a><span class="sb">      cr.to_concept_id,</span>
<a id="__codelineno-49-109" name="__codelineno-49-109" href="#__codelineno-49-109"></a><span class="sb">      c2.label as to_label,</span>
<a id="__codelineno-49-110" name="__codelineno-49-110" href="#__codelineno-49-110"></a><span class="sb">      cr.relationship_type</span>
<a id="__codelineno-49-111" name="__codelineno-49-111" href="#__codelineno-49-111"></a><span class="sb">    FROM concept_relationships cr</span>
<a id="__codelineno-49-112" name="__codelineno-49-112" href="#__codelineno-49-112"></a><span class="sb">    JOIN concept_communities cc1 ON cr.from_concept_id = cc1.concept_id</span>
<a id="__codelineno-49-113" name="__codelineno-49-113" href="#__codelineno-49-113"></a><span class="sb">    JOIN concept_communities cc2 ON cr.to_concept_id = cc2.concept_id</span>
<a id="__codelineno-49-114" name="__codelineno-49-114" href="#__codelineno-49-114"></a><span class="sb">    JOIN concepts c1 ON cr.from_concept_id = c1.concept_id</span>
<a id="__codelineno-49-115" name="__codelineno-49-115" href="#__codelineno-49-115"></a><span class="sb">    JOIN concepts c2 ON cr.to_concept_id = c2.concept_id</span>
<a id="__codelineno-49-116" name="__codelineno-49-116" href="#__codelineno-49-116"></a><span class="sb">    WHERE cc1.level = $1 AND cc1.community_id = $2</span>
<a id="__codelineno-49-117" name="__codelineno-49-117" href="#__codelineno-49-117"></a><span class="sb">      AND cc2.level = $1 AND cc2.community_id = $2</span>
<a id="__codelineno-49-118" name="__codelineno-49-118" href="#__codelineno-49-118"></a><span class="sb">  `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">communityId</span><span class="p">]);</span>
<a id="__codelineno-49-119" name="__codelineno-49-119" href="#__codelineno-49-119"></a>
<a id="__codelineno-49-120" name="__codelineno-49-120" href="#__codelineno-49-120"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-121" name="__codelineno-49-121" href="#__codelineno-49-121"></a><span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-49-122" name="__codelineno-49-122" href="#__codelineno-49-122"></a><span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-49-123" name="__codelineno-49-123" href="#__codelineno-49-123"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<a id="__codelineno-49-124" name="__codelineno-49-124" href="#__codelineno-49-124"></a><span class="w">        </span><span class="nx">community</span><span class="o">:</span><span class="w"> </span><span class="kt">summary.rows</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
<a id="__codelineno-49-125" name="__codelineno-49-125" href="#__codelineno-49-125"></a><span class="w">        </span><span class="nx">concepts</span><span class="o">:</span><span class="w"> </span><span class="kt">concepts.rows</span><span class="p">,</span>
<a id="__codelineno-49-126" name="__codelineno-49-126" href="#__codelineno-49-126"></a><span class="w">        </span><span class="nx">internal_relationships</span><span class="o">:</span><span class="w"> </span><span class="kt">relationships.rows</span>
<a id="__codelineno-49-127" name="__codelineno-49-127" href="#__codelineno-49-127"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<a id="__codelineno-49-128" name="__codelineno-49-128" href="#__codelineno-49-128"></a><span class="w">    </span><span class="p">}]</span>
<a id="__codelineno-49-129" name="__codelineno-49-129" href="#__codelineno-49-129"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-49-130" name="__codelineno-49-130" href="#__codelineno-49-130"></a><span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="138-visualization-updates-for-communities">13.8 Visualization Updates for Communities</h3>
<p><strong>Update 3D visualization to show communities:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1">// Graph3DViewer.tsx updates</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Graph3DViewer</span><span class="p">({</span><span class="w"> </span><span class="nx">sessionId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">Graph3DViewerProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">  </span><span class="c1">// ... existing code ...</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">getNodeColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kt">Node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">    </span><span class="c1">// Color by community</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">community_color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">community_color</span><span class="p">;</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">    </span><span class="c1">// Fallback to source count coloring</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">sources</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sourceCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;#ff6b6b&#39;</span><span class="p">;</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sourceCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;#ffd93d&#39;</span><span class="p">;</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;#6bcf7f&#39;</span><span class="p">;</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleCommunityFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">communityId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">    </span><span class="c1">// Filter graph to show only concepts in this community</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/graph/community/</span><span class="si">${</span><span class="nx">communityId</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setGraphData</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a>
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;graph-container&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;community-legend&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a><span class="w">        </span><span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Thematic</span><span class="w"> </span><span class="nx">Communities</span><span class="o">&lt;</span><span class="err">/h3&gt;</span>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a><span class="w">        </span><span class="p">{</span><span class="nx">communities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comm</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a><span class="w">          </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span>
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a><span class="w">            </span><span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">comm</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a><span class="w">            </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;community-item&quot;</span>
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a><span class="w">            </span><span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">handleCommunityFilter</span><span class="p">(</span><span class="nx">comm</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a><span class="w">          </span><span class="o">&gt;</span>
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">span</span><span class="w"> </span>
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a><span class="w">              </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;color-box&quot;</span><span class="w"> </span>
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a><span class="w">              </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="kt">comm.color</span><span class="w"> </span><span class="p">}}</span>
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a><span class="w">            </span><span class="o">/&gt;</span>
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">span</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">comm</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/span&gt;</span>
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="o">&gt;</span><span class="p">({</span><span class="nx">comm</span><span class="p">.</span><span class="nx">concept_count</span><span class="p">})</span><span class="o">&lt;</span><span class="err">/span&gt;</span>
<a id="__codelineno-50-41" name="__codelineno-50-41" href="#__codelineno-50-41"></a><span class="w">          </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-50-42" name="__codelineno-50-42" href="#__codelineno-50-42"></a><span class="w">        </span><span class="p">))}</span>
<a id="__codelineno-50-43" name="__codelineno-50-43" href="#__codelineno-50-43"></a><span class="w">      </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-50-44" name="__codelineno-50-44" href="#__codelineno-50-44"></a>
<a id="__codelineno-50-45" name="__codelineno-50-45" href="#__codelineno-50-45"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">ForceGraph3D</span>
<a id="__codelineno-50-46" name="__codelineno-50-46" href="#__codelineno-50-46"></a><span class="w">        </span><span class="c1">// ... existing props ...</span>
<a id="__codelineno-50-47" name="__codelineno-50-47" href="#__codelineno-50-47"></a>
<a id="__codelineno-50-48" name="__codelineno-50-48" href="#__codelineno-50-48"></a><span class="w">        </span><span class="nx">nodeColor</span><span class="o">=</span><span class="p">{</span><span class="nx">getNodeColor</span><span class="p">}</span>
<a id="__codelineno-50-49" name="__codelineno-50-49" href="#__codelineno-50-49"></a>
<a id="__codelineno-50-50" name="__codelineno-50-50" href="#__codelineno-50-50"></a><span class="w">        </span><span class="c1">// Community-based forces</span>
<a id="__codelineno-50-51" name="__codelineno-50-51" href="#__codelineno-50-51"></a><span class="w">        </span><span class="nx">d3Force</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span>
<a id="__codelineno-50-52" name="__codelineno-50-52" href="#__codelineno-50-52"></a><span class="w">        </span><span class="nx">d3AlphaDecay</span><span class="o">=</span><span class="p">{</span><span class="mf">0.02</span><span class="p">}</span>
<a id="__codelineno-50-53" name="__codelineno-50-53" href="#__codelineno-50-53"></a><span class="w">        </span><span class="nx">d3VelocityDecay</span><span class="o">=</span><span class="p">{</span><span class="mf">0.3</span><span class="p">}</span>
<a id="__codelineno-50-54" name="__codelineno-50-54" href="#__codelineno-50-54"></a><span class="w">      </span><span class="o">/&gt;</span>
<a id="__codelineno-50-55" name="__codelineno-50-55" href="#__codelineno-50-55"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-50-56" name="__codelineno-50-56" href="#__codelineno-50-56"></a><span class="w">  </span><span class="p">);</span>
<a id="__codelineno-50-57" name="__codelineno-50-57" href="#__codelineno-50-57"></a><span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="139-usage-examples-with-graphrag-features">13.9 Usage Examples with GraphRAG Features</h3>
<p><strong>Example 1: Global Query</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>User: &quot;What are the main themes across all our client documents?&quot;
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>Claude uses: global_query({ query: &quot;main themes&quot;, level: 1 })
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>Response: 
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>&quot;I found 5 major thematic clusters:
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>1. Digital Transformation Challenges (23 concepts)
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>   - Legacy system migration, technical debt, organizational resistance
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>2. Change Management Strategies (18 concepts)  
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>   - Stakeholder engagement, training programs, communication plans
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>3. Cloud Infrastructure (15 concepts)
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>   - AWS migration, containerization, microservices architecture
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>4. Data Governance (12 concepts)
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>   - Privacy compliance, data quality, access controls
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>5. Innovation &amp; AI Adoption (10 concepts)
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>   - Machine learning pilots, AI ethics, ROI measurement
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>Would you like to explore any of these clusters in detail?&quot;
</code></pre></div>
<p><strong>Example 2: Community Exploration</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>User: &quot;Tell me more about the Digital Transformation cluster&quot;
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>Claude uses: explore_community({ community_id: 1, level: 0 })
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>Response:
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>&quot;The Digital Transformation Challenges cluster contains 23 interconnected concepts:
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>Top concepts by evidence:
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a> Legacy System Migration (8 instances across 3 documents)
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a> Technical Debt (6 instances)
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a> Organizational Resistance (5 instances)
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>Key relationships:
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a> Legacy Systems  Technical Debt (implies)
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a> Technical Debt  Migration Complexity (supports)
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a> Migration Complexity  Organizational Resistance (implies)
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>This cluster appears in:
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>- ACME Corp Assessment (12 concepts)
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>- TechCo Roadmap (8 concepts)
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>- Finance Inc Analysis (3 concepts)
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a>
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a>The evidence shows organizations struggle with interconnected technical and human challenges when modernizing systems.
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>Would you like to see specific quotes, or visualize this cluster in 3D?&quot;
</code></pre></div>
<hr />
<h3 id="1310-performance-considerations">13.10 Performance Considerations</h3>
<p><strong>Community detection can be expensive. Optimize:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># Run community detection asynchronously after indexing</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">schedule_community_detection</span><span class="p">(</span><span class="n">db_connection</span><span class="p">):</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="sd">    Run community detection as a background task</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>    <span class="c1"># Check if graph has changed significantly since last run</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>    <span class="n">last_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="s2">        SELECT MAX(created_at) FROM community_summaries</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>    <span class="n">new_concepts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="s2">        SELECT COUNT(*) FROM concepts</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="s2">        WHERE created_at &gt; $1</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">last_run</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>    <span class="c1"># Only re-run if &gt;10% new concepts</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>    <span class="n">total_concepts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM concepts&quot;</span><span class="p">)</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>    <span class="k">if</span> <span class="n">new_concepts</span> <span class="o">/</span> <span class="n">total_concepts</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Significant changes detected, re-running community detection...&quot;</span><span class="p">)</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>        <span class="k">await</span> <span class="n">detect_communities</span><span class="p">(</span><span class="n">db_connection</span><span class="p">)</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>        <span class="k">await</span> <span class="n">summarize_all_levels</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No significant changes, skipping community detection&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Caching strategy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1"># Cache community summaries for fast retrieval</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">redis</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_community_summary_cached</span><span class="p">(</span><span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">community_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;community:</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">community_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>    <span class="c1"># Try cache first</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>    <span class="n">cached</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>    <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>    <span class="c1"># Query database</span>
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchrow</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="s2">        SELECT * FROM community_summaries</span>
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="s2">        WHERE level = $1 AND community_id = $2</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">community_id</span><span class="p">)</span>
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a>    <span class="c1"># Cache for 1 hour</span>
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>    <span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">summary</span><span class="p">)))</span>
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a>
<a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>    <span class="k">return</span> <span class="n">summary</span>
</code></pre></div>
<hr />
<h3 id="1311-summary-what-were-borrowing">13.11 Summary: What We're Borrowing</h3>
<p><strong>From GraphRAG (Algorithms &amp; Patterns):</strong>
 Leiden community detection algorithm<br />
 Hierarchical summarization approach<br />
 Global vs. Local query strategy<br />
 Enhanced entity extraction prompts<br />
 Multi-level reasoning patterns  </p>
<p><strong>Keeping from Our Design (Architecture):</strong>
 Real graph database (PostgreSQL + Apache AGE)<br />
 MCP server for Claude Desktop<br />
 3D visualization interface<br />
 Direct provenance tracking<br />
 Multi-client isolation<br />
 Consulting-specific workflows  </p>
<p><strong>Result:</strong> Best of both worlds - GraphRAG's intelligence with our infrastructure.</p>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>This specification provides a complete architecture for building a knowledge graph system that:</p>
<ol>
<li><strong>Extracts concepts</strong> from documents using LLM analysis</li>
<li><strong>Maintains provenance</strong> with full source tracking</li>
<li><strong>Enables discovery</strong> through semantic search</li>
<li><strong>Supports exploration</strong> via conversational AI (Claude Desktop/MCP)</li>
<li><strong>Visualizes structure</strong> in interactive 3D</li>
</ol>
<p>The system is designed to help consulting practitioners move beyond linear document scanning to explore conceptual relationships across their entire knowledge base - precisely the kind of non-linear thinking Watts advocates for.</p>
<p><strong>Next Steps:</strong>
1. Set up development environment (PostgreSQL + pgvector)
2. Implement document ingestion pipeline
3. Build MCP server with core tools
4. Test with Watts documents
5. Develop 3D visualization
6. Expand to production use cases</p>
<hr />
<p><strong>Document Version:</strong> 1.0<br />
<strong>Last Updated:</strong> October 4, 2025<br />
<strong>Maintained By:</strong> Architecture Team</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>