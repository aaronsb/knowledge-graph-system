# ============================================================================
# Development Overrides for Hot Reload
# ============================================================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
# Or use: ./operator/lib/start-app.sh --dev
# ============================================================================

services:
  postgres:
    # Dev mode: use stock apache/age, volume-mount extension artifacts from host build.
    # Build with: ./graph-accel/build-in-container.sh
    # If dist/ files don't exist, postgres starts fine â€” extension is optional.
    image: apache/age
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../schema/00_baseline.sql:/docker-entrypoint-initdb.d/10-baseline.sql
      - ../schema/11_graph_accel.sql:/docker-entrypoint-initdb.d/11-graph-accel.sql
      - postgres_import:/import
      # graph_accel: mount build artifacts for install via deploy-option0.sh.
      # Build with: ./graph-accel/build-in-container.sh
      # Install with: ./graph-accel/tests/deploy-option0.sh --skip-build
      # (deploy-option0.sh docker-cp's from dist/ into the running container)
    networks:
      - kg-network

  operator:
    # Operator already has full workspace mounted (..:/workspace)
    # Ensure scripts and configs are live-mounted for development
    volumes:
      # Docker socket access (already in base)
      - /var/run/docker.sock:/var/run/docker.sock
      # Full workspace mount for live script edits
      - ..:/workspace
    environment:
      # Enable debug logging for development
      LOG_LEVEL: DEBUG
    networks:
      - kg-network

  api:
    # Override standalone container_name back to dev name
    container_name: kg-api-dev
    # Enable hot reload for development
    command: ["uvicorn", "api.app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    build:
      context: ..
      dockerfile: api/Dockerfile
    volumes:
      # Mount source for hot reload
      - ../api:/app/api
      - ../schema:/app/schema
      # Mount tests for in-container testing
      - ../tests:/app/tests
      - ../pytest.ini:/app/pytest.ini
      - ../scripts:/app/scripts
      # Persistent HuggingFace model cache (must repeat from base when overriding volumes)
      - hf_cache:/home/api/.cache
    environment:
      # Enable debug logging for development
      LOG_LEVEL: DEBUG
    # Use public DNS servers to prevent DNS failures when switching WiFi networks
    # Must repeat from base when overriding service
    dns:
      - 8.8.8.8      # Google DNS
      - 1.1.1.1      # Cloudflare DNS
    networks:
      - kg-network

  web:
    # Override web service to use Vite dev server instead of nginx
    build:
      context: ../web
      dockerfile: Dockerfile.dev
    image: kg-web:dev
    container_name: kg-web-dev
    ports: !override
      - "0.0.0.0:3000:5173"  # Vite dev server (IPv4 only - replaces base port)
    volumes:
      # Mount source for hot reload
      - ../web/src:/app/src
      - ../web/public:/app/public
      - ../web/index.html:/app/index.html
      - ../web/vite.config.ts:/app/vite.config.ts
      - ../web/tailwind.config.js:/app/tailwind.config.js
      - ../web/tsconfig.json:/app/tsconfig.json
      - ../web/tsconfig.node.json:/app/tsconfig.node.json
      # Preserve node_modules from image (don't mount from host)
      - /app/node_modules
    environment:
      # Vite env vars (runtime config)
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
      VITE_OAUTH_CLIENT_ID: ${VITE_OAUTH_CLIENT_ID:-kg-web}
      VITE_OAUTH_REDIRECT_URI: ${VITE_OAUTH_REDIRECT_URI:-http://localhost:3000/callback}
      VITE_APP_NAME: ${VITE_APP_NAME:-Knowledge Graph}
    depends_on:
      api:
        condition: service_healthy
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    healthcheck:
      # Vite dev server health check
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:5173/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - kg-network

# No network definition needed - inherits from docker-compose.yml
